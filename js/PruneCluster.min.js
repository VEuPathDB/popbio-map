var __extends=this.__extends||function(f,a){for(var e in a){if(a.hasOwnProperty(e)){f[e]=a[e]}}function c(){this.constructor=f}c.prototype=a.prototype;f.prototype=new c()};var PruneCluster;(function(j){var b=0.2;var e=(function(){function l(){}return l})();j.Point=e;var a=(function(){function l(){}return l})();j.ClusterObject=a;var i=1;var h=Math.pow(2,53)-1;var f=(function(m){__extends(l,m);function l(s,o,r,p,q,n){if(r===void 0){r={}}if(q===void 0){q=1}if(n===void 0){n=false}m.call(this);this.data=r;this.position={lat:+s,lng:+o};this.weight=q;this.category=p;this.filtered=n;this.hashCode=i++}l.prototype.Move=function(o,n){this.position.lat=+o;this.position.lng=+n};l.prototype.SetData=function(o){for(var n in o){this.data[n]=o[n]}};return l})(a);j.Marker=f;var d=(function(l){__extends(m,l);function m(n){l.call(this);this.stats=[];this.data={};if(!n){this.hashCode=1;if(m.ENABLE_MARKERS_LIST){this._clusterMarkers=[]}return}if(m.ENABLE_MARKERS_LIST){this._clusterMarkers=[n]}this.lastMarker=n;this.hashCode=31+n.hashCode;this.population=1;if(n.category!==undefined){this.stats[n.category]=1}this.totalWeight=n.weight;this.position={lat:n.position.lat,lng:n.position.lng};this.averagePosition={lat:n.position.lat,lng:n.position.lng}}m.prototype.AddMarker=function(n){if(m.ENABLE_MARKERS_LIST){this._clusterMarkers.push(n)}var p=this.hashCode;p=((p<<5)-p)+n.hashCode;if(p>=h){this.hashCode=p%h}else{this.hashCode=p}this.lastMarker=n;var q=n.weight,o=this.totalWeight,r=q+o;this.averagePosition.lat=(this.averagePosition.lat*o+n.position.lat*q)/r;this.averagePosition.lng=(this.averagePosition.lng*o+n.position.lng*q)/r;++this.population;this.totalWeight=r;if(n.category!==undefined){this.stats[n.category]=(this.stats[n.category]+1)||1}};m.prototype.Reset=function(){this.hashCode=1;this.lastMarker=undefined;this.population=0;this.totalWeight=0;this.stats=[];if(m.ENABLE_MARKERS_LIST){this._clusterMarkers=[]}};m.prototype.ComputeBounds=function(s){var n=s.Project(this.position.lat,this.position.lng);var v=s.Size;var u=Math.floor(n.x/v),t=Math.floor(n.y/v),p=u*v,o=t*v;var r=s.UnProject(p,o),q=s.UnProject(p+v,o+v);this.bounds={minLat:q.lat,maxLat:r.lat,minLng:r.lng,maxLng:q.lng}};m.prototype.GetClusterMarkers=function(){return this._clusterMarkers};m.prototype.ApplyCluster=function(p){this.hashCode=this.hashCode*41+p.hashCode*43;if(this.hashCode>h){this.hashCode=this.hashCode=h}var q=p.totalWeight,n=this.totalWeight,r=q+n;this.averagePosition.lat=(this.averagePosition.lat*n+p.averagePosition.lat*q)/r;this.averagePosition.lng=(this.averagePosition.lng*n+p.averagePosition.lng*q)/r;this.population+=p.population;this.totalWeight=r;this.bounds.minLat=Math.min(this.bounds.minLat,p.bounds.minLat);this.bounds.minLng=Math.min(this.bounds.minLng,p.bounds.minLng);this.bounds.maxLat=Math.max(this.bounds.maxLat,p.bounds.maxLat);this.bounds.maxLng=Math.max(this.bounds.maxLng,p.bounds.maxLng);for(var o in p.stats){if(p.stats.hasOwnProperty(o)){if(this.stats.hasOwnProperty(o)){this.stats[o]+=p.stats[o]}else{this.stats[o]=p.stats[o]}}}if(m.ENABLE_MARKERS_LIST){this._clusterMarkers=this._clusterMarkers.concat(p.GetClusterMarkers())}};m.ENABLE_MARKERS_LIST=false;return m})(a);j.Cluster=d;function c(m,l){return(m.lat>=l.minLat&&m.lat<=l.maxLat)&&m.lng>=l.minLng&&m.lng<=l.maxLng}function g(q){for(var n=1,l,m,o,p=q.length;n<p;++n){m=q[n];o=m.position.lng;for(l=n-1;l>=0&&q[l].position.lng>o;--l){q[l+1]=q[l]}q[l+1]=m}}var k=(function(){function l(){this._markers=[];this._nbChanges=0;this._clusters=[];this.Size=166;this.ViewPadding=0.2}l.prototype.RegisterMarker=function(m){if(m._removeFlag){delete m._removeFlag}this._markers.push(m);this._nbChanges+=1};l.prototype.RegisterMarkers=function(m){var n=this;m.forEach(function(o){n.RegisterMarker(o)})};l.prototype._sortMarkers=function(){var n=this._markers,m=n.length;if(this._nbChanges&&(!m||this._nbChanges/m>b)){this._markers.sort(function(p,o){return p.position.lng-o.position.lng})}else{g(n)}this._nbChanges=0};l.prototype._sortClusters=function(){g(this._clusters)};l.prototype._indexLowerBoundLng=function(m){var r=this._markers,n,p,q=0,o=r.length;while(o>0){p=Math.floor(o/2);n=q+p;if(r[n].position.lng<m){q=++n;o-=p+1}else{o=p}}return q};l.prototype._resetClusterViews=function(){for(var o=0,n=this._clusters.length;o<n;++o){var m=this._clusters[o];m.Reset();m.ComputeBounds(this)}};l.prototype.ProcessView=function(m){var n=Math.abs(m.maxLat-m.minLat)*this.ViewPadding,q=Math.abs(m.maxLng-m.minLng)*this.ViewPadding;var C={minLat:m.minLat-n-n,maxLat:m.maxLat+n+n,minLng:m.minLng-q-q,maxLng:m.maxLng+q+q};this._sortMarkers();this._resetClusterViews();var o=this._indexLowerBoundLng(C.minLng);var s=this._markers,y=this._clusters;var A=y.slice(0);for(var v=o,p=s.length;v<p;++v){var u=s[v],t=u.position;if(t.lng>C.maxLng){break}if(t.lat>C.minLat&&t.lat<C.maxLat&&!u.filtered){var B=false,z;for(var r=0,x=A.length;r<x;++r){z=A[r];if(z.bounds.maxLng<u.position.lng){A.splice(r,1);--r;--x;continue}if(c(t,z.bounds)){z.AddMarker(u);B=true;break}}if(!B){z=new d(u);z.ComputeBounds(this);y.push(z);A.push(z)}}}var w=[];for(v=0,p=y.length;v<p;++v){z=y[v];if(z.population>0){w.push(z)}}this._clusters=w;this._sortClusters();return this._clusters};l.prototype.RemoveMarkers=function(p){if(!p){this._markers=[];return}for(var o=0,m=p.length;o<m;++o){p[o]._removeFlag=true}var n=[];for(o=0,m=this._markers.length;o<m;++o){if(!this._markers[o]._removeFlag){n.push(this._markers[o])}}this._markers=n};l.prototype.FindMarkersInArea=function(n){var o=n.minLat,r=n.maxLat,p=n.minLng,s=n.maxLng,t=this._markers,w=[];var m=this._indexLowerBoundLng(p);for(var u=m,q=t.length;u<q;++u){var v=t[u].position;if(v.lng>s){break}if(v.lat>=o&&v.lat<=r&&v.lng>=p){w.push(t[u])}}return w};l.prototype.ComputeBounds=function(s){if(!s||!s.length){return null}var o=Number.MAX_VALUE,m=-Number.MAX_VALUE,r=Number.MAX_VALUE,q=-Number.MAX_VALUE;for(var p=0,n=s.length;p<n;++p){var t=s[p].position;if(t.lat<o){o=t.lat}if(t.lat>m){m=t.lat}if(t.lng<r){r=t.lng}if(t.lng>q){q=t.lng}}return{minLat:o,maxLat:m,minLng:r,maxLng:q}};l.prototype.FindMarkersBoundsInArea=function(m){return this.ComputeBounds(this.FindMarkersInArea(m))};l.prototype.ComputeGlobalBounds=function(){return this.ComputeBounds(this._markers)};l.prototype.GetMarkers=function(){return this._markers};l.prototype.GetPopulation=function(){return this._markers.length};l.prototype.ResetClusters=function(){this._clusters=[]};return l})();j.PruneCluster=k})(PruneCluster||(PruneCluster={}));var PruneCluster;(function(a){})(PruneCluster||(PruneCluster={}));var PruneClusterForLeaflet=(L.Layer?L.Layer:L.Class).extend({initialize:function(b,a){var c=this;if(b===void 0){b=120}if(a===void 0){a=20}this.Cluster=new PruneCluster.PruneCluster();this.Cluster.Size=b;this.clusterMargin=Math.min(a,b/4);this.Cluster.Project=function(e,d){return c._map.project(new L.LatLng(e,d))};this.Cluster.UnProject=function(d,e){return c._map.unproject(new L.Point(d,e))};this._objectsOnMap=[];this.spiderfier=new PruneClusterLeafletSpiderfier(this);this._hardMove=false;this._resetIcons=false;this._removeTimeoutId=0;this._markersRemoveListTimeout=[]},RegisterMarker:function(a){this.Cluster.RegisterMarker(a)},RegisterMarkers:function(a){this.Cluster.RegisterMarkers(a)},RemoveMarkers:function(a){this.Cluster.RemoveMarkers(a)},BuildLeafletCluster:function(c,b){var d=this;var a=new L.Marker(b,{icon:this.BuildLeafletClusterIcon(c)});a.on("click",function(){var h=d.Cluster.FindMarkersInArea(c.bounds);var f=d.Cluster.ComputeBounds(h);if(f){var i=new L.LatLngBounds(new L.LatLng(f.minLat,f.maxLng),new L.LatLng(f.maxLat,f.minLng));var e=d._map.getZoom(),g=d._map.getBoundsZoom(i,false,new L.Point(20,20));if(g===e){d._map.fire("overlappingmarkers",{cluster:d,markers:h,center:a.getLatLng(),marker:a});d._map.setView(b,g)}else{d._map.fitBounds(i)}}});return a},BuildLeafletClusterIcon:function(b){var e="prunecluster prunecluster-";var a=40;var d=this.Cluster.GetPopulation();if(b.population<Math.max(10,d*0.01)){e+="small"}else{if(b.population<Math.max(100,d*0.05)){e+="medium";a=40}else{e+="large";a=40}}return new L.DivIcon({html:"<div><span>"+b.population+"</span></div>",className:e,iconSize:L.point(a,a)})},BuildLeafletMarker:function(c,b){var a=new L.Marker(b);this.PrepareLeafletMarker(a,c.data,c.category);return a},PrepareLeafletMarker:function(a,d,c){if(d.icon){if(typeof d.icon==="function"){a.setIcon(d.icon(d,c))}else{a.setIcon(d.icon)}}if(d.popup){var b=typeof d.popup==="function"?d.popup(d,c):d.popup;if(a.getPopup()){a.setPopupContent(b,d.popupOptions)}else{a.bindPopup(b,d.popupOptions)}}},onAdd:function(a){this._map=a;a.on("movestart",this._moveStart,this);a.on("moveend",this._moveEnd,this);a.on("zoomend",this._zoomStart,this);a.on("zoomend",this._zoomEnd,this);this.ProcessView();a.addLayer(this.spiderfier)},onRemove:function(c){c.off("movestart",this._moveStart,this);c.off("moveend",this._moveEnd,this);c.off("zoomend",this._zoomStart,this);c.off("zoomend",this._zoomEnd,this);for(var b=0,a=this._objectsOnMap.length;b<a;++b){c.removeLayer(this._objectsOnMap[b].data._leafletMarker)}this._objectsOnMap=[];this.Cluster.ResetClusters();c.removeLayer(this.spiderfier);this._map=null},_moveStart:function(){this._moveInProgress=true},_moveEnd:function(a){this._moveInProgress=false;this._hardMove=a.hard;this.ProcessView()},_zoomStart:function(){this._zoomInProgress=true},_zoomEnd:function(){this._zoomInProgress=false;this.ProcessView()},ProcessView:function(){var b=this;if(!this._map||this._zoomInProgress||this._moveInProgress){return}var v=this._map,A=v.getBounds(),M=v.getZoom(),Q=this.clusterMargin/this.Cluster.Size,t=this._resetIcons;var C=A.getSouthWest(),y=A.getNorthEast();var o=this.Cluster.ProcessView({minLat:C.lat,minLng:C.lng,maxLat:y.lat,maxLng:y.lng});var I=this._objectsOnMap,T=[],D=new Array(I.length);for(var P=0,K=I.length;P<K;++P){var U=I[P].data._leafletMarker;D[P]=U;U._removeFromMap=true}var E=[];var x=[];var e=[];for(P=0,K=o.length;P<K;++P){var H=o[P],a=H.data;var s=(H.bounds.maxLat-H.bounds.minLat)*Q,u=(H.bounds.maxLng-H.bounds.minLng)*Q;for(var N=0,z=e.length;N<z;++N){var S=e[N];if(S.bounds.maxLng<H.bounds.minLng){e.splice(N,1);--N;--z;continue}var B=S.averagePosition.lng+u,q=S.averagePosition.lat-s,G=S.averagePosition.lat+s,n=H.averagePosition.lng-u,w=H.averagePosition.lat-s,J=H.averagePosition.lat+s;if(B>n&&G>w&&q<J){a._leafletCollision=true;S.ApplyCluster(H);break}}if(!a._leafletCollision){e.push(H)}}o.forEach(function(l){var j=undefined;var V=l.data;if(V._leafletCollision){V._leafletCollision=false;V._leafletOldPopulation=0;V._leafletOldHashCode=0;return}var i=new L.LatLng(l.averagePosition.lat,l.averagePosition.lng);var c=V._leafletMarker;if(c){if(l.population===1&&V._leafletOldPopulation===1&&l.hashCode===c._hashCode){if(t||c._zoomLevel!==M||l.lastMarker.data.forceIconRedraw){b.PrepareLeafletMarker(c,l.lastMarker.data,l.lastMarker.category);if(l.lastMarker.data.forceIconRedraw){l.lastMarker.data.forceIconRedraw=false}}c.setLatLng(i);j=c}else{if(l.population>1&&V._leafletOldPopulation>1&&(c._zoomLevel===M||V._leafletPosition.equals(i))){c.setLatLng(i);if(t||l.population!=V._leafletOldPopulation||l.hashCode!==V._leafletOldHashCode){c.setIcon(b.BuildLeafletClusterIcon(l))}V._leafletOldPopulation=l.population;V._leafletOldHashCode=l.hashCode;j=c}}}if(!j){E.push(l);V._leafletPosition=i;V._leafletOldPopulation=l.population;V._leafletOldHashCode=l.hashCode}else{j._removeFromMap=false;T.push(l);j._zoomLevel=M;j._hashCode=l.hashCode;j._population=l.population;V._leafletMarker=j;V._leafletPosition=i}});for(P=0,K=I.length;P<K;++P){H=I[P];var f=H.data;U=f._leafletMarker;if(f._leafletMarker._removeFromMap){var r=true;if(U._zoomLevel===M){var m=H.averagePosition;s=(H.bounds.maxLat-H.bounds.minLat)*Q,u=(H.bounds.maxLng-H.bounds.minLng)*Q;for(N=0,z=E.length;N<z;++N){var O=E[N],R=O.data;var k=O.averagePosition;var h=m.lng-u,F=k.lng+u;B=m.lng+u;q=m.lat-s;G=m.lat+s;n=k.lng-u;w=k.lat-s;J=k.lat+s;if(B>n&&h<F&&G>w&&q<J){if(U._population===1&&O.population===1&&U._hashCode===O.hashCode){if(t||O.lastMarker.data.forceIconRedraw){this.PrepareLeafletMarker(U,O.lastMarker.data,O.lastMarker.category);if(O.lastMarker.data.forceIconRedraw){O.lastMarker.data.forceIconRedraw=false}}U.setLatLng(R._leafletPosition);r=false}else{if(U._population>1&&O.population>1){U.setLatLng(R._leafletPosition);U.setIcon(this.BuildLeafletClusterIcon(O));R._leafletOldPopulation=O.population;R._leafletOldHashCode=O.hashCode;U._population=O.population;r=false}}if(!r){R._leafletMarker=U;U._removeFromMap=false;T.push(O);E.splice(N,1);--N;--z;break}}}}if(r){if(!U._removeFromMap){console.error("wtf")}}}}for(P=0,K=E.length;P<K;++P){H=E[P],f=H.data;var p=f._leafletPosition;var d;if(H.population===1){d=this.BuildLeafletMarker(H.lastMarker,p)}else{d=this.BuildLeafletCluster(H,p)}d.addTo(v);d.setOpacity(0);x.push(d);f._leafletMarker=d;d._zoomLevel=M;d._hashCode=H.hashCode;d._population=H.population;T.push(H)}window.setTimeout(function(){for(P=0,K=x.length;P<K;++P){var c=x[P];if(c._icon){L.DomUtil.addClass(c._icon,"marker-cluster-anim")}if(c._shadow){L.DomUtil.addClass(c._shadow,"marker-cluster-anim")}c.setOpacity(1)}},1);if(this._hardMove){for(P=0,K=D.length;P<K;++P){U=D[P];if(U._removeFromMap){v.removeLayer(U)}}}else{if(this._removeTimeoutId!==0){window.clearTimeout(this._removeTimeoutId);for(P=0,K=this._markersRemoveListTimeout.length;P<K;++P){v.removeLayer(this._markersRemoveListTimeout[P])}}var g=[];for(P=0,K=D.length;P<K;++P){U=D[P];if(U._removeFromMap){U.setOpacity(0);g.push(U)}}if(g.length>0){this._removeTimeoutId=window.setTimeout(function(){for(P=0,K=g.length;P<K;++P){v.removeLayer(g[P])}b._removeTimeoutId=0},300)}this._markersRemoveListTimeout=g}this._objectsOnMap=T;this._hardMove=false;this._resetIcons=false},FitBounds:function(){var a=this.Cluster.ComputeGlobalBounds();if(a){this._map.fitBounds(new L.LatLngBounds(new L.LatLng(a.minLat,a.maxLng),new L.LatLng(a.maxLat,a.minLng)))}},GetMarkers:function(){return this.Cluster.GetMarkers()},RedrawIcons:function(a){if(a===void 0){a=true}this._resetIcons=true;if(a){this.ProcessView()}}});var PruneClusterLeafletSpiderfier=(L.Layer?L.Layer:L.Class).extend({_2PI:Math.PI*2,_circleFootSeparation:25,_circleStartAngle:Math.PI/6,_spiralFootSeparation:28,_spiralLengthStart:11,_spiralLengthFactor:5,_spiralCountTrigger:8,spiderfyDistanceMultiplier:1,initialize:function(a){this._cluster=a;this._currentMarkers=[];this._multiLines=!!L.multiPolyline;this._lines=this._multiLines?L.multiPolyline([],{weight:1.5,color:"#222"}):L.polyline([],{weight:1.5,color:"#222"})},onAdd:function(a){this._map=a;this._map.on("overlappingmarkers",this.Spiderfy,this);this._map.on("click",this.Unspiderfy,this);this._map.on("zoomend",this.Unspiderfy,this)},Spiderfy:function(f){var g=this;if(f.cluster!==this._cluster){return}this.Unspiderfy();var d=f.markers.filter(function(i){return !i.filtered});this._currentCenter=f.center;var h=this._map.latLngToLayerPoint(f.center);var n;if(d.length>=this._spiralCountTrigger){n=this._generatePointsSpiral(d.length,h)}else{if(this._multiLines){h.y+=10}n=this._generatePointsCircle(d.length,h)}var c=[];var o=[];var k=[];for(var e=0,b=n.length;e<b;++e){var j=this._map.layerPointToLatLng(n[e]);var a=this._cluster.BuildLeafletMarker(d[e],f.center);a.setZIndexOffset(5000);a.setOpacity(0);this._currentMarkers.push(a);this._map.addLayer(a);o.push(a);k.push(j)}window.setTimeout(function(){for(e=0,b=n.length;e<b;++e){o[e].setLatLng(k[e]).setOpacity(1)}var l=+new Date();var i=42,p=290;var m=window.setInterval(function(){c=[];var s=+new Date();var w=s-l;if(w>=p){window.clearInterval(m);v=1}else{var v=w/p}var r=f.center;for(e=0,b=n.length;e<b;++e){var u=k[e],t=u.lat-r.lat,q=u.lng-r.lng;c.push([r,new L.LatLng(r.lat+t*v,r.lng+q*v)])}g._lines.setLatLngs(c)},i)},1);this._lines.setLatLngs(c);this._map.addLayer(this._lines);if(f.marker){this._clusterMarker=f.marker.setOpacity(0.3)}},_generatePointsCircle:function(e,h){var a=this.spiderfyDistanceMultiplier*this._circleFootSeparation*(2+e),f=a/this._2PI,d=this._2PI/e,c=[],b,g;c.length=e;for(b=e-1;b>=0;b--){g=this._circleStartAngle+b*d;c[b]=new L.Point(Math.round(h.x+f*Math.cos(g)),Math.round(h.y+f*Math.sin(g)))}return c},_generatePointsSpiral:function(d,h){var e=this.spiderfyDistanceMultiplier*this._spiralLengthStart,c=this.spiderfyDistanceMultiplier*this._spiralFootSeparation,f=this.spiderfyDistanceMultiplier*this._spiralLengthFactor,g=0,b=[],a;b.length=d;for(a=d-1;a>=0;a--){g+=c/e+a*0.0005;b[a]=new L.Point(Math.round(h.x+e*Math.cos(g)),Math.round(h.y+e*Math.sin(g)));e+=this._2PI*f/g}return b},Unspiderfy:function(){var d=this;for(var b=0,a=this._currentMarkers.length;b<a;++b){this._currentMarkers[b].setLatLng(this._currentCenter).setOpacity(0)}var c=this._currentMarkers;window.setTimeout(function(){for(b=0,a=c.length;b<a;++b){d._map.removeLayer(c[b])}},300);this._currentMarkers=[];this._map.removeLayer(this._lines);if(this._clusterMarker){this._clusterMarker.setOpacity(1)}},onRemove:function(a){this.Unspiderfy();a.off("overlappingmarkers",this.Spiderfy,this);a.off("click",this.Unspiderfy,this);a.off("zoomend",this.Unspiderfy,this)}});