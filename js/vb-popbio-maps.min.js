function loadSolr(e){var a=e.clear;var f=e.zoomLevel;var g=geohashLevel(f,"geohash");if(f>11){loadSmall(1,f);return}var d=[];var c=function(t){$("#markersCount").html(t.response.numFound+" samples in current view");if(t.response.numFound===0){if(a){assetLayerGroup.clearLayers()}map.spin(false);return}var p;var s;var r;switch(f){case 1:case 2:p=t.stats.stats_fields.geo_coords_ll_0___tdouble.facets.geohash_1;s=t.stats.stats_fields.geo_coords_ll_1___tdouble.facets.geohash_1;r=t.facet_counts.facet_pivot["geohash_1,species_category"];break;case 3:case 4:case 5:p=t.stats.stats_fields.geo_coords_ll_0___tdouble.facets.geohash_2;s=t.stats.stats_fields.geo_coords_ll_1___tdouble.facets.geohash_2;r=t.facet_counts.facet_pivot["geohash_2,species_category"];break;case 6:case 7:p=t.stats.stats_fields.geo_coords_ll_0___tdouble.facets.geohash_3;s=t.stats.stats_fields.geo_coords_ll_1___tdouble.facets.geohash_3;r=t.facet_counts.facet_pivot["geohash_3,species_category"];break;case 8:case 9:p=t.stats.stats_fields.geo_coords_ll_0___tdouble.facets.geohash_4;s=t.stats.stats_fields.geo_coords_ll_1___tdouble.facets.geohash_4;r=t.facet_counts.facet_pivot["geohash_4,species_category"];break;case 10:case 11:p=t.stats.stats_fields.geo_coords_ll_0___tdouble.facets.geohash_5;s=t.stats.stats_fields.geo_coords_ll_1___tdouble.facets.geohash_5;r=t.facet_counts.facet_pivot["geohash_5,species_category"];break;default:p=t.stats.stats_fields.geo_coords_ll_0___tdouble.facets.geohash_6;s=t.stats.stats_fields.geo_coords_ll_1___tdouble.facets.geohash_6;r=t.facet_counts.facet_pivot["geohash_6,species_category"];break}smallClusters=[];var i=[];var h=[];var o=[];r.forEach(function(y,w,z){i[y.value]=y.count;var v=[];var u=[];var x=1;y.pivot.forEach(function(B){var A=B.value,C=B.count;if(x<8){v[A]=C}else{v.others+=C}u.push({label:A.replace(/sensu lato/,"sl").replace(/chromosomal form/,"cf"),value:C,color:(palette[A]?palette[A]:"#000000")});++x});h[y.value]=v;o[y.value]=u});for(var n in p){if(p.hasOwnProperty(n)){var l=p[n].count;if(l<2){smallClusters.push(n);continue}if(f===3&&l<6){smallClusters.push(n);continue}if(f===4&&l<11){smallClusters.push(n);continue}if(f===5&&l<21){smallClusters.push(n);continue}if(f===6&&l<31){smallClusters.push(n);continue}if(f===7&&l<41){smallClusters.push(n);continue}if(f===8&&l<51){smallClusters.push(n);continue}if(f===9&&l<61){smallClusters.push(n);continue}if(f>9&&l<71){smallClusters.push(n);continue}var j={};j.term=n;j.count=p[n].count;j.latLng=[p[n].mean,s[n].mean];j.bounds=[[p[n].min,s[n].min],[p[n].max,s[n].max]];j.population=i[n];j.stats=h[n];j.fullstats=o[n];d.push(j)}}var m={};m.terms=d;var q={recordsField:"terms",latitudeField:"latLng.0",longitudeField:"latLng.1",displayOptions:{count:{title:function(u){return u}}},layerOptions:{fill:false,stroke:false,weight:0,color:"#80FF00",dropShadow:false},setIcon:function(u){var v=40;return new L.Icon.Canvas({iconSize:new L.Point(v,v),className:"prunecluster leaflet-markercluster-icon lamogio",population:u.population,stats:u.stats})},onEachRecord:function(v,u){v.on("dblclick",function(){map.fitBounds(u.bounds)});v.on("click",function(){updatePieChart(u.population,u.fullstats)});v.on("mouseout",function(){})}};var k=new L.MarkerDataLayer(m,q);if(a){assetLayerGroup.clearLayers();assetLayerGroup.addLayer(k)}else{assetLayerGroup.addLayer(k)}if(smallClusters.length>0){loadSmall(0,f)}map.spin(false)};var b="http://funcgen.vectorbase.org/popbio-map-preview/asolr/solr/vb_popbio/select?"+qryUrl+"&fq=bundle_name:Sample&fq=has_geodata:true&rows=0"+buildBbox(map.getBounds())+"&fl=geo_coords&stats=true&stats.field=geo_coords_ll_0___tdouble&stats.field=geo_coords_ll_1___tdouble&stats.facet="+g+"&facet=true&facet.limit=-1&facet.sort=count&facet.pivot.mincount=1&facet.pivot="+g+",species_category&wt=json&json.nl=map&json.wrf=?&callback=?";console.log(b);map.spin(true);$.getJSON(b,c).fail(function(){console.log("Ahhh");return})}function loadSmall(g,f){var e=new PruneClusterForLeaflet(100);e.BuildLeafletClusterIcon=function(i){var j=new L.Icon.MarkerCluster();j.stats=i.stats;j.population=i.population;return j};L.Icon.MarkerCluster=L.Icon.extend({options:{iconSize:new L.Point(40,40),className:"prunecluster leaflet-markercluster-icon"},createIcon:function(){var j=document.createElement("canvas");this._setIconStyles(j,"icon");var i=this.options.iconSize;j.width=i.x;j.height=i.y;this.draw(j.getContext("2d"),i.x,i.y);return j},createShadow:function(){return null},draw:function(m,k,w){var r=Math.PI*2,p=Math.PI*1.5;var j=p;var s=this.options.iconSize.x,o=s/2,n=s/2.5;var l=0;var q=8;for(var v in this.stats){if(this.stats.hasOwnProperty(v)){var x=this.stats[v]/this.population;if(x>0){m.beginPath();m.moveTo(o,o);if(palette.hasOwnProperty(v)){m.fillStyle=palette[v]}else{m.fillStyle=palette.others}var u=j+0.14,t=j+x*r;if(t<u){u=j}m.arc(o,o,o,u,t);j=j+x*r;m.lineTo(o,o);m.fill();m.closePath()}--q}}m.beginPath();m.fillStyle="white";m.arc(o,o,n,0,Math.PI*2);m.fill();m.closePath();m.fillStyle="#555";m.textAlign="center";m.textBaseline="middle";m.font="bold 12px sans-serif";m.fillText(this.population,o,o,s)}});e.BuildLeafletCluster=function(k,j){var i=new L.Marker(j,{icon:e.BuildLeafletClusterIcon(k)});i.on("dblclick",function(){var o=e.Cluster.FindMarkersInArea(k.bounds);var m=e.Cluster.ComputeBounds(o);if(m){var p=new L.LatLngBounds(new L.LatLng(m.minLat,m.maxLng),new L.LatLng(m.maxLat,m.minLng));var l=e._map.getZoom();var n=e._map.getBoundsZoom(p,false,new L.Point(20,20,null));if(n===l){e._map.fire("overlappingmarkers",{cluster:e,markers:o,center:i.getLatLng(),marker:i})}else{e._map.fitBounds(p)}}});i.on("click",function(){var l=new Array;var n=k.stats;for(var m in n){l.push({label:m.replace(/sensu lato/,"sl").replace(/chromosomal form/,"cf"),value:n[m],color:(palette[m]?palette[m]:"#000000")})}updatePieChart(k.population,l)});i.on("mouseover",function(l){});return i};var h=geohashLevel(f,"geohash");var d;if(g===0){d="(";for(var c=0;c<smallClusters.length;c++){if(c===smallClusters.length-1){d+=smallClusters[c];break}d+=smallClusters[c]+" OR "}d+=")"}else{d="*"}var b=function(i){var m=i.response.docs;for(var k in m){if(m.hasOwnProperty(k)){var l=m[k].geo_coords.split(",");var j=new PruneCluster.Marker(l[0],l[1]);if(m[k].hasOwnProperty("species_category")){j.category=m[k].species_category[0]}e.RegisterMarker(j)}}if(g){assetLayerGroup.clearLayers();$("#markersCount").html(i.response.numFound+" samples in current view")}assetLayerGroup.addLayer(e);map.spin(false)};var a="http://funcgen.vectorbase.org/popbio-map-preview/asolr/solr/vb_popbio/select?"+qryUrl+"&fq=bundle_name:Sample&fq=has_geodata:true&fq="+h+":"+d+"&rows=10000000"+buildBbox(map.getBounds())+"&fl=geo_coords,species_category&wt=json&json.nl=map&json.wrf=?&callback=?";map.spin(true);$.getJSON(a,b)}function buildBbox(d){var e;if(d.getEast()){var c=d.getSouth();if(c<-90){c=-90}var f=d.getNorth();if(f>90){f=90}var a=d.getWest();if(a<-180){a=-180}if(a>180){a=180}var b=d.getEast();if(b>180){b=180}if(b<-180){b=-180}e="&fq=geo_coords:["+c+","+a+" TO "+f+","+b+"]"}else{e="&fq=geo_coords:[-90,-180 TO 90, 180]"}return(e)}function geohashLevel(b,a){var c;if(a==="geohash"){switch(b){case 1:case 2:c="geohash_1";break;case 3:case 4:case 5:c="geohash_2";break;case 6:case 7:c="geohash_3";break;case 8:case 9:c="geohash_4";break;case 10:case 11:c="geohash_5";break;default:c="geohash_6";break}}else{}return(c)}function buildPalette(k,j,b){var f=[];var e=["#FFB300","#803E75","#FF6800","#A6BDD7","#C10020","#CEA262","#817066","#007D34","#F6768E","#00538A","#FF7A5C","#53377A","#FF8E00","#B32851","#F4C800","#7F180D","#93AA00","#593315","#F13A13","#232C16"];var p=["#575757","#A0A0A0","#FFFFFF","#2A4BD7","#1D6914","#814A19","#8126C0","#9DAFFF","#81C57A","#E9DEBB","#AD2323","#29D0D0","#FFEE33","#FF9233","#FFCDF3"];var d=k.length,n=d;for(var h=0;h<j;h++){var o=k[h][0];f[o]=e[h];d--}var m=0.5/d,a=0.7;for(var l=0;l<d;l++){var g=n-d+l;var o=k[g][0];f[o]=colorLuminance("#FFFFFF",-a);a-=m}f.others="radial-gradient("+colorLuminance("#FFFFFF",-0.7)+", "+colorLuminance("#FFFFFF",-a)+")";return f}function sortHashByValue(c){var b=[];for(var a in c){b.push([a,c[a]])}b.sort(function(e,d){return d[1]-e[1]});return b}function updatePieChart(b,c){if(c){var a=500;var d=$("#graphs").width();nv.addGraph(function(){var e=nv.models.pieChart().x(function(f){return f.label}).y(function(f){return f.value}).color(function(f){return f.data.color}).showLabels(true).labelThreshold(0.05).labelType("percent").donut(true).donutRatio(0.5).growOnHover(false);d3.select("#piechart").datum(c).transition().duration(800).attr("width",d).attr("height",a).call(e);nv.utils.windowResize(function(){e.update()});return e})}else{}}$.fn.redraw=function(){$(this).each(function(){var a=this.offsetHeight})};function colorLuminance(e,a){e=String(e).replace(/[^0-9a-f]/gi,"");if(e.length<6){e=e[0]+e[0]+e[1]+e[1]+e[2]+e[2]}a=a||0;var b="#",f,d;for(d=0;d<3;d++){f=parseInt(e.substr(d*2,2),16);f=Math.round(Math.min(Math.max(0,f+(f*a)),255)).toString(16);b+=("00"+f).substr(f.length)}return b}function filterMarkers(b){if(b.length===0){qryUrl="q=*";loadSolr({clear:1,zoomLevel:map.getZoom()});return}var g=new Object;b.forEach(function(i){if(g.hasOwnProperty(i.field)){if(i.qtype=="exact"){g[i.field].push('"'+i.value+'"')}else{g[i.field].push(i.value+"*");console.log("inexact")}}else{g[i.field]=[];if(i.qtype=="exact"){g[i.field].push('"'+i.value+'"')}else{g[i.field].push(i.value+"*");console.log("inexact")}}});var d=Object.keys(g).length;var c=0;for(var h in g){var a=g[h];var f="";var e=a.length;a.forEach(function(j,i){if(i<e-1){f+=j+" OR "}else{f+=j}});if(c===0){qryUrl="q=("}if(c<d-1){if(h==="anywhere"){qryUrl+="("+f+") OR "}else{qryUrl+=h+":("+f+") OR "}}else{if(h==="anywhere"){qryUrl+="("+f+"))"}else{qryUrl+=h+":("+f+"))"}}console.log("lakis"+qryUrl);c++}loadSolr({clear:1,zoomLevel:map.getZoom()})}function mapTypeToField(a){switch(a){case"Taxonomy":return"species_cvterms";case"Title":return"label";default:return a.toLowerCase()}}function mapTypeToIcon(a){switch(a){case"Taxonomy":return'<i class="fa fa-sitemap"></i>';case"Title":return'<i class="fa fa-info-circle"></i>';default:return'<i class="fa fa-camera-retro"></i>'}};