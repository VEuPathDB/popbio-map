/*! VectorBase Population Biology Map - v0.2.1 - 2017-12-09
* https://www.vectorbase.org/popbio/
* Copyright (c) 2017  */
function createBeeViolinPlot(a,b){"use strict";if("ir"!==$("#SelectView").val())return $("#swarm-plots h3").text("Population Biology Map Graph Area"),void $(a).html('<div style="text-align: center; margin-top: 30px"><i class="fa fa-area-chart" style="color: #C3312D; font-size: 12em"></i><h4>this plot type only works in the</h4><h4>Insecticide Resistance and Abundance views</h4><h4>switch to IR phenotypes or Abundance view and try again</h4></div>');$("#swarm-plots h3").text("Insecticide Resistance statistics for selected samples");var c=solrPopbioUrl+"irViolinStats?&"+qryUrl+b+"&json.wrf=?&callback=?";$("#swarm-chart-area").fadeOut(),$.getJSON(c).done(function(c){PaneSpin("swarm-plots","start"),c.facets.count&&c.facets.count>0&&setTimeout(function(){$(a).empty();var d=$("<label>").text("Phenotypes included in background: "),e=$("<select />").attr("id","bgPlotType").attr("class","form-control");$("<option/>",{text:"phenotypes matching search",value:1}).appendTo(e),$("<option/>",{text:"phenotypes visible on map (including the ones behind this panel)",value:2}).appendTo(e),$("<option/>",{text:"all phenotypes",value:3}).appendTo(e),d.appendTo($(a)),e.val(bgPlotType).appendTo($(a)),d=$("<label>").text("Measurement type: ");var f=$("<select />").attr("id","plotType").attr("class","form-control");c.facets.vtypes.buckets.forEach(function(a){a.vunits.buckets.forEach(function(b){var c=a.val+" ("+b.val+"): "+b.count+" phenotypes";$("<option/>",{text:c,value:a.val+"-"+b.val,data:{phenotype_value_type_s:a.val,phenotype_value_unit_s:b.val,count:b.count,min:b.pmin,max:b.pmax}}).appendTo(f)})}),d.appendTo($(a)),f.appendTo($(a)),"none"!==selectedPlotType&&$('#plotType option[value="'+selectedPlotType+'"]').length>0&&$("#plotType").val(selectedPlotType);var g=f.find(":selected").data();buildPlot(a,b,g),f.change(function(){PaneSpin("swarm-plots","start"),g=f.find(":selected").data(),$("#beeViolinPlot").fadeOut(),setTimeout(function(){buildPlot(a,b,g)},delay)}),e.change(function(){PaneSpin("swarm-plots","start"),g=f.find(":selected").data(),bgPlotType=e.find(":selected").val(),$("#beeViolinPlot").fadeOut(),setTimeout(function(){buildPlot(a,b,g)},delay)})},delay)}).fail(function(){PaneSpin("swarm-plots","stop"),console.log("Failed while loading irViolinStats")})}function addViolin(a,b,c,d,e,f,g,h){"use strict";var i,j=b.length-1,k=b[j].count,l=b[j].val,m=(e[1]-e[0])/f;b.push({val:l+m,count:k});var n=d3.scale.linear().range([d/2,0]).domain([0,Math.max(d3.max(b,function(a){return 1.5*a.count}))]),o=d3.select("#plotTooltip");i=h?d3.scale.log().range(c).domain(e).nice():d3.scale.linear().range(c).domain(e).nice();var p=(a.append("circle").attr("r",7).style("display","none").style("fill","#FFFFFF").style("pointer-events","none").style("stroke","#FB5050").style("stroke-width","3px"),d3.bisector(function(a){return a.val}).left),q=d3.svg.area().interpolate(g).x(function(a){return i(a.val)}).y0(d/2).y1(function(a){return n(a.count)}),r=d3.svg.line().interpolate(g).x(function(a){return i(a.val)}).y(function(a){return n(a.count)}),s=a.append("g"),t=a.append("g");s.append("path").datum(b).attr("class","area").attr("d",q).on("mouseover",function(){o.transition().duration(100).style("opacity",1)}).on("mouseout",function(a){o.transition().duration(500).style("opacity",0)}).on("mousemove",function(a){var b=d3.mouse(this),c=i.invert(b[0]),d=p(a,c),e=a.length-1;if(0===d)var f="Range: "+a[d].val.roundDecimals(4)+"-"+(a[d].val+m).roundDecimals(4),g=a[d].count;else if(d<e)var f="Range: "+a[d-1].val.roundDecimals(4)+"-"+(a[d-1].val+m).roundDecimals(4),g=a[d-1].count;else var f="Range: "+a[e-1].val.roundDecimals(4)+"-"+(a[e-1].val+m).roundDecimals(4),g=a[e-1].count;var h='<h3 style="background-color: #CCCCCC;"><span style="color: rgb(255, 255, 255); ">Count of phenotypes</span></h3><p>%BIN</p><p><b>%COUNT</b></p>'.replace("%BIN",f).replace("%COUNT",g);o.html(h).style("left",d3.event.pageX+5+"px").style("top",d3.event.pageY-28+"px")}),s.append("path").datum(b).attr("class","violin").attr("d",r),t.append("path").datum(b).attr("class","area").attr("d",q).on("mouseover",function(){o.transition().duration(100).style("opacity",1)}).on("mouseout",function(a){o.transition().duration(500).style("opacity",0)}).on("mousemove",function(a){var b=d3.mouse(this),c=i.invert(b[0]),d=p(a,c),e=a.length-1;if(0===d)var f="Range: "+a[d].val.roundDecimals(4)+"-"+(a[d].val+m).roundDecimals(4),g=a[d].count;else if(d<e)var f="Range: "+a[d-1].val.roundDecimals(4)+"-"+(a[d-1].val+m).roundDecimals(4),g=a[d-1].count;else var f="Range: "+a[e-1].val.roundDecimals(4)+"-"+(a[e-1].val+m).roundDecimals(4),g=a[e-1].count;var h='<h3 style="background-color: #CCCCCC;"><span style="color: rgb(255, 255, 255); ">Count of phenotypes</span></h3><p>%BIN</p><p><b>%COUNT</b></p>'.replace("%BIN",f).replace("%COUNT",g);o.html(h).style("left",d3.event.pageX+5+"px").style("top",d3.event.pageY-28+"px")}),t.append("path").datum(b).attr("class","violin").attr("d",r),s.attr("transform","rotate(90,0,0)  translate(0,-"+d+")"),t.attr("transform","rotate(90,0,0) scale(1,-1)")}function addBoxPlot(a,b,c,d,e,f,g,h){"use strict";var i=d3.select("#plotTooltip");if(h){var j=d3.scale.log().range(d).domain(f).nice();console.log("Printing log in boxplot")}else var j=d3.scale.linear().range(d).domain(f).nice();for(var k=d3.scale.linear().range([0,e]),l=.5-g/2,m=.5+g/2,n=[.05,.25,.5,.75,.95],o=0;o<n.length;o++)n[o]=j(b[o]);var p=a.append("g");p.append("rect").attr("class","boxplot fill").attr("x",k(l)).attr("width",k(m)-k(l)).attr("y",n[3]).attr("height",-n[3]+n[1]),p.append("rect").attr("class","boxplot").attr("x",k(l)).attr("width",k(m)-k(l)).attr("y",n[3]).attr("height",-n[3]+n[1]);var q=[[0,1],[3,4]];for(o=0;o<q.length;o++)p.append("line").attr("class","boxplot").attr("x1",k(.5)).attr("x2",k(.5)).attr("y1",n[q[o][0]]).attr("y2",n[q[o][1]]);q=[0,1,2,3,4];for(var r=["","","median","",""],s=['<h3 style="background-color: #000000;"><span style="color: white; ">5th percentile</span></h3><p><b>%VALUE</b></p>','<h3 style="background-color: #000000;"><span style="color: white; ">25th percentile</span></h3><p><b>%VALUE</b></p>','<h3 style="background-color: #FF0000;"><span style="color: white; ">Median</span></h3><p><b>%VALUE</b></p>','<h3 style="background-color: #000000;"><span style="color: white; ">75th percentile</span></h3><p><b>%VALUE</b></p>','<h3 style="background-color: #000000;"><span style="color: white; ">95th percentile</span></h3><p><b>%VALUE</b></p>'],o=0;o<q.length;o++)!function(a){var c=s[o].replace("%VALUE",b[q[o]].roundDecimals(4));p.append("line").attr("class","boxplot "+r[o]).attr("x1",k(l)).attr("x2",k(m)).attr("y1",n[q[o]]).attr("y2",n[q[o]]).on("mouseover",function(){i.transition().duration(100).style("opacity",1),i.html(c).style("left",d3.event.pageX+5+"px").style("top",d3.event.pageY-28+"px")}).on("mouseout",function(a){i.transition().duration(500).style("opacity",0)})}(o);var t='<h3 style="background-color: #FF0000;"><font color="white">Mean</font></h3><p><b>'+c.roundDecimals(4)+"</b></p>";p.append("circle").attr("class","boxplot mean").attr("cx",k(.5)).attr("cy",j(c)).attr("r",k(g/5)).on("mouseover",function(){i.transition().duration(100).style("opacity",1),i.html(t).style("left",d3.event.pageX+5+"px").style("top",d3.event.pageY-28+"px")}).on("mouseout",function(a){i.transition().duration(500).style("opacity",0)})}function addBeeswarm(a,b,c,d,e,f,g){"use strict";var h,i=d3.select("#beeswarmPointTooltip");h=g?d3.scale.log().range(c).domain(e).nice():d3.scale.linear().range(c).domain(e).nice();var j=d3.scale.linear().range(d).domain(f).nice(),k=a.append("g");b.swarm.forEach(function(a,c){var d,e=b.data[c],f=e.bgColor,g=(e.y,e.collectionDate);if(g&&g.length>1){var l=new Date(g[0]),m=new Date(g[1]);d=l.toDateString()+"-"+m.toDateString()}else if(g&&g.length>0){var n=new Date(g[0]);d=n.toDateString()}e.collectionDate=d;var o=e.species?e.species:"Unknown";e.species=o;var p=$.templates("#irBsPointTemplate"),q=p.render(e);k.append("circle").attr("cx",j(a.x)).attr("cy",h(a.y)).attr("r",4).style("fill",f).on("mouseover",function(a){if(!stickyHover){$("#cancel-hover").css("display","none"),i.transition().duration(delay).style("opacity",1).style("z-index",1e6),i.html(q);var b,c=window.innerHeight,d=i.node().getBoundingClientRect().height;b=d3.event.pageY-8+d>c?d3.event.pageY-d+28:d3.event.pageY-28,i.style("left",d3.event.pageX+20+"px").style("top",b+"px")}}).on("mouseout",function(a){stickyHover||i.transition().duration(delay).style("opacity",0).style("z-index",-1e6)}).on("click",function(){i.transition().duration(0).style("opacity",1).style("z-index",1e6),i.html(q);var a,b=window.innerHeight,c=i.node().getBoundingClientRect().height;a=d3.event.pageY-8+c>b?d3.event.pageY-c+28:d3.event.pageY-28,i.style("left",d3.event.pageX+20+"px").style("top",a+"px"),stickyHover=!0,$("#no-interactions").addClass("in").addClass("foreground").one("click",function(){i.transition().duration(delay).style("opacity",0).style("z-index",-1e6),$("#no-interactions").removeClass("in").removeClass("foreground"),$(document).off("click","#cancel-hover"),stickyHover=!1}),$("#cancel-hover").css("display","inline").one("click",function(){i.transition().duration(delay).style("opacity",0).style("z-index",-1e6),$("#no-interactions").removeClass("in").removeClass("foreground").off("click"),stickyHover=!1})})})}function buildPlot(a,b,c){"use strict";function d(a,b,c,d,e){var f=d3.scale.linear().range([j-u.bottom,u.top]).domain(a).nice(),h=d3.svg.axis().scale(f).orient("left");r.append("g").attr("class","axis").attr("transform","translate("+u.left+",0)").call(h),r.append("text").attr("x",u.left+s+t/2).attr("y",10).style("text-anchor","middle").text(g.capitalizeFirstLetter()),r.append("text").attr("x",u.left+s/2).attr("y",j-u.bottom+24).style("text-anchor","middle").style("font-weight","bold").text("Background"),r.append("text").attr("x",u.left+s/2).attr("y",j-u.bottom+40).style("text-anchor","middle").text("n="+b),c>0&&r.append("text").attr("x",u.left+s/2).attr("y",j-u.bottom+54).style("text-anchor","middle").text(c>1?c+" outliers excluded":c+" outlier excluded"),r.append("text").attr("x",u.left+s+t+s/2).attr("y",j-u.bottom+22).style("text-anchor","middle").style("font-weight","bold").text("Selection"),r.append("text").attr("x",u.left+s+t+s/2).attr("y",j-u.bottom+40).style("text-anchor","middle").text("n="+d),e>0&&r.append("text").attr("x",u.left+s+t+s/2).attr("y",j-u.bottom+54).style("text-anchor","middle").text(e>1?e+" outliers excluded":e+" outlier excluded")}var e,f=c.count,g=(c.min,c.max,c.phenotype_value_type_s),h=c.phenotype_value_unit_s,i=380,j=500,k=d3.select(a),l=25,m="basis";if(f<3)var n={pmin:"min(phenotype_value_f)",pmax:"max(phenotype_value_f)"};else var n={pmin:"percentile(phenotype_value_f,1)",pmax:"percentile(phenotype_value_f,99)"};var o=buildBbox(map.getBounds());d3.select("#beeViolinPlot")&&d3.select("#beeViolinPlot").remove();var p,q,r=k.append("svg").attr("width",i).attr("height",j).attr("style","width: "+i+"px; height: "+j+"px; border: 0; padding-top:10px").attr("id","beeViolinPlot"),s=150,t=10,u={top:25,bottom:65,left:40,right:20};switch($("#bgPlotType").val()){case"1":q=solrPopbioUrl+"irViolin?&"+qryUrl+'&fq=phenotype_value_type_s:"'+g+'"&fq=phenotype_value_unit_s:"'+h+'"&json.facet='+JSON.stringify(n)+"&json.wrf=?&callback=?";break;case"2":q=solrPopbioUrl+"irViolin?&"+qryUrl+o+'&fq=phenotype_value_type_s:"'+g+'"&fq=phenotype_value_unit_s:"'+h+'"&json.facet='+JSON.stringify(n)+"&json.wrf=?&callback=?";break;case"3":q=solrPopbioUrl+'irViolin?&q=*&fq=phenotype_value_type_s:"'+g+'"&fq=phenotype_value_unit_s:"'+h+'"&json.facet='+JSON.stringify(n)+"&json.wrf=?&callback=?"}$.getJSON(q).done(function(a){e=a.response.numFound;var c=a.facets.pmin,i=a.facets.pmax,k="&fq=phenotype_value_f:["+c+" TO "+i+"]";switch("percent"===h&&"mortality rate"===g&&(c=0,i=100),n={pmean:"avg(phenotype_value_f)",pperc:"percentile(phenotype_value_f,5,25,50,75,95)",pmin:"min(phenotype_value_f)",pmax:"max(phenotype_value_f)",denplot:{type:"range",field:"phenotype_value_f",gap:(i-c)/l,start:c,end:i,include:"edge"}},$("#bgPlotType").val()){case"1":p=solrPopbioUrl+"irBeeswarm?&"+qryUrl+k+'&fq=phenotype_value_type_s:"'+g+'"&fq=phenotype_value_unit_s:"'+h+'"&json.wrf=?&callback=?',q=solrPopbioUrl+"irViolin?&"+qryUrl+k+'&fq=phenotype_value_type_s:"'+g+'"&fq=phenotype_value_unit_s:"'+h+'"&json.facet='+JSON.stringify(n)+"&json.wrf=?&callback=?";break;case"2":p=solrPopbioUrl+"irBeeswarm?&"+qryUrl+k+o+'&fq=phenotype_value_type_s:"'+g+'"&fq=phenotype_value_unit_s:"'+h+'"&json.wrf=?&callback=?',q=solrPopbioUrl+"irViolin?&"+qryUrl+k+o+'&fq=phenotype_value_type_s:"'+g+'"&fq=phenotype_value_unit_s:"'+h+'"&json.facet='+JSON.stringify(n)+"&json.wrf=?&callback=?";break;case"3":p=solrPopbioUrl+"irBeeswarm?&q=*"+k+'&fq=phenotype_value_type_s:"'+g+'"&fq=phenotype_value_unit_s:"'+h+'"&json.wrf=?&callback=?',q=solrPopbioUrl+"irViolin?&q=*"+k+'&fq=phenotype_value_type_s:"'+g+'"&fq=phenotype_value_unit_s:"'+h+'"&json.facet='+JSON.stringify(n)+"&json.wrf=?&callback=?"}var v=$.getJSON(q);v.done(function(a){var o=r.append("g").attr("transform","translate("+(0*(s+t)+u.left)+",0)"),q=a.response.numFound;"percent"===h&&"mortality rate"===g&&(c=0,i=100);var v,w,x,y,z,A,B,C,D,E=[c,i],F=s/2;if(q>50)a.facets.count>0&&(A=a.facets.denplot.buckets,B=a.facets.pmean,C=a.facets.pperc,D=a.facets.count,addViolin(o,A,[j-u.bottom,u.top],s,E,l,m,!1),addBoxPlot(o,C,B,[j-u.bottom,u.top],s,E,.15,!1));else if(q>=10&&q<=50){var G=$.getJSON(p);G.fail(function(){console.log("Failed while loading irBeeswarm")}),G.done(function(b){if(b.grouped.phenotype_value_type_s.matches>0){w=b.grouped.phenotype_value_type_s.groups[0],F=s/2,v=[],y=(4*(i-c)/s).toFixed(6);var d=getScaleFactor(y),e=y*d;w.doclist.docs.forEach(function(a,b){buildDataset(v,a)}),x=new Beeswarm(v,0,e,d),z=[(s-8*x.maxPoints)/2,(s-8*x.maxPoints)/2+8*x.maxPoints],8*x.maxPoints>s&&(z=[0,s]),addBeeswarm(o,x,[j-u.bottom,u.top],z,E,x.domain,!1)}a.facets.count>0&&(A=a.facets.denplot.buckets,B=a.facets.pmean,C=a.facets.pperc,D=a.facets.count,addBoxPlot(o,C,B,[j-u.bottom,u.top],s,E,.15,!1))})}else{var G=$.getJSON(p);G.fail(function(){console.log("Failed while loading irBeeswarm")}),G.done(function(a){if(a.grouped.phenotype_value_type_s.matches>0){w=a.grouped.phenotype_value_type_s.groups[0],v=[],y=(4*(i-c)/s).toFixed(6);var b=getScaleFactor(y),d=y*b;w.doclist.docs.forEach(function(a,b){buildDataset(v,a)}),x=new Beeswarm(v,0,d,b),z=[(s-8*x.maxPoints)/2,(s-8*x.maxPoints)/2+8*x.maxPoints],8*x.maxPoints>s&&(z=[0,s]),addBeeswarm(o,x,[j-u.bottom,u.top],z,E,x.domain,!1)}})}var H=solrPopbioUrl+"irBeeswarm?&"+qryUrl+k+'&fq=phenotype_value_type_s:"'+g+'"&fq=phenotype_value_unit_s:"'+h+'"'+b+"&json.wrf=?&callback=?",I=solrPopbioUrl+"irViolin?&"+qryUrl+k+'&fq=phenotype_value_type_s:"'+g+'"&fq=phenotype_value_unit_s:"'+h+'"&json.facet='+JSON.stringify(n)+b+"&json.wrf=?&callback=?",J=$.getJSON(H),K=$.getJSON(I);$.when(J,K).done(function(a,b){var g,h,k,n,o,p,v,w,x=b[0].response.numFound,y=(b[0].facets.pmin,b[0].facets.pmax,r.append("g").attr("transform","translate("+(1*(s+t)+u.left)+",0)")),z=s/2;if(x>50)b[0].facets.count>0&&(p=b[0].facets.denplot.buckets,v=b[0].facets.pmean,w=b[0].facets.pperc,addViolin(y,p,[j-u.bottom,u.top],s,E,l,m,!1),addBoxPlot(y,w,v,[j-u.bottom,u.top],s,E,.15,!1));else if(x>=10&&x<=50){if(a[0].grouped.phenotype_value_type_s.matches>0){h=a[0].grouped.phenotype_value_type_s.groups[0],z=s/2,g=[],n=(4*(i-c)/s).toFixed(6);var A=getScaleFactor(n),B=n*A;h.doclist.docs.forEach(function(a,b){buildDataset(g,a)}),k=new Beeswarm(g,0,B,A),o=[(s-8*k.maxPoints)/2,(s-8*k.maxPoints)/2+8*k.maxPoints],8*k.maxPoints>s&&(o=[0,s]),addBeeswarm(y,k,[j-u.bottom,u.top],o,E,k.domain,!1)}b[0].facets.count>0&&(v=b[0].facets.pmean,w=b[0].facets.pperc,addBoxPlot(y,w,v,[j-u.bottom,u.top],s,E,.15,!1))}else if(a[0].grouped.phenotype_value_type_s.matches>0){h=a[0].grouped.phenotype_value_type_s.groups[0],g=[],n=(4*(i-c)/s).toFixed(6);var A=getScaleFactor(n),B=n*A;h.doclist.docs.forEach(function(a,b){buildDataset(g,a)}),k=new Beeswarm(g,0,B,A),o=[(s-8*k.maxPoints)/2,(s-8*k.maxPoints)/2+8*k.maxPoints],8*k.maxPoints>s&&(o=[0,s]),addBeeswarm(y,k,[j-u.bottom,u.top],o,E,k.domain,!1)}d(E,q,e-q,x,f-x),PaneSpin("swarm-plots","stop"),$("#swarm-chart-area").fadeIn(),$("#beeViolinPlot").fadeIn()}),J.fail(function(){console.log("Failed while loading irBeeswarm"),PaneSpin("swarm-plots","stop")}),K.fail(function(){console.log("Failed while loading irViolin"),PaneSpin("swarm-plots","stop")})}),v.fail(function(){console.log("Failed while loading irViolin")})}).fail(function(){console.log("Failed while loading irViolin")})}function getScaleFactor(a){a=parseFloat(a)+"";var b=a.indexOf(".");return b==-1?1:Math.pow(10,a.length-b-1)}function buildDataset(a,b){var c,d=b.species_category?b.species_category[0]:"Unknown";if("Species"===glbSummarizeBy)c=legend.options.palette[d];else{var e=mapSummarizeByToField(glbSummarizeBy).field,f=b[e];c=f?"object"==typeof f?legend.options.palette[f[0]]:legend.options.palette[f]:legend.options.palette.Unknown}a.push({x:void 0,y:b.phenotype_value_f,species:b.species_category,speciesType:"Taxonomy",insecticide:b.insecticide_s,insecticideType:"Insecticides",concentration:b.concentration_f,duration:b.duration_f,accession:b.accession,accessionType:"Stable ID",bundleName:b.bundle_name,url:b.url,sampleType:b.sample_type,sampleTypeType:"Sample type",geoCoords:b.geo_coords,geolocation:b.geolocations[0],geolocationType:"Geography",bgColor:c,textColor:getContrastYIQ(c),collectionDate:b.collection_date,projects:borderColor("Project",b.projects),projectsType:"Projects",collectionProtocols:borderColor("Collection protocol",b.collection_protocols),collectionProtocolsType:"Collection protocols",protocols:borderColor("Protocol",b.protocols),protocolsType:"Protocols",phenotypeValue:b.phenotype_value_f,phenotypeValueType:b.phenotype_value_type_s,phenotypeValueUnit:b.phenotype_value_unit_s,sampleSize:b.sample_size_i,concentrationUnit:b.concentration_unit_s,durationUnit:b.duration_unit_s})}function addGeohashes(a,b){function c(a,b){j.terms.push({term:a,selected:markers.isSelected(a)})}var d=geohashLevel(endingZoom,"geohash").slice(-1),e=(geohashLevel(startingZooom,"geohash").slice(-1),a.getBounds()),f=e.getSouth(),g=e.getNorth(),h=e.getEast(),i=e.getWest();if(geohashesGrid){a.removeLayer(geohashesGrid)}var j={_type:"terms",terms:[]},k=geohash.bboxes(f,i,g,h,d);k.forEach(c);var l=function(a){return a?"self"===a?"darkblue":"black":"transparent"},m=function(a){return a?"black":"grey"},n=function(a){if(!a)return""},o={recordsField:"terms",geohashField:"term",displayOptions:{selected:{fillColor:l,color:m,className:n}},layerOptions:{clickable:!1,fillOpacity:.2,opacity:.4,weight:.5,dashArray:"4, 6",interactive:!1}};geohashesGrid=new L.GeohashDataLayer(j,o),a.addLayer(geohashesGrid)}function bindEvents(){"use strict";function a(){window.clearTimeout(c),c=window.setTimeout(function(){endingZoom=map.getZoom(),loadSolr({clear:1,zoomLevel:map.getZoom()})},500)}function b(){window.clearTimeout(c)}var c;map.on("moveend",a).on("drag",b),map.on("movestart",function(){startingZooom=map.getZoom(),removeHighlight(),$(".collapse").collapse("hide"),sidebar.close(),setTimeout(function(){resetPlots()},delay)}).on("click",PopulationBiologyMap.methods.resetMap),$(document).on("click",".dropdown-menu li a",function(){var a=$(this).data("value"),b=$(this).text(),c=$(this).closest("div").attr("id");switch(c){case"summByDropdown":glbSummarizeBy=a;var d=solrPopbioUrl+viewMode+"Palette?q=*:*&geo=geohash_2&term="+mapSummarizeByToField(glbSummarizeBy).summarize+"&json.wrf=?&callback=?";highlightedId=$(".highlight-marker").attr("id"),$.getJSON(d,function(a){legend._populateLegend(a,glbSummarizeBy)}),$("#Filter-Terms").val("");break;case"sortByDropdown":legend.options.sortBy=b,legend.refreshLegend(legend.options.palette);var e=$.trim($("#Filter-Terms").val()).replace(/ +/g," ").toLowerCase();$(".table-legend-term").show().filter(function(){var a=$(this).text().replace(/\s+/g," ").toLowerCase();return!~a.indexOf(e)}).hide();break;default:$(this).parents(".dropdown").find(".btn").html($(this).data("value")+' <span class="caret"></span>'),$(this).parents(".dropdown").find(".btn").val($(this).data("value"))}}),$("#Reset-Filter").click(function(){$("#Filter-Terms").val(""),$(".table-legend-term").show()}),$("#download-button").click(function(){var a=$("#select-export").val(),b=solrExportUrl,c=buildBbox(map.getBounds()),d="&fl=",e="";if("abnd"===viewMode&&(e="&zeroFilter="+($("#checkbox-export-zeroes").is(":checked")?"":"-sample_size_i:0")),$("#export-error").fadeOut(),$(this).removeAttr("href"),!$("#select-export-fields").val())return void $("#export-error").addClass("alert alert-warning").html('<h5><i class="fa fa-exclamation-triangle fa-fw"></i> Please select at least one field</h5>').fadeIn();switch(d+=$("#select-export-fields").val().join(),d+=",exp_citations_ss",a){case"1":b+=viewMode+"Export?q=*:*"+d+"&sort=exp_id_s+asc"+e,this.href=b;break;case"2":b+=viewMode+"Export?"+qryUrl+d+"&sort=exp_id_s+asc"+e,this.href=b;break;case"3":b+=viewMode+"Export?"+qryUrl+c+d+"&sort=exp_id_s+asc"+e,this.href=b;break;case"4":var f=$(".highlight-marker").attr("id");if(f){var g=f.length,h="&fq=geohash_"+g+":"+f;$("#export-error").fadeOut().removeClass("alert alert-warning").html(""),b+=viewMode+"Export?"+qryUrl+h+d+"&sort=exp_id_s+asc"+e,this.href=b}else $("#export-error").addClass("alert alert-warning").html('<h5><i class="fa fa-exclamation-triangle fa-fw"></i> Please select a marker first.</h5>').fadeIn()}});var d="";$.each(legend.options.trafficlight.colorBrewer.reverse(),function(a,b){d+='<i style="margin: 0; border-radius: 0; border: 0; color: '+b+"; width: 10%; background-color: "+b+' ;"></i>'}),$("#menu-scale-bars").html(d),normIrSlider=$("#pre-norm-ir-slider").bslider({value:[0,9],id:"norm-ir-slider",handle:"triangle",min:0,max:9,step:1,tooltip:"hide"}),$(".sidebar-icon").on("click",function(){var a=$(".highlight-marker");a&&(sidebarClick=!0,$(a).trigger("click"),sidebarClick=!1)}),$(document).on("click",".active-hover",function(a){stickyHover&&$("#beeswarmPointTooltip").css("z-index","3000");var b,c,d,e=$("#vbEntityTooltip"),f=$(this).attr("value"),g=$(this).attr("type"),h=$(this).data("bgcolor"),i=getContrastYIQ(h),j='<div class="row no-pad" style="width: 370px; height: 300px"><div class="col-md-12"><div class="cancel" id="entity-cancel-hover" style="display: inline;"><i class="fa fa-times"></i></div><h3 style="background-color: "'+h+'"; color: "'+i+'";  margin: 0 -10px 0 0;"></h3></div><div class="row less-margin"><div class="col-md-12"></div></div></div>';switch(g){case"Projects":b=$.templates("#projectInfoTemplate"),d="/popbio/project/?id="+f,c="/popbio/REST/project/"+f+"/head"}var k=$.getJSON(c);e.html(j);var l=window.innerHeight,m=400;e.height()>0&&(m=e.height());var n;n=a.pageY-m<8?8:a.pageY+m>l?a.pageY-m-8:a.pageY-28,e.css("left",a.pageX+10+"px").css("top",n+"px"),e.css("opacity","1").css("z-index","1000000"),PaneSpin("vbEntityTooltip","start"),$(document).one("click","#entity-cancel-hover",function(a){e.animate({opacity:0,"z-index":-1e6},delay),stickyHover?$("#beeswarmPointTooltip").css("z-index","1000000"):$("#no-interactions").removeClass("in").removeClass("foreground").off("click"),PaneSpin("vbEntityTooltip","stop")}),$("#no-interactions").addClass("in").addClass("foreground").one("click",function(){e.animate({opacity:0,"z-index":-1e6},delay),$("#no-interactions").removeClass("in").removeClass("foreground"),$(document).off("click","#entity-cancel-hover"),PaneSpin("vbEntityTooltip","stop")}),k.done(function(c){c.entityType=g;var f=new Date(c.creation_date),j=new Date(c.last_modified_date);c.creation_date=f.toDateString(),c.last_modified_date=j.toDateString(),c.bgColor=h,c.textColor=i,c.entityURL=d;var k=b.render(c);e.html(k),m=e.height(),n=a.pageY-m<8?8:a.pageY+m>l?a.pageY-m-8:a.pageY-28,e.animate({left:a.pageX+10+"px",top:n+"px"},delay),e.has_scrollbar()&&$("#entity-cancel-hover").css("margin-right","10px"),PaneSpin("vbEntityTooltip","stop")}).fail(function(){return PaneSpin("vbEntityTooltip","stop"),"Error while retrieving data"})}),$(document).on("click",".active-term",function(){highlightedId=$(".highlight-marker").attr("id"),"swarm-plots"===$(".sidebar-pane.active").attr("id")?selectedPlotType=$("#plotType").val():$("#plotType").val("none"),$("#search_ac").tagsinput("add",{value:$(this).attr("value"),activeTerm:!0,type:$(this).attr("type"),field:mapTypeToField($(this).attr("type")),qtype:"exact"});var a=d3.select("#beeswarmPointTooltip");$("#no-interactions").hasClass("foreground")&&(a.transition().duration(500).style("opacity",0).style("z-index",-1e6),$("#no-interactions").removeClass("in").removeClass("foreground"),stickyHover=!1)}).on("click",".active-legend",function(){highlightedId=$(".highlight-marker").attr("id"),PopulationBiologyMap.data.highlightedId=$(".highlight-marker").attr("id"),$("#search_ac").tagsinput("add",{value:$(this).attr("value"),activeTerm:!0,type:$(this).attr("type"),field:mapTypeToField($(this).attr("type")),qtype:"exact"});var a=d3.select("#beeswarmPointTooltip");$("#no-interactions").hasClass("foreground")&&(a.transition().duration(500).style("opacity",0).style("z-index",-1e6),$("#no-interactions").removeClass("foreground"),stickyHover=!1),map.on("click",PopulationBiologyMap.methods.resetMap)}).on("jsonLoaded",function(){highlightedId&&void 0==PopulationBiologyMap.data.highlightedId&&(PopulationBiologyMap.data.highlightedId=highlightedId)}),$("#grid-toggle").change(function(){if($(this).prop("checked")){geohashLevel(map.getZoom(),"geohash");addGeohashes(map,!0)}else map.removeLayer(geohashesGrid)}),$("#advanced-options").on("show.bs.collapse",function(){$("#bars-icon").toggleClass("down")}).on("hide.bs.collapse",function(){$("#bars-icon").toggleClass("down")}),$("#daterange").on("hidden.bs.collapse",function(){$("#date-start").datepicker("clearDates"),$("#date-end").datepicker("clearDates"),$("#add-dates").prop("disabled",!0),$("#add-season").prop("disabled",!0)}),$("#seasonal").on("hidden.bs.collapse",function(){checkSeasonal()||$(".season-toggle").each(function(){$(this).prop("checked")&&$(this).bootstrapToggle("off")})}),$("#date-select, #SelectView").click(function(){"true"==$("#seasonal").attr("aria-expanded")&&$("#seasonal").collapse("hide")}),$("#season-select, #SelectView").click(function(){"true"==$("#daterange").attr("aria-expanded")&&$("#daterange").collapse("hide")}),$("#daterange").find(".input-daterange").datepicker({format:"dd/mm/yyyy",startView:2,todayBtn:"linked",autoclose:!0,todayHighlight:!0,endDate:"Date.now()"}),$(".season-toggle").change(function(){var a=!1;$(".season-toggle").each(function(){var b=$(this).val(),c=$(this).prop("checked");months[b]=c,c&&(a=!0)}),a?$("#add-season").prop("disabled",!1):$("#add-season").prop("disabled",!0)}),$("#add-season").click(function(){var a=constructSeasonal(months);checkSeasonal()?($("#search_ac").tagsinput("add",{value:a.rangesText.toString(),ranges:a.ranges,replace:!0,type:"Seasonal",field:"collection_season"}),$("#search_ac").tagsinput("remove",checkSeasonal())):$("#search_ac").tagsinput("add",{value:a.rangesText.toString(),ranges:a.ranges,replace:!1,type:"Seasonal",field:"collection_season"})}),$("#add-norm-ir").click(function(){var a={0:1,1:.9,2:.8,3:.7,4:.6,5:.4,6:.3,7:.2,8:.1,9:0},b=normIrSlider.bslider("getValue"),c=b[0],d=b[1],e="";$.each(legend.options.trafficlight.colorBrewer.reverse().slice(c,d+1),function(a,b){e+='<i style="margin: 0; border-radius: 0; border: 0; color: '+b+";width: 6px; background - color: "+b+";>&nbsp &nbsp</i>"}),b=a[d]+" TO "+a[c],$("#search_ac").tagsinput("add",{value:b,html:e,normIrValues:b,type:"Norm-IR",field:"phenotype_rescaled_value_f"})}),$("#date-start").datepicker().on("changeDate",function(a){$("#add-dates").prop("disabled",!1)}),$("#add-dates").click(function(){var a,b=new Date($("#date-start").datepicker("getUTCDate")),c=new Date($("#date-end").datepicker("getUTCDate"));a=b.getTime()===c.getTime()?b.toLocaleDateString("en-GB"):b.toLocaleDateString("en-GB")+"-"+c.toLocaleDateString("en-GB"),$("#search_ac").tagsinput("add",{value:a,dateStart:b,dateEnd:c,type:"Date",field:"collection_date_range"})}),$(".date-shortcut").click(function(){setDateRange("#date-start","#date-end",this.value)}),$("#search_ac").on("itemAdded",function(a){if(!a.item.replace)return a.item.activeTerm?($("#search-bar").animate({left:"+=4"},15).animate({left:"-=8"},30).animate({left:"+=8"},30).animate({left:"-=8"},30).animate({left:"+=8"},30).animate({left:"-=4"},15),void filterMarkers($("#search_ac").tagsinput("items"))):void setTimeout(function(){highlightedId=$(".highlight-marker").attr("id"),PopulationBiologyMap.data.highlightedId=$(".highlight-marker").attr("id"),filterMarkers($("#search_ac").tagsinput("items"))},delay)}),$("#search_ac").on("itemRemoved",function(){checkSeasonal()||$(".season-toggle").each(function(){$(this).prop("checked")&&$(this).bootstrapToggle("off")}),setTimeout(function(){highlightedId=$(".highlight-marker").attr("id"),PopulationBiologyMap.data.highlightedId=$(".highlight-marker").attr("id"),filterMarkers($("#search_ac").tagsinput("items"))},delay)})}function initializeMap(a){"use strict";var b=MQ.mapLayer(),c=a.flyTo,d=PopulationBiologyMap.data.zoomLevel,e=PopulationBiologyMap.data.center,f=15;void 0==d&&(d=3),void 0==e&&(e=[23.079,3.515]),"abnd"==viewMode&&(f=12,d>12&&(d=12)),map=L.map("map",{center:e,minZoom:1,maxZoom:f,zoom:d,zoomControl:!1,zoomAnimationThreshold:16,worldCopyJump:!0}),map.spin(!0),startingZooom=map.getZoom(),endingZoom=map.getZoom(),map.addControl(new L.Control.FullScreen({position:"topright",forcePseudoFullscreen:!0})),map.addControl(new L.Control.ZoomMin({position:"topright"})),sidebar=L.control.sidebar("sidebar").addTo(map),L.control.scale({position:"bottomright"}).addTo(map);var g=new L.tileLayer("http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{minZoom:2,maxZoom:f,noWrap:0,attribution:'&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery Â© <a href="http://mapbox.com">Mapbox</a>'});map.addLayer(b),markers=new L.Map.SelectMarkers(map),assetLayerGroup=new L.PopbioMarkers,assetLayerGroup.addTo(map);var h=new L.Control.Layers({Map:b,Hybrid:MQ.hybridLayer(),Satellite:MQ.satelliteLayer(),Dark:MQ.darkLayer(),Light:MQ.lightLayer(),OpenStreetMap:g});h.setPosition("topright"),h.addTo(map),("true"===urlParams.grid||$("#grid-toggle").prop("checked"))&&addGeohashes(map,!0),"geno"===viewMode&&(glbSummarizeBy="Allele");var i=solrPopbioUrl+viewMode+"Palette?q=*:*&geo=geohash_2&term="+mapSummarizeByToField(glbSummarizeBy).summarize+"&json.wrf=?&callback=?";legend=new L.control.legend(i,{summarizeBy:glbSummarizeBy,flyTo:c}),null!==rectHighlight&&map.removeLayer(rectHighlight),rectHighlight=null,map.spin(!1)}function initializeSearch(){$("#reset-search").click(function(){$("#search_ac").tagsinput("removeAll"),$(".season-toggle").each(function(){$(this).prop("checked")&&$(this).bootstrapToggle("off")}),removeHighlight(),sidebar.close(),setTimeout(function(){resetPlots(),filterMarkers("")},delay)});var a=new Bloodhound({datumTokenizer:Bloodhound.tokenizers.whitespace,queryTokenizer:Bloodhound.tokenizers.whitespace,limit:7,minLength:2,hint:!1,remote:{url:solrTaUrl+viewMode+"Ac?q=",ajax:{dataType:"jsonp",data:{wt:"json",rows:7},jsonp:"json.wrf"},replace:function(a,b){a=solrTaUrl+viewMode+"Ac?q=";var c=b.match(/([^@]+)@([^@]*)/);return null!=c?(partSearch=c[1],$("#world-toggle").prop("checked")?solrTaUrl+viewMode+"Acat?q="+encodeURI(c[1])+buildBbox(map.getBounds()):solrTaUrl+viewMode+"Acat?q="+encodeURI(c[1])):(partSearch=!1,$("#world-toggle").prop("checked")?a+encodeURI(b)+buildBbox(map.getBounds()):a+encodeURI(b))},filter:function(a){return partSearch?$.map(a.grouped.type.doclist.docs,function(a){return{value:partSearch,id:a.id,type:a.type,field:a.field,is_synonym:a.is_synonym,
qtype:"partial"}}):$.map(a.grouped.textsuggest_category.doclist.docs,function(a){return{value:a.textsuggest_category,type:a.type,id:a.id,field:a.field,is_synonym:a.is_synonym,qtype:"exact"}})}}});a.initialize();var b=new Bloodhound({datumTokenizer:Bloodhound.tokenizers.whitespace,queryTokenizer:Bloodhound.tokenizers.whitespace,limit:10,minLength:3,remote:{url:solrTaUrl+viewMode+"Acgrouped?q=",ajax:{dataType:"jsonp",data:{wt:"json",rows:10},jsonp:"json.wrf"},replace:function(a,b){return a=solrTaUrl+viewMode+"Acgrouped?q=",$("#world-toggle").prop("checked")?a+encodeURI(b)+"*"+buildBbox(map.getBounds()):a+encodeURI(b)+"*"},filter:function(a){a.grouped.stable_id.ngroups;return $.map(a.facet_counts.facet_fields.type,function(a){if(a[1]>0)return{count:a[1],type:a[0],field:mapTypeToField(a[0]),value:$("#search_ac").tagsinput("input")[0].value,qtype:"summary"}})}}});b.initialize(),$("#search_ac").tagsinput({tagClass:function(a){return mapTypeToLabel(a.type)},itemValue:"value",itemText:function(a){return'<i class="fa '+mapTypeToIcon(a.type)+'"></i> '+a.value.truncString(80)},itemHTML:function(a){return'<i class="fa '+mapTypeToIcon(a.type)+'"></i> '+a.value.truncString(80)},typeaheadjs:{options:{minLength:3,hint:!1,highlight:!1},datasets:[{name:"acSuggestions",displayKey:"value",source:a.ttAdapter(),templates:{empty:function(){var a;return a=$("#world-toggle").prop("checked")?"No suggestions found. Try enabling world search or hit enter to perform a free text search instead.":"No suggestions found. Hit Enter to perform a free text search instead.",['<span class="tt-suggestions" style="display: block;">','<div class="tt-suggestion">','<p style="white-space: normal;">',a,"</p>","</div>","</span>"].join("\n")},suggestion:function(a){return"<p>"+a.value+(a.is_synonym?' (<i class="fa fa-list-ul" title="Duplicate term / Synonym" style="cursor: pointer"></i>)':"")+" <em> in "+a.type+"</em></p>"}}},{name:"acOtherResults",displayKey:"value",source:b.ttAdapter(),templates:{header:'<h4 class="more-results">More suggestions</h4>',suggestion:function(a){return"<p>~"+a.count+" <em>in "+a.type+"</em></p>"}}}]}}),$("#SelectView").change(function(){viewMode=$("#SelectView").val(),"ir"!==viewMode&&"Insecticide"===glbSummarizeBy&&("geno"===viewMode?glbSummarizeBy="Allele":glbSummarizeBy="Species"),"geno"!==viewMode&&"Allele"===glbSummarizeBy&&(glbSummarizeBy="Species"),"abnd"==viewMode?(map.options.maxZoom=12,map.getZoom()>12&&map.setZoom(12)):map.options.maxZoom=15,updateExportFields(viewMode);var c=solrPopbioUrl+viewMode+"Palette?q=*:*&geo=geohash_2&term="+mapSummarizeByToField(glbSummarizeBy).summarize+"&json.wrf=?&callback=?";removeHighlight(),sidebar.close(),setTimeout(function(){resetPlots()},delay),$.getJSON(c,function(a){legend._populateLegend(a,glbSummarizeBy,!0)}),a.initialize(!0),b.initialize(!0)})}function updateExportFields(a){var b=[{value:"exp_sample_id_s",label:"Sample ID",icon:mapTypeToIcon("Collection ID")},{value:"exp_bundle_name_s",label:"Record type",icon:mapTypeToIcon("Sample type")},{value:"exp_species_s",label:"Species",icon:mapTypeToIcon("Taxonomy")},{value:"exp_sample_type_s",label:"Sample type",icon:mapTypeToIcon("Sample type")},{value:"exp_label_s",label:"Label",icon:mapTypeToIcon("Description")},{value:"exp_collection_assay_id_s",label:"Collection ID",icon:mapTypeToIcon("Collection ID")},{value:"exp_collection_date_range_ss",label:"Collection date range",icon:mapTypeToIcon("Date")},{value:"exp_collection_protocols_ss",label:"Collection protocols",icon:mapTypeToIcon("Collection protocols")},{value:"exp_projects_ss",label:"Projects",icon:mapTypeToIcon("Projects")},{value:"exp_geo_coords_s",label:"Coordinates (lat, long)",icon:mapTypeToIcon("Coordinates")},{value:"exp_geolocations_ss",label:"Locations",icon:mapTypeToIcon("Location")},{value:"exp_protocols_ss",label:"Protocols",icon:mapTypeToIcon("Protocols")}],c=[{value:"exp_sample_id_s",label:"Sample ID",icon:mapTypeToIcon("Collection ID")},{value:"exp_assay_id_s",label:"Assay ID",icon:mapTypeToIcon("Collection ID")},{value:"exp_bundle_name_s",label:"Record type",icon:mapTypeToIcon("Sample type")},{value:"exp_species_s",label:"Species",icon:mapTypeToIcon("Taxonomy")},{value:"exp_sample_type_s",label:"Sample type",icon:mapTypeToIcon("Sample type")},{value:"exp_label_s",label:"Label",icon:mapTypeToIcon("Description")},{value:"exp_collection_assay_id_s",label:"Collection ID",icon:mapTypeToIcon("Collection ID")},{value:"exp_collection_date_range_ss",label:"Collection date range",icon:mapTypeToIcon("Date")},{value:"exp_collection_protocols_ss",label:"Collection protocols",icon:mapTypeToIcon("Collection protocols")},{value:"exp_projects_ss",label:"Projects",icon:mapTypeToIcon("Projects")},{value:"exp_geo_coords_s",label:"Coordinates (lat, long)",icon:mapTypeToIcon("Coordinates")},{value:"exp_geolocations_ss",label:"Locations",icon:mapTypeToIcon("Location")},{value:"exp_phenotype_type_s",label:"Phenotype type",icon:mapTypeToIcon("Sample type")},{value:"exp_insecticide_s",label:"Insecticide",icon:mapTypeToIcon("Insecticide")},{value:"genotype_name_s",label:"Allele",icon:mapTypeToIcon("Allele")},{value:"exp_protocols_ss",label:"Protocols",icon:mapTypeToIcon("Protocols")},{value:"exp_concentration_f,exp_concentration_unit_s",label:"Concentration",subtext:"value, unit",icon:mapTypeToIcon("Concentration")},{value:"exp_duration_f,exp_duration_unit_s",label:"Duration",subtext:"value, unit",icon:mapTypeToIcon("Duration")},{value:"exp_phenotype_value_f,exp_phenotype_value_unit_s,exp_phenotype_value_type_s",label:"Phenotype value",subtext:"value, unit, type",icon:mapTypeToIcon("Phenotype")}],d=[{value:"exp_sample_id_s",label:"Sample ID",icon:mapTypeToIcon("Collection ID")},{value:"exp_bundle_name_s",label:"Record type",icon:mapTypeToIcon("Sample type")},{value:"exp_species_s",label:"Species",icon:mapTypeToIcon("Taxonomy")},{value:"exp_sample_type_s",label:"Sample type",icon:mapTypeToIcon("Sample type")},{value:"exp_label_s",label:"Label",icon:mapTypeToIcon("Description")},{value:"exp_collection_assay_id_s",label:"Collection ID",icon:mapTypeToIcon("Collection ID")},{value:"exp_collection_date_range_ss",label:"Collection date range",icon:mapTypeToIcon("Date")},{value:"exp_collection_protocols_ss",label:"Collection protocols",icon:mapTypeToIcon("Collection protocols")},{value:"exp_projects_ss",label:"Projects",icon:mapTypeToIcon("Projects")},{value:"exp_geo_coords_s",label:"Coordinates (lat, long)",icon:mapTypeToIcon("Coordinates")},{value:"exp_geolocations_ss",label:"Locations",icon:mapTypeToIcon("Location")},{value:"exp_protocols_ss",label:"Protocols",icon:mapTypeToIcon("Protocols")},{value:"exp_sample_size_i",label:"Specimens collected",icon:mapTypeToIcon("Count")},{value:"exp_collection_duration_days_i",label:"Collection duration (days)",icon:mapTypeToIcon("Duration")}],e=[{value:"exp_sample_id_s",label:"Sample ID",icon:mapTypeToIcon("Collection ID")},{value:"exp_description_s",label:"Description",icon:mapTypeToIcon("Description")},{value:"exp_bundle_name_s",label:"Record type",icon:mapTypeToIcon("Sample type")},{value:"exp_species_s",label:"Species",icon:mapTypeToIcon("Taxonomy")},{value:"exp_sample_type_s",label:"Sample type",icon:mapTypeToIcon("Sample type")},{value:"exp_label_s",label:"Label",icon:mapTypeToIcon("Description")},{value:"exp_collection_assay_id_s",label:"Collection ID",icon:mapTypeToIcon("Collection ID")},{value:"exp_collection_date_range_ss",label:"Collection date range",icon:mapTypeToIcon("Date")},{value:"exp_collection_protocols_ss",label:"Collection protocols",icon:mapTypeToIcon("Collection protocols")},{value:"exp_projects_ss",label:"Projects",icon:mapTypeToIcon("Projects")},{value:"exp_geo_coords_s",label:"Coordinates (lat, long)",icon:mapTypeToIcon("Coordinates")},{value:"exp_geolocations_ss",label:"Locations",icon:mapTypeToIcon("Location")},{value:"exp_protocols_ss",label:"Protocols",icon:mapTypeToIcon("Protocols")},{value:"exp_sample_size_i",label:"Specimens collected",icon:mapTypeToIcon("Count")},{value:"exp_assay_id_s",label:"Assay Id",icon:mapTypeToIcon("Assay Id")},{value:"exp_phenotypes_ss",label:"Phenotypes",icon:mapTypeToIcon("Phenotypes")},{value:"exp_genotype_type_s",label:"Genotype Type",icon:mapTypeToIcon("Genotype Type")},{value:"exp_genotype_name_s",label:"Genotype Name",icon:mapTypeToIcon("Genotype Name")},{value:"exp_genotype_mutated_protein_value_f",label:"Mutated Protein Value",icon:mapTypeToIcon("Mutated Protein Value")}];if($("#select-export-fields").empty(),"ir"===a)$.each(c,function(a,b){$("#select-export-fields").append($("<option></option>").attr("value",b.value).text(b.label).data("subtext",b.subtext).data("icon",b.icon))});else{var f=b;"abnd"===a&&(f=d),"geno"===a&&(f=e),$.each(f,function(a,b){$("#select-export-fields").append($("<option></option>").attr("value",b.value).text(b.label).data("icon",b.icon))})}var g=$("#div-export-zeroes");"abnd"===a?g.show():g.hide(),$("#select-export-fields").selectpicker("refresh").selectpicker("selectAll")}function loadSolr(a){"use strict";var b=a.clear,c=a.zoomLevel,d=a.flyTo,e=geohashLevel(c,"geohash"),f=90,g=-90,h=180,i=-180,j=function(a){var c=[];if("ir"===viewMode?$("#markersCount").html(a.response.numFound+" visible assays summarized by "+glbSummarizeBy+"</u>"):"abnd"===viewMode?$("#markersCount").html(a.facets.sumSmp+" visible individuals summarized by "+glbSummarizeBy+"</u>"):"geno"===viewMode?$("#markersCount").html(a.facets.alleleCount.roundDecimals(0)+" visible genotypes summarized by "+glbSummarizeBy+"</u>"):$("#markersCount").html(a.response.numFound+" visible samples summarized by "+glbSummarizeBy+"</u>"),0===a.response.numFound)return b&&assetLayerGroup.clearLayers(),null!==rectHighlight&&map.removeLayer(rectHighlight),rectHighlight=null,void map.spin(!1);var e=a.facets.geo.buckets,j={};if(e.forEach(function(a){if("abnd"===viewMode)var b=a.sumSmp;else if("geno"===viewMode)var b=a.alleleCount.roundDecimals(0);else var b=a.count;var d=a.val,e=[],k=0,l=a.term.buckets;l.forEach(function(a){var b=a.val;if("abnd"===viewMode)var c=a.sumSmp;else if("geno"===viewMode)var c=a.alleleCount.roundDecimals(0);else var c=a.count;c>0&&e.push({label:b,value:c,color:legend.options.palette[b]?legend.options.palette[b]:"#000000"}),k+=c}),b-k>0&&e.push({label:"Unknown",value:b-k,color:legend.options.palette.Unknown}),j[d]=e;var m={};m.term=d,m.count=b,"abnd"===viewMode,m.latLng=[a.ltAvg,a.lnAvg],m.bounds=[[a.ltMin,a.lnMin],[a.ltMax,a.lnMax]],m.atomic=1===a.atomicCount,"ir"===viewMode?m.trafficlight=a.irAvg:m.trafficlight=-1,m.fullstats=j[d],c.push(m),f>a.ltMin&&(f=a.ltMin),g<a.ltMax&&(g=a.ltMax),h>a.lnMin&&(h=a.lnMin),i<a.lnMax&&(i=a.lnMax)}),markersBounds=[[f,h],[g,i]],d){map.setMinZoom(map.getZoom());var k=map.getZoom()<4?6:map.getZoom();return map.fitBounds(markersBounds,{duration:1,maxZoom:k}),map.setMinZoom(1),void map.spin(!1)}var l={};l.terms=c;var m={recordsField:"terms",latitudeField:"latLng.0",longitudeField:"latLng.1",layerOptions:{fill:!1,stroke:!1,weight:0,color:"#80FF00",dropShadow:!1,opacity:.2},setIcon:function(a){var b=40,c=a.count;return"abnd"===viewMode&&a.count>999&&(c=Math.round(a.count/1e3)+"k"),new L.Icon.Canvas({iconSize:new L.Point(b,b),markerText:c,count:a.count,trafficlight:a.trafficlight,id:a.term,stats:a.fullstats,atomic:a.atomic})},onEachRecord:function(a,b){var c=$("#plotTooltip");a.on("dblclick",function(){clearTimeout(timer),prevent=!0,map.fitBounds(b.bounds,{padding:[100,50]})}).on("click",function(c){if(c.originalEvent.ctrlKey)c.target instanceof L.Marker&&(markers.toggleMarker(c.target,assetLayerGroup),("true"===urlParams.grid||$("#grid-toggle").prop("checked"))&&addGeohashes(map,!0));else{var d=$(".sidebar-pane.active"),e=d.attr("id"),f=L.latLngBounds(b.bounds);if(highlightedId){switch($(".sidebar-pane").data("has-graph",!1),e){case"graphs":updatePieChart(b.count,b.fullstats),d.data("has-graph",!0);break;case"swarm-plots":"abnd"===viewMode?PopulationBiologyMap.methods.createAbundanceGraph("#swarm-plots",buildBbox(f)):(createBeeViolinPlot("#swarm-chart-area",buildBbox(f)),d.data("has-graph",!0));break;case"marker-table":updateTable("#table-contents",buildBbox(f)),d.data("has-graph",!0)}return void(prevent=!1)}if(sidebarClick){switch(e){case"graphs":d.data("has-graph")||(updatePieChart(b.count,b.fullstats),d.data("has-graph",!0));break;case"swarm-plots":"abnd"===viewMode?PopulationBiologyMap.methods.createAbundanceGraph("#swarm-plots",buildBbox(f)):d.data("has-graph")||(createBeeViolinPlot("#swarm-chart-area",buildBbox(f)),d.data("has-graph",!0));break;case"marker-table":d.data("has-graph")||(updateTable("#table-contents",buildBbox(f)),d.data("has-graph",!0))}return void(prevent=!1)}var g=!1;a._icon===highlight&&(g=!0),removeHighlight(a),highlightMarker(a),timer=setTimeout(function(){if(!prevent){if(g)return removeHighlight(),sidebar.close(),void setTimeout(function(){resetPlots()},delay);switch($("#sidebar").hasClass("collapsed")&&("help"===$(".sidebar-pane.active").attr("id")?sidebar.open("graphs"):($("#swarm-chart-area").empty(),$("#table-contents").empty(),sidebar.open(e))),$(".sidebar-pane").data("has-graph",!1),e){case"graphs":updatePieChart(b.count,b.fullstats),d.data("has-graph",!0);break;case"swarm-plots":"abnd"===viewMode?PopulationBiologyMap.methods.createAbundanceGraph("#swarm-plots",buildBbox(f)):(createBeeViolinPlot("#swarm-chart-area",buildBbox(f)),d.data("has-graph",!0));break;case"marker-table":updateTable("#table-contents",buildBbox(f)),d.data("has-graph",!0);break;case"help":updatePieChart(b.count,b.fullstats),d.data("has-graph",!0),sidebar.open("graphs")}}},delay),prevent=!1}}).on("mouseover",function(c){moveTopMarker(a);var d=L.latLngBounds(b.bounds);null!==rectHighlight&&map.removeLayer(rectHighlight),rectHighlight=L.rectangle(d,{color:"grey",weight:1,fill:!0,clickable:!1}).addTo(map)}).on("mouseout",function(){removeTopMarker(a),null!==rectHighlight&&map.removeLayer(rectHighlight),rectHighlight=null,c.clearQueue().animate({opacity:0},400,function(){})})}};L.Util.setOptions(assetLayerGroup,m);var n=new L.PopbioMarkers(l,m),o=endingZoom-startingZooom;b&&assetLayerGroup.eachLayer(function(a){a instanceof L.Marker&&(a.options.remove=!0)}),n.initLatLngStorage(),n.eachLayer(function(a){if(a instanceof L.Marker){a.getLatLng();n.saveLatLng(a);var b=assetLayerGroup.startingLatLng(a);a.setLatLng(b),assetLayerGroup.addLayer(a);var c=a._icon;a.options.remove||$(c).addClass("leaflet-marker-icon-anim"),$(c).one("webkitAnimationEnd oanimationend msAnimationEnd animationend",function(a){$(c).removeClass("leaflet-marker-icon-anim")})}}),assetLayerGroup.storedMarkerCoords=n.storedMarkerCoords,null!==rectHighlight&&map.removeLayer(rectHighlight),rectHighlight=null,map.spin(!1),setTimeout(function(){assetLayerGroup.eachLayer(function(a){if(a instanceof L.Marker)if(a.options.remove){var b=a._icon;if(o>=0)$(b).addClass("leaflet-marker-icon-fout"),setTimeout(function(){a.setOpacity(0),setTimeout(function(){assetLayerGroup.removeLayer(a)},300)});else{$(b).addClass("leaflet-marker-icon-anim");var c=assetLayerGroup.startingLatLng(a);setTimeout(function(){a.setLatLng(c),a.setOpacity(0),setTimeout(function(){assetLayerGroup.removeLayer(a),void 0!=PopulationBiologyMap.data.highlightedId&&(PopulationBiologyMap.data.highlightedId=void 0)},300)})}}else{var c=assetLayerGroup.startingLatLng(a);a.setLatLng(c),a.setOpacity(1)}}),setTimeout(function(){if(highlightedId=PopulationBiologyMap.data.highlightedId,highlightedId){var a=$("#"+highlightedId);highlightedId=!1,a.length>0?($(a).trigger("click"),highlightMarker(a)):(removeHighlight(),sidebar.close(),setTimeout(function(){resetPlots()},delay)),highlightedId=!1}else PopulationBiologyMap.methods.resetMap()},800)},50),("true"===urlParams.grid||$("#grid-toggle").prop("checked"))&&addGeohashes(map,!1)};map.spin(!0);var k={bbox:buildBbox(map.getBounds()).replace(/&fq=/,""),geo:e,geomax:geohashLevel(map.options.maxZoom,"geohash"),term:mapSummarizeByToField(glbSummarizeBy).summarize},l=solrPopbioUrl+viewMode+"Geoclust?"+qryUrl+"&"+$.param(k)+"&json.wrf=?&callback=?";$.getJSON(l,{cache:!0,headers:{"Cache-Control":"max-age=2592000"}},j).done(function(){$(document).trigger("jsonLoaded")}).fail(function(){console.log("Failed to load json"),map.spin(!1)})}function checkSeasonal(){for(var a=$("#search_ac").tagsinput("items"),b=0;b<a.length;b++){var c=a[b];if("Seasonal"===c.type)return c.value}return!1}function buildBbox(a){"use strict";var b;if(void 0!==typeof a.getEast()&&a.getEast()!==!1){var c=a.getSouth();c<-90&&(c=-90);var d=a.getNorth();d>90&&(d=90);var e=a.getWest();e<-180&&(e=-180),e>180&&(e=180);var f=a.getEast();f>180&&(f=180),f<-180&&(f=-180),b="&fq=geo_coords:["+c+","+e+" TO "+d+","+f+"]"}else console.log("bounds is not an object"),b="&fq=geo_coords:[-90,-180 TO 90, 180]";return b}function geohashLevel(a,b){var c;if("geohash"===b)switch(a){case 1:case 2:c="geohash_1";break;case 3:case 4:case 5:c="geohash_2";break;case 6:case 7:c="geohash_3";break;case 8:case 9:c="geohash_4";break;case 10:case 11:c="geohash_5";break;case 12:case 13:case 14:c="geohash_6";break;default:c="geohash_7"}return c}function updatePieChart(a,b){if(b){$("#pie-chart-header").empty();var c=400+10*b.length;d3.select("#pie-chart-area svg").attr("width","100%").attr("height",c+"px").style({width:"100%",height:c+"px"}),nv.addGraph(function(){var a=nv.models.pieChart().x(function(a){return a.label.capitalizeFirstLetter()}).y(function(a){return a.value}).color(function(a){return a.color}).showLabels(!0).labelThreshold(.05).labelType("percent").donut(!0).donutRatio(.5).growOnHover(!1);return a.legend.vers("classic").rightAlign(!1).maxKeyLength(23).margin({left:0,right:0}).width(380).padding(20),"Species"===legend.options.summarizeBy&&(a.legend.applyClass("nv-legend-text-italics"),a.tooltip.applyClass("nv-legend-text-italics")),a.tooltip.valueFormatter(function(a,b){return a.roundDecimals(0)}),d3.select("#pie-chart-area svg").datum(b).transition().duration(delay).call(a),a})}}function updateTable(a,b,c){"use strict";var d=a+"-header";$(d).empty();var e,f=viewMode+"Table?",g=solrPopbioUrl+f+qryUrl+b+"&sort=id asc&json.wrf=?&callback=?",h=g+"&cursorMark=*",i="*";PaneSpin("marker-table","start");$(".marker-row").fadeOut(),$("#marker-table").infiniteScrollHelper("destroy"),$.getJSON(h).done(function(b){if(b.response.numFound&&b.response.numFound>0){var c=b.response.docs;e=b.nextCursorMark,h=g+"&cursorMark="+e,setTimeout(function(){$(a).empty(),tableHtml(a,c),PaneSpin("marker-table","stop")},delay)}setTimeout(function(){$("#marker-table").infiniteScrollHelper({bottomBuffer:80,loadMore:function(b,c){PaneSpin("marker-table","start"),$.getJSON(h).done(function(b){if(b.response.numFound&&b.response.numFound>0){var d=b.response.docs;i=e,e=b.nextCursorMark,h=g+"&cursorMark="+e,tableHtml(a,d),PaneSpin("marker-table","stop")}c()}).fail(function(){PaneSpin("marker-table","stop"),console.log("Failed while loading smplTable"),c()})}})},delay)}).fail(function(){PaneSpin("marker-table","stop"),console.log("Failed while loading smplTable")})}function tableHtml(a,b){b.forEach(function(b){var c,d=b.collection_date_range;if(d&&d.length>0){var e=d[0];if(/TO/.test(e)){var f=/\[(\S+)\sTO\s(\S+)\]/,g=f.exec(e),h=g[1],i=g[2];c=dateResolution(h)+" to "+dateResolution(i)}else if(/^\d{4}(?:-\d{2})?$/.test(e))c=dateResolution(e);else{var j=new Date(e);c=j.toDateString()}}var k,l=b.species_category?b.species_category[0]:"Unknown";if("Species"===glbSummarizeBy)k=legend.options.palette[l];else{var m=mapSummarizeByToField(glbSummarizeBy).field,n=b[m];k=n?"object"==typeof n?legend.options.palette[n[0]]:legend.options.palette[n]:legend.options.palette.Unknown}var o,p;switch(viewMode){case"ir":o={accession:b.accession,accessionType:"Stable ID",bundleName:b.bundle_name,url:b.url,sampleType:b.sample_type,sampleTypeType:"Sample type",geoCoords:b.geo_coords,geolocation:b.geolocations[0],geolocationType:"Geography",species:l,speciesType:"Taxonomy",bgColor:k,textColor:getContrastYIQ(k),collectionDate:c,projects:borderColor("Project",b.projects),projectsType:"Projects",collectionProtocols:borderColor("Collection protocol",b.collection_protocols),collectionProtocolsType:"Collection protocols",protocols:borderColor("Protocol",b.protocols),protocolsType:"Protocols",phenotypeValue:b.phenotype_value_f,phenotypeValueType:b.phenotype_value_type_s,phenotypeValueUnit:b.phenotype_value_unit_s,insecticide:b.insecticide_s,insecticideType:"Insecticides",sampleSize:b.sample_size_i,concentration:b.concentration_f,concentrationUnit:b.concentration_unit_s,duration:b.duration_f,durationUnit:b.duration_unit_s},p=$.templates("#irRowTemplate");break;case"abnd":o={accession:b.accession,accessionType:"Stable ID",bundleName:b.bundle_name,url:b.url,sampleType:b.sample_type,sampleTypeType:"Sample type",geoCoords:b.geo_coords,geolocation:b.geolocations[0],geolocationType:"Geography",species:l,speciesType:"Taxonomy",bgColor:k,textColor:getContrastYIQ(k),collectionDate:c,projects:borderColor("Project",b.projects),projectsType:"Projects",collectionProtocols:borderColor("Collection protocol",b.collection_protocols),collectionProtocolsType:"Collection protocols",protocols:borderColor("Protocol",b.protocols),protocolsType:"Protocols",sampleSize:b.sample_size_i,collectionDuration:b.collection_duration_days_i},o.smplAvgAbnd=o.sampleSize/o.collectionDuration,p=$.templates("#abndRowTemplate");break;case"geno":o={accession:b.accession,accessionType:"Stable ID",bundleName:b.bundle_name,url:b.url,sampleType:b.sample_type,sampleTypeType:"Sample type",geoCoords:b.geo_coords,geolocation:b.geolocations[0],geolocationType:"Geography",species:l,speciesType:"Taxonomy",bgColor:k,textColor:getContrastYIQ(k),collectionDate:c,projects:borderColor("Project",b.projects),projectsType:"Projects",collectionProtocols:borderColor("Collection protocol",b.collection_protocols),collectionProtocolsType:"Collection protocols",protocols:borderColor("Protocol",b.protocols),protocolsType:"Protocols",sampleSize:b.sample_size_i,label:b.label,genotypeName:b.genotype_name_s,mutatedProteinValue:b.genotype_mutated_protein_value_f,mutatedProteinUnit:b.genotype_mutated_protein_unit_s},o.alleleCount=(b.sample_size_i*b.genotype_mutated_protein_value_f/50).roundDecimals(0),p=$.templates("#genoRowTemplate");break;default:o={accession:b.accession,accessionType:"Stable ID",bundleName:b.bundle_name,url:b.url,sampleType:b.sample_type,sampleTypeType:"Sample type",geoCoords:b.geo_coords,geolocation:b.geolocations[0],geolocationType:"Geography",species:l,speciesType:"Taxonomy",bgColor:k,textColor:getContrastYIQ(k),collectionDate:c,projects:borderColor("Project",b.projects),projectsType:"Projects",collectionProtocols:borderColor("Collection protocol",b.collection_protocols),collectionProtocolsType:"Collection protocols",protocols:borderColor("Protocol",b.protocols),protocolsType:"Protocols",sampleSize:b.sample_size_i},p=$.templates("#smplRowTemplate")}var q=p.render(o);$(a).append(q),$(".marker-row").fadeIn()})}function filterMarkers(a,b){"use strict";if(0===a.length)return qryUrl="q=*:*",void loadSolr({clear:1,zoomLevel:map.getZoom(),flyTo:b});var c={};a.forEach(function(a){if(c.hasOwnProperty(a.type)||(c[a.type]=[]),"Date"===a.type){var b="YYYY-MM-DD",d=dateConvert(a.dateEnd,b),e=dateConvert(a.dateStart,b);return void c[a.type].push({field:a.field,value:"["+e+" TO "+d+"]"})}if("Seasonal"!==a.type)return"Norm-IR"===a.type?void c[a.type].push({field:a.field,value:"["+a.normIrValues+"]"}):void("exact"==a.qtype?c[a.type].push({field:a.field,value:'"'+a.value+'"'}):/^".+"$/.test(a.value)?c[a.type].push({field:a.field,value:a.value}):c[a.type].push({field:a.field,value:"*"+a.value+"*"}));for(var f=0;f<a.ranges.length;f++){var g=a.ranges[f];c[a.type].push({field:a.field,value:"["+g+"]"})}});var d=0;qryUrl="q=(";var e=Object.keys(c).length;for(var f in c){var g={},h=0,i=c[f];i.sort(function(a,b){return a.field<b.field?-1:a.field>b.field?1:0}).forEach(function(a,b){g[a.field]?g[a.field]+=" OR "+a.value:g[a.field]=a.value});var j=Object.keys(g).length;if(d<e-1)if(h<j-1)if("Anywhere"===f)qryUrl+="text:("+g.anywhere+") AND ";else{qryUrl+="(";for(var k in g)qryUrl+=k+":("+g[k]+")",h!==j-1?(qryUrl+=" OR ",h++):qryUrl+=") AND "}else if("Anywhere"===f)qryUrl+="text:("+g.anywhere+") AND ";else for(var k in g)qryUrl+=k+":("+g[k]+")",h!==j-1?(qryUrl+=" OR ",h++):qryUrl+=" AND ";else{if(h<j-1)if("Anywhere"===f);else{qryUrl+="(";for(var k in g)qryUrl+=k+":("+g[k]+")",h!==j-1?(qryUrl+=" OR ",h++):qryUrl+=")"}else if("Anywhere"===f)qryUrl+="text:("+g.anywhere+"))";else for(var k in g)qryUrl+=k+":("+g[k]+"))";h++}d++}qryUrl=encodeURI(qryUrl),loadSolr({clear:1,zoomLevel:map.getZoom(),flyTo:b})}function borderColor(a,b){var c=[];if(!b)return c.push({name:"Unknown",brdColor:a===glbSummarizeBy?legend.options.palette.Unknown:""}),c;for(var d=0;d<b.length;d++){var e=b[d];c.push({name:e,brdColor:a===glbSummarizeBy?legend.options.palette[e]:""})}return c}function mapTypeToField(a){switch(a){case"Taxonomy":return"species_cvterms";case"Title":return"label";case"Sample type":return"sample_type";case"Geography":return"geolocations_cvterms";case"Collection protocols":return"collection_protocols_cvterms";case"Protocols":return"protocols_cvterms";case"Collection ID":return"collection_assay_id_s";case"Insecticides":return"insecticide_cvterms";case"Alleles":return"genotype_name_s";case"Collection date":return"collection_date_range";case"Normalised IR":return"phenotype_rescaled_value_f";case"Projects":return"projects";case"Authors":return"project_authors_txt";case"Project titles":return"project_titles_txt";default:return a.toLowerCase()}}function mapSummarizeByToField(a){var b={};switch(a){case"Species":b.summarize="species_category",b.type="Taxonomy",b.field="species_category";break;case"Sample type":b.summarize="sample_type",b.type="Sample type",b.field="sample_type";break;case"Collection protocol":b.summarize="collection_protocols_category",b.type="Collection protocols",b.field="collection_protocols";break;case"Protocol":b.summarize="protocols_category",b.type="Protocols",b.field="protocols";break;case"Insecticide":b.summarize="insecticide_s",b.type="Insecticides",b.field="insecticide_s";break;case"Allele":b.summarize="genotype_name_s",b.type="Alleles",b.field="genotype_name_s";break;case"Project":b.summarize="projects_category",b.type="Projects",b.field="projects";break;default:b.summarize="species_category",b.type="Taxonomy",b.field="species_category"}return b}function mapTypeToLabel(a){switch(a){case"Taxonomy":return"label label-primary";case"Geography":return"label label-primary";case"Title":return"label label-success";case"Description":return"label label-success";case"Projects":return"label label-success";case"Project titles":return"label label-success";case"Anywhere":return"label label-default";case"Pubmed references":return"label label-success";case"Insecticides":return"label label-success";case"Alleles":return"label label-success";case"Collection protocols":return"label label-success";case"Date":return"label label-info";case"Seasonal":return"label label-info";case"Norm-IR":return"label label-secondary";case"Collection ID":return"label label-warning";case"Sample":return"label label-warning";case"Sample type":return"label label-warning";case"Protocols":return"label label-warning";case"Authors":return"label label-success";case"Coordinates":return"label label-success";default:return"label label-warning"}}function mapTypeToIcon(a){switch(a){case"Taxonomy":return"fa-sitemap";case"Geography":return"fa-map-marker";case"Title":return"fa-tag";case"Description":return"fa-info-circle";case"Projects":return"fa-database";case"Project titles":return"fa-database";case"Anywhere":return"fa-search";case"Pubmed references":return"fa-book";case"Insecticides":return"fa-eyedropper";case"Collection protocols":return"fa-shopping-cart";case"Date":return"fa-calendar";case"Seasonal":return"fa-calendar-check-o";case"Norm-IR":return"fa-bolt";case"Collection ID":return"fa-tag";case"Sample":return"fa-map-pin";case"Sample type":return"fa-file-o";case"Protocols":return"fa-sort-amount-desc";case"Authors":return"fa-user";case"Coordinates":return"fa-map-marker";case"Location":return"fa-location-arrow";case"Insecticide":return"fa-eyedropper";case"Alleles":return"fa-eyedropper";case"Protocols":return"fa-sort-amount-desc";case"Concentration":return"fa-tachometer";case"Duration":return"fa-clock-o";case"Phenotype":return"fa-eye";case"Count":return"fa-hashtag";default:return"fa-search"}}function PaneSpin(a,b){var c=document.getElementById(a);"start"===b?null==PaneSpinner?PaneSpinner=(new Spinner).spin(c):PaneSpinner.spin(c):PaneSpinner.stop(c)}function highlightMarker(a){$(a._icon).addClass("highlight-marker"),firstClick&&(firstClick=!1)}function moveTopMarker(a){$(a._icon).addClass("top-marker")}function removeTopMarker(a){$(a._icon).removeClass("top-marker")}function removeHighlight(a){$(".highlight-marker").removeClass("highlight-marker")}function resetPlots(){"use strict";var a,b,c;firstClick?(a='<h3>Summary view for selected samples</h3><div id="pie-chart-header" style="text-align: center; margin-top: 30px"><i class="fa fa-pie-chart" style="color: #2C699E; font-size: 12em"></i><h1>Go on!</h1><h4>click a marker on the map</h4><h4>to plot some real data</h4> </div><div id="pie-chart-area"><svg></svg></div>',b='<div style="text-align: center; margin-top: 30px"><i class="fa fa-area-chart" style="color: #2C699E; font-size: 12em"></i><h1>Go on!</h1><h4>click a marker on the map</h4><h4>to plot some real data</h4> </div>',c='<div style="text-align: center; margin-top: 30px"><i class="fa fa-table" style="color: #2C699E; font-size: 12em"></i><h1>Go on!</h1><h4>click a marker on the map</h4><h4>to see some real data</h4> </div>'):(a='<h3>Summary view for selected samples</h3><div id="pie-chart-header" style="text-align: center; margin-top: 30px"><i class="fa fa-pie-chart" style="color: #2C699E; font-size: 12em"></i><h4>click a marker on the map</h4></div><div id="pie-chart-area"><svg></svg></div>',b='<div style="text-align: center; margin-top: 30px"><i class="fa fa-area-chart" style="color: #2C699E; font-size: 12em"></i><h4>click a marker on the map</h4></div>',c='<div style="text-align: center; margin-top: 30px"><i class="fa fa-table" style="color: #2C699E; font-size: 12em"></i><h4>click a marker on the map</h4></div>'),$("#graphs").html(a),$("#swarm-chart-area").html(b),$("#marker-table").off("scroll"),$("#table-contents-header").html(c),$("#table-contents").empty()}function getContrastYIQ(a){a=a.replace(/#/,"");var b=parseInt(a.substr(0,2),16),c=parseInt(a.substr(2,2),16),d=parseInt(a.substr(4,2),16),e=(299*b+587*c+114*d)/1e3;return e>=200?"#000000":"#ffffff"}function constructSeasonal(a){for(var b,c,d="YYYY-MM",e="MMM",f=[],g=[],h=!1,i=new Date(1600,0,1),j=new Date(1600,0,1),k=1;k<13;k++){var l=a[k];l?(h?j.setMonth(k-1):(i.setMonth(k-1),j.setMonth(k-1),h=!0),12===k&&(b=dateConvert(i,d)+" TO "+dateConvert(j,d),f.push(b),c=i.getTime()===j.getTime()?dateConvert(i,e):dateConvert(i,e)+"-"+dateConvert(j,e),g.push(c),h=!1)):h&&(b=dateConvert(i,d)+" TO "+dateConvert(j,d),f.push(b),c=i.getTime()===j.getTime()?dateConvert(i,e):dateConvert(i,e)+"-"+dateConvert(j,e),g.push(c),h=!1)}return{ranges:f,rangesText:g}}function constructIrNorm(a,b){return{}}function dateResolution(a){var b=/^([\+-]?\d{4}(?!\d{2}\b))((-?)((0[1-9]|1[0-2])(\3([12]\d|0[1-9]|3[01]))?|W([0-4]\d|5[0-2])(-?[1-7])?|(00[1-9]|0[1-9]\d|[12]\d{2}|3([0-5]\d|6[1-6])))([T\s]((([01]\d|2[0-3])((:?)[0-5]\d)?|24\:?00)([\.,]\d+(?!:))?)?(\17[0-5]\d([\.,]\d+)?)?([zZ]|([\+-])([01]\d|2[0-3]):?([0-5]\d)?)?)?)?$/g,c=b.exec(a),d=c[1],e=c[5],f=c[7],g=new Date(a);if("undefined"!=typeof f)return g.toDateString();if("undefined"!=typeof e){var h="MMM YYYY";return dateConvert(g,h)}if("undefined"!=typeof d){var h="YYYY";return dateConvert(g,h)}return!1}function setDateRange(a,b,c){var d=new Date,e=new Date(Date.UTC(d.getUTCFullYear(),d.getUTCMonth(),d.getUTCDate()));d.setUTCFullYear(d.getUTCFullYear()-c);var f=new Date(Date.UTC(d.getUTCFullYear(),0,1));
$(a).datepicker("setUTCDate",f),$(b).datepicker("setUTCDate",e)}function getRandom(a,b){return Math.random()*(b-a+1)+a}function dateConvert(a,b){var c=a.getFullYear(),d=("0"+(a.getMonth()+1)).slice(-2),e=("0"+a.getDate()).slice(-2),f=(("0"+a.getHours()).slice(-2),("0"+a.getMinutes()).slice(-2),("0"+a.getSeconds()).slice(-2),a.getDay()),g=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],h=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],i="";switch(b){case"YYYY-MM-DD":i=c+"-"+d+"-"+e;break;case"YYYY-MM":i=c+"-"+d;break;case"MMM YYYY":i=g[parseInt(d)-1]+" "+c;break;case"YYYY-MMM-DD DDD":i=c+"-"+g[parseInt(d)-1]+"-"+e+" "+h[parseInt(f)];break;case"MMM":i=g[parseInt(d)-1];break;case"YYYY":i=c}return i}L.Control.MapLegend=L.Control.extend({options:{position:"bottomright",numberOfColors:20,summarizeBy:"Species",sortBy:"Name",lum:.7,trafficlight:{colorBrewer:L.ColorBrewer.Diverging.RdYlBu[10].slice()},palette:{}},initialize:function(a){this._legendDiv={},this.addLegendIcon(a)},addLegendIcon:function(a){return this._legendDiv=L.DomUtil.create("div","info legend active"),legendDiv=this._legendDiv,L.easyButton("fa-info",function(){L.DomUtil.hasClass(legendDiv,"active")?(legend.remove(),L.DomUtil.removeClass(legendDiv,"active")):(legend.addTo(map),L.DomUtil.addClass(legendDiv,"active"))},"Toggle legend ON of OFF"),L.DomEvent.addListener(legendDiv,"click",this._clicked,this),legendDiv},bindTableFilter:function(){$("#Filter-Terms").keyup(function(){var a=$.trim($(this).val()).replace(/ +/g," ").toLowerCase();$(".table-legend-term").show().filter(function(){var b=$(this).text().replace(/\s+/g," ").toLowerCase();return!~b.indexOf(a)}).hide()})},markerColor:function(a){var b,c,d=this.options;return a<0?["white","#555"]:(b=d.trafficlight.scale.evaluate(a),c=getContrastYIQ(b),[b,c])},generatePalette:function(a){for(var b=this.options,c={},d=["#FFB300","#803E75","#FF6800","#A6BDD7","#C10020","#CEA262","#007D34","#F6768E","#00538A","#FF7A5C","#53377A","#FF8E00","#B32851","#F4C800","#7F180D","#93AA00","#593315","#F13A13","#232C16"],e=a.length,f=e,g=!1,h=0;h<f&&h!==b.numberOfColors;h++){var i=a[h][0];"no data"!==i?(c[i]=d[h],e--):g=!0}g&&(c["no data"]="#000000",e--);var j=.5/e;this.lum=.7;for(var k=0;k<e;k++){var l=f-e+k,i=a[l][0];c[i]=this._colorLuminance("#FFFFFF",-this.lum),this.lum-=j}return c},_sortHashByValue:function(a){var b=[];for(var c in a)a.hasOwnProperty(c)&&b.push([c,a[c]]);return b.sort(function(a,b){return b[1]-a[1]}),b},_Color:function(a){this.hex=a},_constructColor:function(a){var b=a.hex.substring(1),c=parseInt(b.substring(0,2),16)/255,d=parseInt(b.substring(2,4),16)/255,e=parseInt(b.substring(4,6),16)/255,f=Math.max.apply(Math,[c,d,e]),g=Math.min.apply(Math,[c,d,e]),h=f-g,i=0,j=f,k=0;return j>0&&(k=h/j,k>0&&(c==f?(i=60*((d-g-(e-g))/h),i<0&&(i+=360)):d==f?i=120+60*((e-g-(c-g))/h):e==f&&(i=240+60*((c-g-(d-g))/h)))),a.chroma=h,a.hue=i,a.sat=k,a.val=j,a.luma=.3*c+.59*d+.11*e,a.red=parseInt(b.substring(0,2),16),a.green=parseInt(b.substring(2,4),16),a.blue=parseInt(b.substring(4,6),16),a},_sortColorsByHue:function(a){var b=[],c={};for(var d in a)a.hasOwnProperty(d)&&b.push([d,a[d]]);b.sort(function(a,b){return a=a[1],b=b[1],b.hue-a.hue});for(var e=0;e<b.length;e++){var f=b[e][0],g=b[e][1];c[f]=g.hex}return c},_colorLuminance:function(a,b){"use strict";a=String(a).replace(/[^0-9a-f]/gi,""),a.length<6&&(a=a[0]+a[0]+a[1]+a[1]+a[2]+a[2]),b=b||0;var c,d,e="#";for(d=0;d<3;d++)c=parseInt(a.substr(2*d,2),16),c=Math.round(Math.min(Math.max(0,c+c*b),255)).toString(16),e+=("00"+c).substr(c.length);return e},_outputNames:function(a,b){var c=[],d=1,e=!1;for(var f in a)if(a.hasOwnProperty(f)){if("no data"===f){e=!0;continue}if(b>0&&d===b)break;var g=a[f];c.push({name:f,color:g}),d++}var h=_.sortBy(c,function(a){return a.name.toLowerCase()}),i=[];return h.forEach(function(a,b){i[a.name]=a.color}),e&&(i["no data"]="#000000"),i},_outputColors:function(a,b){var c={},d=1,e=!1;for(var f in a)if(a.hasOwnProperty(f)){if("no data"===f){e=!0;continue}if(b>0&&d===b)break;var g=new this._Color(a[f]);c[f]=this._constructColor(g),d++}if(e){var g=new this._Color("#000000");c["no data"]=this._constructColor(g)}return this._sortColorsByHue(c)},_generateTableHtml:function(a){var b=this.options,c="",d="";d="Name"===b.sortBy?'<i class = "fa fa-sort-alpha-asc sort-by"></i>':'<i class="sort-by" style="background:radial-gradient(#4D4D4D, #CCCCCC);"></i><i class = "fa fa-sort-amount-desc sort-by"></i>';var e='<div class="btn-group dropdown" id="summByDropdown" role="group" ><button class="btn btn-default dropdown-toggle" type="button"  data-toggle="dropdown" aria-haspopup="true" aria-expanded="true">'+glbSummarizeBy+' <span class="caret"></span> </button > <ul class = "dropdown-menu" aria-labelledby="summByDropdown"> '+("geno"===viewMode?'<li><a href="#" data-value="Allele">Allele</a></li> ':"")+'<li><a href="#" data-value="Species">Species</a></li> <li><a href="#" data-value="Sample type">Sample type</a></li> <li><a href="#" data-value="Collection protocol">Collection protocol</a></li> <li><a href="#" data-value="Project">Project </a></li> <li><a href="#" data-value="Protocol">Protocol</a></li> '+("ir"===viewMode?'<li><a href="#" data-value="Insecticide">Insecticide</a> </li> ':"")+'</div> <div class="btn-group dropdown" role="group" id="sortByDropdown" style="float: right;"><button class="btn btn-default dropdown-toggle" type="button"  data-toggle="dropdown" aria-haspopup="true" aria-expanded="true">'+d+'<span class="caret"></span> </button > <ul class = "dropdown-menu" aria-labelledby="sortByDropdown"> <li><a href="#" data-value="<i class=\'sort-by\' style=\'background:radial-gradient(#4d4d4d, #cccccc);\'></i><i class = \'fa fa-sort-amount-desc sort-by\'></i>">Color</a></li> <li><a href="#" data-value="<i class = \'fa fa-sort-alpha-asc sort-by\'></i>">Name</a></li></div>';$("#table-legend-controls").html(e);var f=mapSummarizeByToField(b.summarizeBy).type;for(var g in a)if(a.hasOwnProperty(g)){if("no data"===g)break;c+="Species"===b.summarizeBy?'<span class="active-legend table-legend-term" type="'+f+'" value="'+g+'"> <i style="border-color:'+a[g]+';" title="'+g.capitalizeFirstLetter()+'"></i> '+(g?"<em>"+g.capitalizeFirstLetter()+"</em><br>":"+"):'<span class="active-legend table-legend-term" type="'+f+'" value="'+g+'"> <i style="border-color:'+a[g]+';" title="'+g.capitalizeFirstLetter()+'"></i> '+(g?g.capitalizeFirstLetter()+"<br>":"+"),c+="</span>"}$("#Other-Terms-List").html(c).removeClass(),"Projects"===f?$("#Other-Terms-List").addClass("multiColumn-5"):$("#Other-Terms-List").addClass("multiColumn-3")},_generateLegendHtml:function(a,b){var c=this.options,d="",e=1,f="";f="Name"===c.sortBy?'<i class = "fa fa-sort-alpha-asc sort-by"></i>':'<i class="sort-by" style="background:radial-gradient(#4D4D4D, #CCCCCC);"></i><i class = "fa fa-sort-amount-desc sort-by"></i>';var g='<div class="btn-group dropdown" id="summByDropdown" role="group" ><button class="btn btn-default dropdown-toggle" type="button"  data-toggle="dropdown" aria-haspopup="true" aria-expanded="true">'+glbSummarizeBy+' <span class="caret"></span> </button > <ul class = "dropdown-menu dropdown-menu-right" aria-labelledby="summByDropdown"> '+("geno"===viewMode?'<li><a href="#" data-value="Allele">Allele</a></li> ':"")+'<li><a href="#" data-value="Species">Species</a></li> <li><a href="#" data-value="Sample type">Sample type</a></li> <li><a href="#" data-value="Collection protocol">Collection protocol</a></li> <li><a href="#" data-value="Project">Project </a></li> <li><a href="#" data-value="Protocol">Protocol</a></li> '+("ir"===viewMode?'<li><a href="#" data-value="Insecticide">Insecticide</a> </li> ':"")+'</div> <div class="btn-group dropdown" role="group" id="sortByDropdown" style="float: right;"><button class="btn btn-default dropdown-toggle" type="button"  data-toggle="dropdown" aria-haspopup="true" aria-expanded="true">'+f+'<span class="caret"></span> </button > <ul class = "dropdown-menu dropdown-menu-right" aria-labelledby="sortByDropdown"> <li><a href="#" data-value="<i class=\'sort-by\' style=\'background:radial-gradient(#4d4d4d, #cccccc);\'></i><i class = \'fa fa-sort-amount-desc sort-by\'></i>">Color</a></li> <li><a href="#" data-value="<i class = \'fa fa-sort-alpha-asc sort-by\'></i>">Name</a></li></div>';d+='<div style="border: 0; margin-bottom: 5px;">'+g+"</div>";var h=mapSummarizeByToField(c.summarizeBy).type;for(var i in a)if(a.hasOwnProperty(i)){if(e===c.numberOfColors+1)break;d+="Species"===c.summarizeBy?'<div class="active-legend detailedTip" type="'+h+'" value="'+i+'"> <i style="border-color:'+a[i]+';" title="'+i.capitalizeFirstLetter()+'"></i> '+(i?"<em>"+i.capitalizeFirstLetter()+"</em><br>":"+"):'<div class="active-legend detailedTip" type="'+h+'" value="'+i+'"> <i style="border-color:'+a[i]+';" title="'+i.capitalizeFirstLetter()+'"></i> '+(i?i.capitalizeFirstLetter()+"<br>":"+"),d+="</div>",e++}if(b>c.numberOfColors){var j="radial-gradient("+this._colorLuminance("#FFFFFF",-.7)+", "+this._colorLuminance("#FFFFFF",-this.lum)+")";d+='<div class="active-others detailedTip" data-toggle="modal" data-target="#Table-Legend-Modal" type="'+h+'"><i style="background:'+j+';"></i> Others<br></div>'}$("#legend").html(d);var k=c.trafficlight.colorBrewer;"ir"===viewMode&&(d+='<div class="data-layer-legend" style="border: 0">',d+='<p style="text-align: left">Resistance</p>',d+='<div id="legend-ir-scale-bar">',d+='<div class="min-value" style="border: 0">Low</div>',d+='<div class="scale-bars">',$.each(k.reverse(),function(a,b){d+='<i style="margin: 0; color: '+b+"; background: "+b+' ;"></i>'}),d+='</div></div><div class="max-value" style="border: 0;">High</div></div><p style="font-size: smaller; word-wrap: break-word; width: 100%; max-width: 190px; margin-top: 20px;">Values have been rescaled globally and only give a relative indication of resistance/susceptibility. <span class="active-others" data-toggle="modal" data-target="#ir-normalisation-help">More info</span></p>'),legend.onAdd=function(a){return this._legendDiv.innerHTML=d,this._legendDiv},L.DomUtil.hasClass(this._legendDiv,"active")&&(legend.remove(),legend.addTo(map))},refreshLegend:function(a){var b=this.options,c=[],d=_.size(a);c="Name"===b.sortBy?this._outputNames(a,b.numberOfColors):this._outputColors(a,b.numberOfColors),this._generateLegendHtml(c,d),c="Name"===b.sortBy?this._outputNames(a):this._outputColors(a),this._generateTableHtml(c,d)},_populateLegend:function(a,b,c){var d=this.options;"undefined"==typeof c&&(c=d.flyTo),b?d.summarizeBy=b:b=d.summarizeBy;var e=a.facets,f=e.geo.buckets;if("abnd"===viewMode)var g=0;var h=[];f.forEach(function(a){var b=a.terms.buckets,c=1,d=a.count;"abnd"===viewMode&&g<a.maxAbnd&&(g=a.maxAbnd),b.forEach(function(a){var b,e=a.count/d,f=a.val;switch(c){case 1:b=7*e;break;case 2:b=3*e;break;case 3:b=1*e;break;default:b=0}h.hasOwnProperty(f)?h[f]+=b:h[f]=b,c++})});var i=d.trafficlight;i.colorBrewer="ir"===viewMode?L.ColorBrewer.Diverging.RdYlBu[10].slice():L.ColorBrewer.Sequential.BuPu[9].slice(),"ir"===viewMode&&(i.scale=new L.CustomColorFunction(0,1,d.trafficlight.colorBrewer,{interpolate:!0}));var j=this._sortHashByValue(h);d.palette=this.generatePalette(j),this.refreshLegend(d.palette),filterMarkers($("#search_ac").tagsinput("items"),c)},_clicked:function(){map.off("click",PopulationBiologyMap.methods.resetMap)}}),L.control.legend=function(a,b){var c=new L.Control.MapLegend(b);return b.summarizeBy&&(c.options.summarizeBy=b.summarizeBy),c.options.numberOfColors=legendSpecies,c.options.flyTo=b.flyTo,c.bindTableFilter(),$.getJSON(a,function(a){c._populateLegend(a,b.summarizeBy)}),c},L.Icon.Canvas=L.Icon.extend({options:{iconSize:new L.Point(20,20),className:"leaflet-canvas-icon",population:0,stats:[]},createIcon:function(){var a=document.createElement("canvas");this._setIconStyles(a,"icon");var b=this.options.iconSize;this.options.population;return a.width=b.x,a.height=b.y,a.id=this.options.id,this.options.selected=markers.isSelected(this.options.id),this.draw(a.getContext("2d"),b.x,b.y),a},createShadow:function(){return null},draw:function(a,b,c){var d=this.options.iconSize.x,e=d/2,f=d/2.5,g=d/3,h=2*Math.PI,i=1.5*Math.PI,j=this.options.stats,k=this.options.markerText,l=this.options.count,m=this.options.atomic,n=this.options.selected;j.forEach(function(b){var c=b.value/l;b.label;if(c>0){a.beginPath(),a.moveTo(e,e),a.fillStyle=b.color;var d=i,f=i+c*h;f<d&&(d=i),a.arc(e,e,e,d,f),i+=c*h,a.lineTo(e,e),a.fill(),a.closePath()}}),a.beginPath(),a.fillStyle="white",a.arc(e,e,f,0,2*Math.PI),a.fill(),a.closePath();var o=legend.markerColor(this.options.trafficlight);if(a.beginPath(),a.fillStyle=o[0],a.arc(e,e,g,0,2*Math.PI),a.fill(),a.closePath(),a.fillStyle=o[1],a.textAlign="center",a.textBaseline="middle",a.font="bold 12px sans-serif",a.fillText(k,e,e,d),n){switch(a.beginPath(),a.fillStyle="rgba(255, 255, 255, 0.5)",a.arc(e,e,f,0,2*Math.PI),a.fill(),a.closePath(),a.textAlign="center",n){case"parent":a.fillStyle="grey";break;case"child":a.fillStyle="grey";break;default:a.fillStyle="rgb(0, 120, 215)"}a.font="18px FontAwesome",a.fillText("ï",e,e)}m&&(a.save(),a.translate(d-10,6),a.rotate(Math.PI/8),a.textAlign="center",a.font="14px FontAwesome",a.fillStyle="#595959",a.fillText("ï",0,0),a.restore())}}),L.PopbioMarkers=L.MarkerDataLayer.extend({initialize:function(a,b){L.MarkerDataLayer.prototype.initialize.call(this,a,b),this.initLatLngStorage()},initLatLngStorage:function(){this.storedMarkerCoords={}},saveLatLng:function(a){if(layer instanceof L.Marker){var b=a.options.icon.options.id;this.storedMarkerCoords[b]=a.getLatLng()}},startingLatLng:function(a){var b=a.options.icon.options.id;if(this.storedMarkerCoords[b])return this.storedMarkerCoords[b];for(var c=0,d=b.length;c<d;c++){var e=b.slice(0,d-c);if(this.storedMarkerCoords[e])return this.storedMarkerCoords[e]}var f=new RegExp("^"+b);for(var g in this.selectedMarkersIDs)if(this.selectedMarkersIDs.hasOwnProperty(g)){var h=this.selectedMarkersIDs[g];if(f.test(g)&&h)return this.selectedMarkersIDs[g]}return a.getLatLng()}}),L.Map.mergeOptions({selectArea:!0,maximumGridcells:64,tutorial:!1,tutorialDivId:!1,controlPanel:!1,controlPanelDivId:!1}),L.Map.SelectMarkers=L.Class.extend({initialize:function(a){this._map=a,this._container=a._container,this._pane=a._panes.overlayPane,this.selectedMarkersIDs={},this._selectedMarkers=L.featureGroup(),this.addHooks(),a.on("unload",this._destroy,this)},addHooks:function(){L.DomEvent.on(this._container,"mousedown",this._onMouseDown,this),this._selectedMarkers.on("layeradd",this._onLayerAdd)},removeHooks:function(){L.DomEvent.off(this._container,"mousedown",this._onMouseDown)},_onLayerAdd:function(a){},moved:function(){return this._moved},_destroy:function(){this.removeHooks(),L.DomUtil.remove(this._pane),delete this._pane},_resetState:function(){this._moved=!1},_onMouseDown:function(a){return!(!a.ctrlKey||1!==a.which&&1!==a.button)&&(map.dragging.disable(),this._resetState(),L.DomUtil.disableTextSelection(),L.DomUtil.disableImageDrag(),this._startPoint=this._map.mouseEventToContainerPoint(a),void L.DomEvent.on(document,{contextmenu:L.DomEvent.stop,mousemove:this._onMouseMove,mouseup:this._onMouseUp,keydown:this._onKeyDown},this))},_onMouseMove:function(a){this._moved||(this._moved=!0,this._box=L.DomUtil.create("div","leaflet-select-box",this._container),L.DomUtil.addClass(this._container,"leaflet-crosshair"),this._map.fire("boxselectstart")),this._point=this._map.mouseEventToContainerPoint(a);var b=new L.bounds(this._point,this._startPoint),c=b.getSize();L.DomUtil.setPosition(this._box,b.min),this._box.style.width=c.x+"px",this._box.style.height=c.y+"px"},_finish:function(){this._moved&&(L.DomUtil.remove(this._box),L.DomUtil.removeClass(this._container,"leaflet-crosshair")),L.DomUtil.enableTextSelection(),L.DomUtil.enableImageDrag(),L.DomEvent.off(document,{contextmenu:L.DomEvent.stop,mousemove:this._onMouseMove,mouseup:this._onMouseUp,keydown:this._onKeyDown},this),map.dragging.enable()},_onMouseUp:function(a){if((1===a.which||1===a.button)&&(this._finish(),this._moved)){setTimeout(L.Util.bind(this._resetState,this),0);var b=new L.LatLngBounds(this._map.containerPointToLatLng(this._startPoint),this._map.containerPointToLatLng(this._point));this._map.fire("boxselectend",{boxSelectBounds:b});var c=this;console.dir(b),geohashesGrid.eachLayer(function(a){a.hasOwnProperty("_bounds")&&b.overlaps(a._bounds)&&c.toggleGeohash(a,assetLayerGroup)});var d=this._map.getZoom(),e=geohashLevel(d,"geohash");("true"===urlParams.grid||$("#grid-toggle").prop("checked"))&&addGeohashes(map,e.slice(-1))}},_onKeyDown:function(a){27===a.keyCode&&this._finish()},getRandom:function(a,b){return Math.random()*(b-a+1)+a},toggleMarker:function(a,b){var c=a.options.icon.options.selected,d=a.options.icon.options.id,e=this;a._icon;b.removeLayer(a),c?(a.options.icon.options.selected=!1,e._selectedMarkers.removeLayer(a),e.selectedMarkersIDs[d]=!1):(a.options.icon.options.selected=!0,e._selectedMarkers.addLayer(a),e.selectedMarkersIDs[d]=!0),b.addLayer(a)},toggleGeohash:function(a,b){var c=a.options.selected,d=a.options.title,e=this;c?(a.options.selected=!1,e.selectedMarkersIDs[d]=!1):(a.options.selected=!0,e.selectedMarkersIDs[d]=!0)},isSelected:function(a){if(0===_.size(this.selectedMarkersIDs))return!1;if(this.selectedMarkersIDs[a])return"self";for(var b=0,c=a.length;b<c;b++){var d=a.slice(0,c-b);if(this.selectedMarkersIDs[d])return"child"}var e=new RegExp("^"+a);for(var f in this.selectedMarkersIDs)if(this.selectedMarkersIDs.hasOwnProperty(f)){var g=this.selectedMarkersIDs[f];if(e.test(f)&&g)return"parent"}return!1},clearMarkers:function(){}}),$.fn.redraw=function(){$(this).each(function(){this.offsetHeight})},String.prototype.capitalizeFirstLetter=function(){return this.charAt(0).toUpperCase()+this.slice(1)},Number.prototype.roundDecimals=function(a){return Number(Math.round(this.valueOf()+"e"+a)+"e-"+a)},String.prototype.truncString=function(a,b){return b=b||"...",this.length>a?this.substring(0,a)+b:this},function(a){var b=/([^&=]+)=?([^&]*)/g,c=function(a){return decodeURIComponent(a.replace(/\+/g," "))};a.parseParams=function(d){function e(b,c,d){if(c+="",c.indexOf(".")!==-1){var f=c.split("."),g=c.split(/\.(.+)?/)[1];b[f[0]]||(b[f[0]]={}),""!==g?e(b[f[0]],g,d):console.warn('parseParams :: empty property in key "'+c+'"')}else if(c.indexOf("[")!==-1){var f=c.split("[");c=f[0];var f=f[1].split("]"),h=f[0];""==h?(b||(b={}),b[c]&&a.isArray(b[c])||(b[c]=[]),b[c].push(d)):(b||(b={}),b[c]&&a.isArray(b[c])||(b[c]=[]),b[c][parseInt(h)]=d)}else b||(b={}),b[c]=d}d?d+="":d=window.location+"";var f,g={};if(d){if(d.indexOf("#")!==-1&&(d=d.substr(0,d.indexOf("#"))),d.indexOf("?")===-1)return{};if(d=d.substr(d.indexOf("?")+1,d.length),""==d)return{};for(;f=b.exec(d);){var h=c(f[1]),i=c(f[2]);e(g,h,i)}}return g}}(jQuery),function(a){a.encodeURL=function(b){function c(b,d){if(null===b)return"";if(a.isArray(b)){for(var e=0,f="",g=0;g<b.length;g++)e>0&&(f+="&"),f+=d+"[]="+b[g],e++;return f}if("object"==typeof b){var e=0,f="";for(var h in b)b.hasOwnProperty(h)&&(e>0&&(f+="&"),f+=c(b[h],d+"."+h),e++);return f}return d+"="+b}var d="?",e=0;for(var f in b)b.hasOwnProperty(f)&&(e>0&&(d+="&"),d+=c(b[f],f),e++);return d}}(jQuery),function(a){a.fn.has_scrollbar=function(){var a=this.get(0);if(a.scrollHeight>a.clientHeight)return!0}}(jQuery),function(a,b,c){a.data==c&&(a.data={}),a.data.highcharts={},a.methods==c&&(a.methods={}),a.methods.createAbundanceGraph=function(d,e){b("#swarm-plots h3").text("Population Abundance");var f=solrPopbioUrl+viewMode+"Projects?",g=f+qryUrl+e;a.data.filter=e,b.ajax({type:"GET",url:g,dataType:"json",success:function(b){a.data.projects_list=b.facet_counts.facet_fields.projects_category,a.data.result_count=b.response.numFound},error:function(){PaneSpin("swarm-plots","stop"),console.log("An error has occurred")}}).then(function(){a.data.highcharts=[];var f=solrPopbioUrl+viewMode+"Graphdata?",g="&term="+mapSummarizeByToField(glbSummarizeBy).summarize,h=f+qryUrl+g+e,i=5e4;a.data.result_count>i?b("#swarm-chart-area").html('<div style="text-align: center; margin-top: 30px"><i class="fa fa-area-chart" style="color: #C3312D; font-size: 12em"></i><h4>Too many points to plot</h4><h4>Apply filters to plot less data</h4><h4><b>Points</b>: '+a.data.result_count.toString()+"</h4><h4><b>Limit</b>: "+i.toString()+"</h4></div>"):(projects_list=a.data.projects_list,projects_list&&Object.keys(projects_list).length>1?(b("#projects-notice").show(),a.data.project_title=c):(b("#projects-notice").hide(),a.data.project_title="",a.data.project_id=Object.keys(projects_list)[0]),b.ajax({beforeSend:function(a){PaneSpin("swarm-plots","start"),b("#swarm-chart-area").empty(),b(d+" select").remove(),b(d+" label").remove(),a&&a.overrideMimeType&&a.overrideMimeType("application/json;charset-utf-8")},url:h,dataType:"json",success:function(b){var d=b.facets.term.buckets;a.data.project_title!=c?a.data.project_title=b.response.docs[0].project_titles_txt:a.data.project_title="",d.forEach(function(b){var c=legend.options.palette[b.val],d={name:b.val,marker:{symbol:"circle"},color:c,data:[]};collections_info=b.collection_dates.buckets,collections_info.forEach(function(a){var b=new Date(a.val).getTime(),c=a.collection.buckets;c.forEach(function(a){d.data.push([b,a.abnd])})}),a.data.highcharts.push(d)})},error:function(){PaneSpin("swarm-plots","stop"),console.log("An error has occurred")},complete:function(){var c=a.data.highcharts,d=a.data.project_title,e=a.data.project_id,f="<a href=/popbio/project?id="+e+">"+d+"</a>";a.methods.createStockchart(c,f),b(".highcharts-title").tooltip({placement:"bottom",title:d}),PaneSpin("swarm-plots","stop")}}))})},a.init=function(){},a.methods.createStockchart=function(a,c){b("#swarm-chart-area").highcharts("StockChart",{rangeSelector:{enabled:!1},legend:{enabled:!0,labelFormat:"<i>{name}</i>"},title:{useHTML:!0,text:c},chart:{type:"scatter",height:"200%"},navigator:{series:{data:[]},height:20},series:a})},b(document).ready(function(){a.init()})}(window.PopulationBiologyMap=window.PopulationBiologyMap||{},jQuery),function(a,b,c){function d(a){switch(a){case"Projects":return"projectID";case"Anywhere":return"text";case"Collection protocols":return"collection_protocol";case"Taxonomy":return"species"}}a.extra={},a.data==c&&(a.data={}),a.methods==c&&(a.methods={}),a.methods.resetMap=function(){removeHighlight(),sidebar.close(),b(".collapse").collapse("hide"),setTimeout(function(){resetPlots()},delay)},a.methods.applyParameters=function(){var c=!1;"undefined"!=typeof urlParams.view&&null!==urlParams.view||b("#SelectView").selectpicker("val","smpl");for(var d in urlParams)if(urlParams.hasOwnProperty(d))switch(d){case"view":var e=urlParams[d];b("#SelectView").selectpicker("val",e),viewMode=e;break;case"collectionID":var f=urlParams[d];Array.isArray(f)?f.forEach(function(a){b("#search_ac").tagsinput("add",{value:a,activeTerm:!0,type:"Collection ID",field:mapTypeToField("Collection ID"),qtype:"exact"})}):b("#search_ac").tagsinput("add",{value:urlParams[d],activeTerm:!0,type:"Collection ID",field:mapTypeToField("Collection ID"),qtype:"exact"});break;case"projectID":var f=urlParams[d];Array.isArray(f)?f.forEach(function(a){b("#search_ac").tagsinput("add",{value:a,activeTerm:!0,type:"Projects",field:mapTypeToField("Projects"),qtype:"exact"})}):b("#search_ac").tagsinput("add",{value:urlParams[d],activeTerm:!0,type:"Projects",field:mapTypeToField("Projects"),qtype:"exact"});break;case"species":var f=urlParams[d];Array.isArray(f)?f.forEach(function(a){b("#search_ac").tagsinput("add",{value:a,activeTerm:!0,type:"Taxonomy",field:mapTypeToField("Taxonomy"),qtype:"exact"})}):b("#search_ac").tagsinput("add",{value:urlParams[d],activeTerm:!0,type:"Taxonomy",field:mapTypeToField("Taxonomy"),qtype:"exact"});break;case"collection_protocol":var f=urlParams[d];Array.isArray(f)?f.forEach(function(a){b("#search_ac").tagsinput("add",{value:a,activeTerm:!0,type:"Collection protocols",field:mapTypeToField("Collection protocols"),qtype:"exact"})}):b("#search_ac").tagsinput("add",{value:urlParams[d],activeTerm:!0,type:"Collection protocols",field:mapTypeToField("Collection protocols"),qtype:"exact"});break;case"text":var f=urlParams[d];Array.isArray(f)?f.forEach(function(a){b("#search_ac").tagsinput("add",{text:a,value:a,type:"Anywhere",field:mapTypeToField("Anywhere")})}):b("#search_ac").tagsinput("add",{text:urlParams[d],value:urlParams[d],type:"Anywhere",field:mapTypeToField("Anywhere")});break;case"markerID":highlightedId=urlParams[d];break;case"zoom_level":a.data.zoomLevel=urlParams[d];break;case"center":a.data.center=urlParams[d].split(",").map(Number);break;case"panelID":var g=urlParams[d];b(".sidebar-pane.active").removeClass("active"),b(".sidebar-icon.active").removeClass("active"),b('[id="#'+g+'"]').parent().addClass("active"),b("#"+g).addClass("active")}return updateExportFields(viewMode),c},a.extra.init=function(){new Clipboard("#generate-link"),b("#generate-link").click(function(){var a="view="+viewMode,e="&zoom_level="+map.getZoom(),f=map.getCenter(),g="&center="+f.lat.toString()+","+f.lng.toString(),h=b(".highlight-marker").attr("id"),i="",j="",k=window.location.origin+window.location.pathname+"?",l=b("#search_ac").tagsinput("items"),m={},n="";l.forEach(function(a){m[a.type]==c&&(m[a.type]=[]),m[a.type].push(a.value)}),b.each(m,function(a,b){b.length>1?b.forEach(function(b){n=n+d(a)+"[]="+b+"&"}):n=n+d(a)+"="+b[0]+"&"}),h!=c&&(i="&markerID="+h,j="&panelID="+b(".sidebar-pane.active").attr("id")),n=n+a+e+g+i+j,k+=n,b("#generate-link").attr("data-clipboard-text",k),b("#generate-link-msg").show()}),b("#generate-link").mousemove(function(){b("#generate-link-msg").fadeOut()}),b(document).on("mouseenter",".detailedTip",function(){var a=b(this);this.offsetWidth<this.scrollWidth&&!a.attr("title")&&(a.tooltip({title:a.text(),placement:"bottom"}),a.tooltip("show"))})},b(document).ready(function(){a.extra.init()})}(window.PopulationBiologyMap=window.PopulationBiologyMap||{},jQuery);