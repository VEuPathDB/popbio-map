/*! VectorBase Population Biology Map - v0.2.1 - 2016-04-13
* https://www.vectorbase.org/popbio/
* Copyright (c) 2016  */
function addGeohashes(a,b){function c(a,b){i.terms.push({term:a})}var d=a.getBounds(),e=d.getSouth(),f=d.getNorth(),g=d.getEast(),h=d.getWest();geohashesGrid&&a.removeLayer(geohashesGrid);var i={_type:"terms",terms:[]},j=geohash.bboxes(e,h,f,g,b);j.forEach(c);var k={recordsField:"terms",geohashField:"term",layerOptions:{fill:!1,clickable:!1,fillOpacity:0,opacity:.3,weight:1}};geohashesGrid=new L.GeohashDataLayer(i,k),a.addLayer(geohashesGrid)}function bindEvents(){"use strict";"ir"===urlParams.view?($("#SelectViewDropdown").find(".dropdown-menu li a").parents(".dropdown").find(".btn").html("<i class='fa fa-eye' id='view-icon'></i> Insecticide Resistance <span class=\"caret\"></span>"),$("#view-mode").val("ir")):($("#SelectViewDropdown").find(".dropdown-menu li a").parents(".dropdown").find(".btn").html("<i class='fa fa-eye' id='view-icon'></i> Samples <span class=\"caret\"></span>"),$("#view-mode").val("smpl")),$("#grid-toggle").change(function(){if($(this).prop("checked")){var a=geohashLevel(map.getZoom(),"geohash");addGeohashes(map,a.slice(-1))}else map.removeLayer(geohashesGrid)}),$("#advanced-options").on("show.bs.collapse",function(){$("#bars-icon").toggleClass("down")}).on("hide.bs.collapse",function(){$("#bars-icon").toggleClass("down")}),$("#daterange").on("hidden.bs.collapse",function(){$("#date-start").datepicker("clearDates"),$("#date-end").datepicker("clearDates"),$("#add-dates").prop("disabled",!0),$("#add-season").prop("disabled",!0)}),$("#seasonal").on("hidden.bs.collapse",function(){checkSeasonal()||$(".season-toggle").each(function(){$(this).prop("checked")&&$(this).bootstrapToggle("off")})}),$("#date-select, #SelectViewDropdown").click(function(){"true"==$("#seasonal").attr("aria-expanded")&&$("#seasonal").collapse("hide")}),$("#season-select, #SelectViewDropdown").click(function(){"true"==$("#daterange").attr("aria-expanded")&&$("#daterange").collapse("hide")}),$("#daterange").find(".input-daterange").datepicker({format:"dd/mm/yyyy",startView:2,todayBtn:"linked",autoclose:!0,todayHighlight:!0,endDate:"Date.now()"}),$(".season-toggle").change(function(){var a=!1;$(".season-toggle").each(function(){var b=$(this).val(),c=$(this).prop("checked");months[b]=c,c&&(a=!0)}),a?$("#add-season").prop("disabled",!1):$("#add-season").prop("disabled",!0)}),$("#add-season").click(function(){var a=constructSeasonal(months);checkSeasonal()?($("#search_ac").tagsinput("add",{value:a.rangesText.toString(),ranges:a.ranges,replace:!0,type:"Seasonal",field:"collection_season"}),$("#search_ac").tagsinput("remove",checkSeasonal())):$("#search_ac").tagsinput("add",{value:a.rangesText.toString(),ranges:a.ranges,replace:!1,type:"Seasonal",field:"collection_season"})}),$("#add-norm-ir").click(function(){var a={0:1,1:.9,2:.8,3:.7,4:.6,5:.4,6:.3,7:.2,8:.1,9:0},b=normIrSlider.bslider("getValue"),c=b[0],d=b[1],e="";console.log(c+" - "+d),$.each(colorBrewer.slice().reverse().slice(c,d+1),function(a,b){e+='<i style="margin: 0; border-radius: 0; border: 0; color: '+b+"; width: 6px; background-color: "+b+' ;">&nbsp &nbsp</i>'}),b=a[d]+" TO "+a[c],console.log(b),$("#search_ac").tagsinput("add",{value:b,html:e,normIrValues:b,type:"Norm-IR",field:"phenotype_rescaled_value_f"})}),$("#date-start").datepicker().on("changeDate",function(a){$("#add-dates").prop("disabled",!1)}),$("#add-dates").click(function(){var a,b=new Date($("#date-start").datepicker("getUTCDate")),c=new Date($("#date-end").datepicker("getUTCDate"));a=b.getTime()===c.getTime()?b.toLocaleDateString("en-GB"):b.toLocaleDateString("en-GB")+"-"+c.toLocaleDateString("en-GB"),$("#search_ac").tagsinput("add",{value:a,dateStart:b,dateEnd:c,type:"Date",field:"collection_date_range"})}),$(".date-shortcut").click(function(){console.log(this.value),setDateRange("#date-start","#date-end",this.value)}),$("#search_ac").on("itemAdded",function(a){a.item.replace||(removeHighlight(),sidebar.close(),setTimeout(function(){resetPlots()},delay),filterMarkers($("#search_ac").tagsinput("items")))}),$("#search_ac").on("itemRemoved",function(){checkSeasonal()||$(".season-toggle").each(function(){$(this).prop("checked")&&$(this).bootstrapToggle("off")}),removeHighlight(),sidebar.close(),setTimeout(function(){resetPlots()},delay),filterMarkers($("#search_ac").tagsinput("items"))})}function initializeMap(){"use strict";map=L.map("map",{center:[23.079,3.515],zoom:3,zoomControl:!1,worldCopyJump:!0}),map.spin(!0),map.addControl(new L.Control.FullScreen({position:"topright",forcePseudoFullscreen:!0})),map.addControl(new L.Control.ZoomMin({position:"topright"})),sidebar=L.control.sidebar("sidebar").addTo(map);var a=new L.tileLayer("http://{s}.mqcdn.com/tiles/1.0.0/map/{z}/{x}/{y}.png",{minZoom:2,maxZoom:15,subdomains:["otile1","otile2","otile3","otile4"],noWrap:0,attribution:'&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery © <a href="http://mapbox.com">Mapbox</a>'}),b=new L.tileLayer("http://{s}.mqcdn.com/tiles/1.0.0/sat/{z}/{x}/{y}.png",{minZoom:2,maxZoom:15,maxNativeZoom:11,subdomains:["otile1","otile2","otile3","otile4"],noWrap:0,attribution:"Portions Courtesy NASA/JPL-Caltech and U.S. Depart. of Agriculture, Farm Service Agency"}),c=new L.tileLayer("http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{minZoom:2,maxZoom:15,noWrap:0,attribution:'&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery © <a href="http://mapbox.com">Mapbox</a>'});map.addLayer(a),assetLayerGroup=new L.LayerGroup,assetLayerGroup.addTo(map);var d=new L.Control.Layers({"MapQuest-OSM":a,OpenStreetMap:c,"MapQuest Open Aerial":b});d.setPosition("topright"),d.addTo(map);var e=solrPopbioUrl+$("#view-mode").val()+"Palette?q=*&facet.pivot=geohash_2,species_category&json.wrf=?&callback=?";legend=new L.control.legend(e),null!==rectHighlight&&map.removeLayer(rectHighlight),rectHighlight=null,map.spin(!1)}function initializeSearch(){$("#reset-search").click(function(){$("#search_ac").tagsinput("removeAll"),$(".season-toggle").each(function(){$(this).prop("checked")&&$(this).bootstrapToggle("off")}),removeHighlight(),sidebar.close(),setTimeout(function(){resetPlots()},delay),filterMarkers("")});var a=new Bloodhound({datumTokenizer:Bloodhound.tokenizers.whitespace,queryTokenizer:Bloodhound.tokenizers.whitespace,limit:7,minLength:2,hint:!1,remote:{url:solrTaUrl+$("#view-mode").val()+"Ac?q=",ajax:{dataType:"jsonp",data:{wt:"json",rows:7},jsonp:"json.wrf"},replace:function(a,b){a=solrTaUrl+$("#view-mode").val()+"Ac?q=";var c=b.match(/([^@]+)@([^@]*)/);return null!=c?(partSearch=c[1],$("#world-toggle").prop("checked")?solrTaUrl+$("#view-mode").val()+"Acat?q="+encodeURI(c[1])+buildBbox(map.getBounds()):solrTaUrl+$("#view-mode").val()+"Acat?q="+encodeURI(c[1])):(partSearch=!1,$("#world-toggle").prop("checked")?a+encodeURI(b)+buildBbox(map.getBounds()):a+encodeURI(b))},filter:function(a){return partSearch?$.map(a.grouped.type.doclist.docs,function(a){return{value:partSearch,id:a.id,type:a.type,field:a.field,is_synonym:a.is_synonym,qtype:"partial"}}):$.map(a.grouped.textsuggest_category.doclist.docs,function(a){return{value:a.textsuggest_category,type:a.type,id:a.id,field:a.field,is_synonym:a.is_synonym,qtype:"exact"}})}}});a.initialize();var b=new Bloodhound({datumTokenizer:Bloodhound.tokenizers.whitespace,queryTokenizer:Bloodhound.tokenizers.whitespace,limit:10,minLength:3,remote:{url:solrTaUrl+$("#view-mode").val()+"Acgrouped?q=",ajax:{dataType:"jsonp",data:{wt:"json",rows:10},jsonp:"json.wrf"},replace:function(a,b){return a=solrTaUrl+$("#view-mode").val()+"Acgrouped?q=",$("#world-toggle").prop("checked")?a+encodeURI(b)+"*":a+encodeURI(b)+"*"+buildBbox(map.getBounds())},filter:function(a){a.grouped.stable_id.ngroups;return $.map(a.facet_counts.facet_fields.type,function(a){return a[1]>0?{count:a[1],type:a[0],field:mapTypeToField(a[0]),value:$("#search_ac").tagsinput("input")[0].value,qtype:"summary"}:void 0})}}});b.initialize(),$("#search_ac").tagsinput({tagClass:function(a){switch(a.type){case"Taxonomy":return"label label-primary fa fa-sitemap";case"Geography":return"label label-primary fa fa-map-marker";case"Title":return"label label-success fa fa-tag";case"Description":return"label label-success fa fa-info-circle";case"Projects":return"label label-success fa fa-database";case"Anywhere":return"label label-default fa fa-search";case"Pubmed references":return"label label-success fa fa-book";case"Insecticides":return"label label-success fa fa-eyedropper";case"Collection protocols":return"label label-success fa fa-shopping-cart";case"Date":return"label label-info fa fa-calendar";case"Seasonal":return"label label-info fa fa-calendar-check-o ";case"Norm-IR":return"label label-secondary fa fa-bolt";default:return"label label-warning fa fa-search"}},itemValue:"value",itemText:function(a){return" "+a.value},typeaheadjs:{options:{minLength:3,hint:!1,highlight:!1},datasets:[{name:"acSuggestions",displayKey:"value",source:a.ttAdapter(),templates:{empty:function(){var a;return a=$("#world-toggle").prop("checked")?"No suggestions found. Try enabling world search or hit enter to perform a free text search instead.":"No suggestions found. Hit Enter to perform a free text search instead.",['<span class="tt-suggestions" style="display: block;">','<div class="tt-suggestion">','<p style="white-space: normal;">',a,"</p>","</div>","</span>"].join("\n")},suggestion:function(a){return"<p>"+a.value+(a.is_synonym?' (<i class="fa fa-list-ul" title="Duplicate term / Synonym" style="cursor: pointer"></i>)':"")+" <em> in "+a.type+"</em></p>"}}},{name:"acOtherResults",displayKey:"value",source:b.ttAdapter(),templates:{header:'<h4 class="more-results">More suggestions</h4>',suggestion:function(a){return"<p>~"+a.count+" <em>in "+a.type+"</em></p>"}}}]}}),$(".dropdown-menu li a").click(function(){$(this).parents(".dropdown").find(".btn").html($(this).data("value")+' <span class="caret"></span>'),$(this).parents(".dropdown").find(".btn").val($(this).data("value"));var c=$(this).text();"Samples"===c?$("#view-mode").val("smpl"):$("#view-mode").val("ir");var d=solrPopbioUrl+$("#view-mode").val()+"Palette?q=*&facet.pivot=geohash_2,species_category&json.wrf=?&callback=?";removeHighlight(),sidebar.close(),setTimeout(function(){resetPlots()},delay),$.getJSON(d,function(a){legend.populateLegend(a,"species_category")}),a.initialize(!0),b.initialize(!0)}),$("#SelectViewDropdown").find(".dropdown-menu li a").click(function(){var c=$(this).text();"Samples"===c?$("#view-mode").val("smpl"):$("#view-mode").val("ir");var d=solrPopbioUrl+$("#view-mode").val()+"Palette?q=*&facet.pivot=geohash_2,species_category&json.wrf=?&callback=?";removeHighlight(),sidebar.close(),setTimeout(function(){resetPlots()},delay),$.getJSON(d,function(a){legend.populateLegend(a,"species_category")}),a.initialize(!0),b.initialize(!0)})}function loadSolr(a){"use strict";var b=a.clear,c=a.zoomLevel,d=geohashLevel(c,"geohash");if(("true"===urlParams.grid||$("#grid-toggle").prop("checked"))&&addGeohashes(map,d.slice(-1)),c>11)return void loadSmall(1,c);var e=[],f=function(a){if($("#markersCount").html(a.response.numFound+" samples in current view"),0===a.response.numFound)return b&&assetLayerGroup.clearLayers(),null!==rectHighlight&&map.removeLayer(rectHighlight),rectHighlight=null,void map.spin(!1);var d,f,g,h,i=a.stats.stats_fields,j=a.facet_counts,k=$("#view-mode").val();switch(c){case 1:case 2:d=i.geo_coords_ll_0_coordinate.facets.geohash_1,f=i.geo_coords_ll_1_coordinate.facets.geohash_1,h="ir"===k?i.phenotype_rescaled_value_f.facets.geohash_1:null,g=j.facet_pivot["geohash_1,species_category"];break;case 3:case 4:case 5:d=i.geo_coords_ll_0_coordinate.facets.geohash_2,f=i.geo_coords_ll_1_coordinate.facets.geohash_2,h="ir"===k?i.phenotype_rescaled_value_f.facets.geohash_2:null,g=j.facet_pivot["geohash_2,species_category"];break;case 6:case 7:d=i.geo_coords_ll_0_coordinate.facets.geohash_3,f=i.geo_coords_ll_1_coordinate.facets.geohash_3,h="ir"===k?i.phenotype_rescaled_value_f.facets.geohash_3:null,g=j.facet_pivot["geohash_3,species_category"];break;case 8:case 9:d=i.geo_coords_ll_0_coordinate.facets.geohash_4,f=i.geo_coords_ll_1_coordinate.facets.geohash_4,h="ir"===k?i.phenotype_rescaled_value_f.facets.geohash_4:null,g=j.facet_pivot["geohash_4,species_category"];break;case 10:case 11:d=i.geo_coords_ll_0_coordinate.facets.geohash_5,f=i.geo_coords_ll_1_coordinate.facets.geohash_5,h="ir"===k?i.phenotype_rescaled_value_f.facets.geohash_5:null,g=j.facet_pivot["geohash_5,species_category"];break;default:d=i.geo_coords_ll_0_coordinate.facets.geohash_6,f=i.geo_coords_ll_1_coordinate.facets.geohash_6,h="ir"===k?i.phenotype_rescaled_value_f.facets.geohash_6:null,g=j.facet_pivot["geohash_6,species_category"]}smallClusters=[];var l=[],m=[],n=[];for(var o in d)if(d.hasOwnProperty(o)){var p=d[o].count;if(2>p){smallClusters.push(o);continue}g.forEach(function(a,b){l[a.value]=a.count;var c=[],d=[];a.pivot?a.pivot.forEach(function(a){var b=a.value,e=a.count;c[b]=e,d.push({label:b.replace(/sensu lato/,"sl").replace(/chromosomal form/,"cf"),value:e,color:palette[b]?palette[b]:"#000000"})}):console.log("ERROR: Pivot for element "+a.value+"appears to be empty"),m[a.value]=c,n[a.value]=d});var q={};q.term=o,q.count=d[o].count,q.latLng=[d[o].mean,f[o].mean],q.bounds=[[d[o].min,f[o].min],[d[o].max,f[o].max]],q.population=l[o],q.trafficlight="ir"===k?h[o].mean:-1,q.stats=m[o],q.fullstats=n[o],e.push(q)}var r={};r.terms=e;var s={recordsField:"terms",latitudeField:"latLng.0",longitudeField:"latLng.1",displayOptions:{count:{title:function(a){return a}}},layerOptions:{fill:!1,stroke:!1,weight:0,color:"#80FF00",dropShadow:!1},setIcon:function(a){var b=40;return new L.Icon.Canvas({iconSize:new L.Point(b,b),className:"marker-cluster",population:a.population,trafficlight:a.trafficlight,stats:a.stats})},onEachRecord:function(a,b){a.on("dblclick",function(){clearTimeout(timer),prevent=!0,map.fitBounds(b.bounds)}),a.on("click",function(){var c=!1;a===highlight&&(c=!0),removeHighlight(a),highlightMarker(a),timer=setTimeout(function(){if(!prevent){if(c)return removeHighlight(),sidebar.close(),void setTimeout(function(){resetPlots()},delay);$("#sidebar").hasClass("collapsed")&&("help"===$(".sidebar-pane.active").attr("id")?sidebar.open("graphs"):sidebar.open($(".sidebar-pane.active").attr("id"))),updatePieChart(b.population,b.fullstats);var a=L.latLngBounds(b.bounds);createBeeViolinPlot("#swarm-chart-area",buildBbox(a)),updateTable("#table-contents",buildBbox(a))}},delay),prevent=!1}),a.on("mouseover",function(){moveTopMarker(a);var c=L.latLngBounds(b.bounds);null!==rectHighlight&&map.removeLayer(rectHighlight),rectHighlight=L.rectangle(c,{color:"grey",weight:1,fill:!0,clickable:!1}).addTo(map)}),a.on("mouseout",function(){removeTopMarker(a),null!==rectHighlight&&map.removeLayer(rectHighlight),rectHighlight=null})}},t=new L.MarkerDataLayer(r,s);b?(assetLayerGroup.clearLayers(),assetLayerGroup.addLayer(t)):assetLayerGroup.addLayer(t),smallClusters.length>0&&loadSmall(0,c),null!==rectHighlight&&map.removeLayer(rectHighlight),rectHighlight=null,map.spin(!1)},g=solrPopbioUrl+$("#view-mode").val()+"Geoclust?"+qryUrl+buildBbox(map.getBounds())+"&stats.facet="+d+"&facet.pivot="+d+",species_category&json.wrf=?&callback=?";map.spin(!0),$.getJSON(g,f).fail(function(){console.log("Ahhh"),map.spin(!1)})}function checkSeasonal(){for(var a=$("#search_ac").tagsinput("items"),b=0;b<a.length;b++){var c=a[b];if("Seasonal"===c.type)return c.value}return!1}function loadSmall(a,b){"use strict";var c=new PruneClusterForLeaflet(120);c.BuildLeafletClusterIcon=function(a){var b=new L.Icon.MarkerCluster;return b.stats=a.stats,b.population=a.population,b.trafficlight=a.totalWeight/a.population,b},c.PrepareLeafletMarker=function(a,b,c){if(a.on("dblclick",function(){clearTimeout(timer),prevent=!0,map.getZoom()<11?map.setView(a._latlng,11,{animate:!0}):(removeHighlight(),sidebar.close(),setTimeout(function(){resetPlots()},delay))}),a.on("click",function(){var d=!1;a===highlight&&(d=!0),removeHighlight(a),highlightMarker(a),timer=setTimeout(function(){if(d)return removeHighlight(),sidebar.close(),void setTimeout(function(){resetPlots()},delay);if(!prevent){var a=[];a.push({label:c.replace(/sensu lato/,"sl").replace(/chromosomal form/,"cf"),value:1,color:palette[c]?palette[c]:"#000000"}),$("#sidebar").hasClass("collapsed")&&("help"===$(".sidebar-pane.active").attr("id")?sidebar.open("graphs"):sidebar.open($(".sidebar-pane.active").attr("id"))),updatePieChart(1,a);var e="&fq=id:"+b.id;createBeeViolinPlot("#swarm-chart-area",e),updateTable("#table-contents",e)}prevent=!1},delay)}),b.icon&&("function"==typeof b.icon?a.setIcon(b.icon(b,c)):a.setIcon(b.icon)),b.popup){var d="function"==typeof b.popup?b.popup(b,c):b.popup;a.getPopup()?a.setPopupContent(d,b.popupOptions):a.bindPopup(d,b.popupOptions)}},L.Icon.MarkerCluster=L.Icon.extend({options:{iconSize:new L.Point(40,40),className:"prunecluster leaflet-markercluster-icon"},createIcon:function(){var a=document.createElement("canvas");this._setIconStyles(a,"icon");var b=this.options.iconSize;return a.width=b.x,a.height=b.y,this.draw(a.getContext("2d"),b.x,b.y),a},createShadow:function(){return null},draw:function(a){var b=2*Math.PI,c=1.5*Math.PI,d=this.options.iconSize.x,e=d/2,f=d/2.5;for(var g in this.stats)if(this.stats.hasOwnProperty(g)){var h=this.stats[g]/this.population;if(h>0){a.beginPath(),a.moveTo(e,e),palette.hasOwnProperty(g)?a.fillStyle=palette[g]:a.fillStyle=palette.others;var i=c,j=c+h*b;i>j&&(i=c),a.arc(e,e,e,i,j),c+=h*b,a.lineTo(e,e),a.fill(),a.closePath()}}a.beginPath(),a.fillStyle="white",a.arc(e,e,f,0,2*Math.PI),a.fill(),a.closePath();var k=markerColor(this.trafficlight);"ir"===$("#view-mode").val()&&(a.beginPath(),a.fillStyle=k[0],a.arc(e,e,e-7,0,2*Math.PI),a.fill(),a.closePath()),a.fillStyle="ir"===$("#view-mode").val()?k[1]:"#555",a.textAlign="center",a.textBaseline="middle",a.font="bold 12px sans-serif",a.fillText(this.population,e,e,d)}}),c.BuildLeafletCluster=function(a,b){var d=new L.Marker(b,{icon:c.BuildLeafletClusterIcon(a)});return d.on("dblclick",function(){clearTimeout(timer),prevent=!0;var b=c.Cluster.FindMarkersInArea(a.bounds),e=c.Cluster.ComputeBounds(b);if(e){var f=new L.LatLngBounds(new L.LatLng(e.minLat,e.maxLng),new L.LatLng(e.maxLat,e.minLng)),g=c._map.getZoom(),h=c._map.getBoundsZoom(f,!1,new L.Point(20,20,null));h===g?(removeHighlight(),sidebar.close(),setTimeout(function(){resetPlots()},delay),c._map.fire("overlappingmarkers",{cluster:c,markers:b,center:d.getLatLng(),marker:d})):c._map.fitBounds(f)}}),d.on("click",function(){var b=!1;d===highlight&&(b=!0),removeHighlight(d),highlightMarker(d),timer=setTimeout(function(){if(!prevent){if(b)return removeHighlight(),sidebar.close(),void setTimeout(function(){resetPlots()},delay);var d=[],e=a.stats;for(var f in e)d.push({label:f.replace(/sensu lato/,"sl").replace(/chromosomal form/,"cf"),value:e[f],color:palette[f]?palette[f]:"#000000"});$("#sidebar").hasClass("collapsed")&&("help"===$(".sidebar-pane.active").attr("id")?sidebar.open("graphs"):sidebar.open($(".sidebar-pane.active").attr("id"))),updatePieChart(a.population,d);var g=c.Cluster.FindMarkersInArea(a.bounds),h=c.Cluster.ComputeBounds(g);if(h)var i=new L.LatLngBounds(new L.LatLng(h.minLat,h.maxLng),new L.LatLng(h.maxLat,h.minLng));createBeeViolinPlot("#swarm-chart-area",buildBbox(i)),updateTable("#table-contents",buildBbox(i))}},delay),prevent=!1}),d.on("mouseover",function(){moveTopMarker(d);var b=c.Cluster.FindMarkersInArea(a.bounds),e=c.Cluster.ComputeBounds(b);if(e)var f=new L.LatLngBounds(new L.LatLng(e.minLat,e.maxLng),new L.LatLng(e.maxLat,e.minLng));null!==rectHighlight&&map.removeLayer(rectHighlight),rectHighlight=L.rectangle(f,{color:"grey",weight:1,fill:!0,clickable:!1}).addTo(map)}),d.on("mouseout",function(){removeTopMarker(d),null!==rectHighlight&&map.removeLayer(rectHighlight),rectHighlight=null}),d};var d,e=geohashLevel(b,"geohash");if(0===a){d="(";for(var f=0;f<smallClusters.length;f++){if(f===smallClusters.length-1){d+=smallClusters[f];break}d+=smallClusters[f]+" "}d+=")"}else d="*";var g=function(b){var d=b.response.docs;for(var e in d)if(d.hasOwnProperty(e)){var f=d[e].geo_coords.split(","),g="ir"===$("#view-mode").val()?d[e].phenotype_rescaled_value_f:-1,h=new PruneCluster.Marker(f[0],f[1]);if(h.data.id=d[e].id,d[e].hasOwnProperty("species_category")){var i=d[e].species_category[0];h.category=d[e].species_category[0],h.weight=g,h.data.trafficlight=g}else console.log(e+": no species defined");h.data.icon=L.VectorMarkers.icon({prefix:"fa",icon:"circle",markerColor:palette[i]?palette[i]:"red",iconColor:markerColor(g)[0],extraClasses:"single-marker-icon"}),c.RegisterMarker(h)}a&&(assetLayerGroup.clearLayers(),$("#markersCount").html(b.response.numFound+" samples in current view")),assetLayerGroup.addLayer(c),null!==rectHighlight&&map.removeLayer(rectHighlight),rectHighlight=null,map.spin(!1)},h=solrPopbioUrl+$("#view-mode").val()+"Markers?"+qryUrl+"&fq="+e+":"+d+buildBbox(map.getBounds())+"&json.wrf=?&callback=?";map.spin(!0),$.getJSON(h,g)}function buildBbox(a){"use strict";var b;if(a.getEast()){var c=a.getSouth();-90>c&&(c=-90);var d=a.getNorth();d>90&&(d=90);var e=a.getWest();-180>e&&(e=-180),e>180&&(e=180);var f=a.getEast();f>180&&(f=180),-180>f&&(f=-180),b="&fq=geo_coords:["+c+","+e+" TO "+d+","+f+"]"}else b="&fq=geo_coords:[-90,-180 TO 90, 180]";return b}function geohashLevel(a,b){var c;if("geohash"===b)switch(a){case 1:case 2:c="geohash_1";break;case 3:case 4:case 5:c="geohash_2";break;case 6:case 7:c="geohash_3";break;case 8:case 9:c="geohash_4";break;case 10:case 11:c="geohash_5";break;default:c="geohash_6"}return c}function updatePieChart(a,b){b&&($("#pie-chart-header").empty(),d3.select("#pie-chart-area svg").attr("width","380px").attr("height","500px").style({width:"380px",height:"500px"}),nv.addGraph(function(){var a=nv.models.pieChart().x(function(a){return a.label}).y(function(a){return a.value}).color(function(a){return a.data.color}).showLabels(!0).labelThreshold(.05).labelType("percent").donut(!0).donutRatio(.5).growOnHover(!1);return d3.select("#pie-chart-area svg").datum(b).transition().duration(800).call(a),nv.utils.windowResize(a.update),a}))}function updateTable(a,b,c){"use strict";var d=a+"-header";if($(d).empty(),"smpl"===$("#view-mode").val())var e=solrPopbioUrl+"smplTable?&"+qryUrl+b+"&sort=id asc&json.wrf=?&callback=?";else var e=solrPopbioUrl+"irTable?&"+qryUrl+b+"&sort=id asc&json.wrf=?&callback=?";var f,g=e+"&cursorMark=*",h="*";PaneSpin("marker-table","start");$(a).empty(),$("#marker-table").infiniteScrollHelper("destroy"),$.getJSON(g).done(function(b){if(b.response.numFound&&b.response.numFound>0){var c=b.response.docs;f=b.nextCursorMark,g=e+"&cursorMark="+f,tableHtml(a,c)}PaneSpin("marker-table","stop");$("#marker-table").infiniteScrollHelper({bottomBuffer:80,loadMore:function(b,c){PaneSpin("marker-table","start"),$.getJSON(g).done(function(b){if(b.response.numFound&&b.response.numFound>0){var d=b.response.docs;h=f,f=b.nextCursorMark,g=e+"&cursorMark="+f,tableHtml(a,d)}PaneSpin("marker-table","stop"),c()}).fail(function(){PaneSpin("marker-table","stop"),console.log("Failed while loading smplTable"),c()})}})}).fail(function(){PaneSpin("marker-table","stop"),console.log("Failed while loading smplTable")})}function tableHtml(a,b){b.forEach(function(b){var c,d=b.collection_date_range;if(d&&d.length>0){var e=d[0];if(/TO/.test(e)){var f=/\[(\S+)\sTO\s(\S+)\]/,g=f.exec(e),h=g[1],i=g[2];c=dateResolution(h)+" to "+dateResolution(i)}else if(/^\d{4}$/.test(e))c=dateResolution(e);else{var j=new Date(e);c=j.toDateString()}}var k=b.species_category?b.species_category[0]:"Unknown";if("smpl"===$("#view-mode").val())var l={accession:b.accession,bundleName:b.bundle_name,url:b.url,sampleType:b.sample_type,geoCoords:b.geo_coords,geolocation:b.geolocations[0],species:k,bgColor:palette[k],textColor:getContrastYIQ(palette[k]),collectionDate:c,projects:b.projects,collectionProtocols:b.collection_protocols},m=$.templates("#smplRowTemplate");else var l={accession:b.accession,bundleName:b.bundle_name,url:b.url,sampleType:b.sample_type,geoCoords:b.geo_coords,geolocation:b.geolocations[0],species:k,bgColor:palette[k],textColor:getContrastYIQ(palette[k]),collectionDate:c,projects:b.projects,collectionProtocols:b.collection_protocols,protocols:b.protocols,phenotypeValue:b.phenotype_value_f,phenotypeValueType:b.phenotype_value_type_s,phenotypeValueUnit:b.phenotype_value_unit_s,insecticide:b.insecticide_s,sampleSize:b.sample_size_i,concentration:b.concentration_f,concentrationUnit:b.concentration_unit_s,duration:b.duration_f,durationUnit:b.duration_unit_s},m=$.templates("#irRowTemplate");var n=m.render(l);$(a).append(n)})}function colorLuminance(a,b){"use strict";a=String(a).replace(/[^0-9a-f]/gi,""),a.length<6&&(a=a[0]+a[0]+a[1]+a[1]+a[2]+a[2]),b=b||0;var c,d,e="#";for(d=0;3>d;d++)c=parseInt(a.substr(2*d,2),16),c=Math.round(Math.min(Math.max(0,c+c*b),255)).toString(16),e+=("00"+c).substr(c.length);return e}function filterMarkers(a){"use strict";if(0===a.length)return qryUrl="q=*",void loadSolr({clear:1,zoomLevel:map.getZoom()});var b={};a.forEach(function(a){if(b.hasOwnProperty(a.type)||(b[a.type]=[]),"Date"===a.type){var c="YYYY-MM-DD",d=dateConvert(a.dateEnd,c),e=dateConvert(a.dateStart,c);return void b[a.type].push({field:a.field,value:"["+e+" TO "+d+"]"})}if("Seasonal"!==a.type)return"Norm-IR"===a.type?void b[a.type].push({field:a.field,value:"["+a.normIrValues+"]"}):void("exact"==a.qtype?b[a.type].push({field:a.field,value:'"'+a.value+'"'}):b[a.type].push({field:a.field,value:"*"+a.value+"*"}));for(var f=0;f<a.ranges.length;f++){var g=a.ranges[f];b[a.type].push({field:a.field,value:"["+g+"]"})}});var c=0;qryUrl="q=(";var d=Object.keys(b).length;for(var e in b){var f={},g=0,h=b[e];h.sort(function(a,b){return a.field<b.field?-1:a.field>b.field?1:0}).forEach(function(a,b){f[a.field]?f[a.field]+=" OR "+a.value:f[a.field]=a.value});var i=Object.keys(f).length;if(d-1>c)if(i-1>g)if("Anywhere"===e)qryUrl+="("+f.anywhere+") AND ";else{qryUrl+="(";for(var j in f)qryUrl+=j+":("+f[j]+")",g!==i-1?(qryUrl+=" OR ",g++):qryUrl+=") AND "}else if("Anywhere"===e)qryUrl+="("+f.anywhere+") AND ";else for(var j in f)qryUrl+=j+":("+f[j]+")",g!==i-1?(qryUrl+=" OR ",g++):qryUrl+=" AND ";else{if(i-1>g)if("Anywhere"===e);else{qryUrl+="(";for(var j in f)qryUrl+=j+":("+f[j]+")",g!==i-1?(qryUrl+=" OR ",g++):qryUrl+="))"}else if("Anywhere"===e)qryUrl+="("+f.anywhere+"))";else for(var j in f)qryUrl+=j+":("+f[j]+"))";g++}c++}qryUrl=encodeURI(qryUrl),loadSolr({clear:1,zoomLevel:map.getZoom()})}function mapTypeToField(a){switch(a){case"Taxonomy":return"species_cvterms";case"Title":return"label";case"Sample type":return"sample_type";case"Geography":return"geolocations_cvterms";case"Collection protocols":return"collection_protocols_cvterms";case"Protocols":return"protocols_cvterms";case"Stable ID":return"id";case"Insecticides":return"insecticide_cvterms";case"Collection date":return"collection_date_range";case"Normalised IR":return"phenotype_rescaled_value_f";default:return a.toLowerCase()}}function PaneSpin(a,b){var c=document.getElementById(a);"start"===b?null==PaneSpinner?PaneSpinner=(new Spinner).spin(c):PaneSpinner.spin(c):PaneSpinner.stop(c)}function highlightMarker(a){$(a._icon).addClass("highlight-marker"),highlight=a,firstClick&&(firstClick=!1)}function moveTopMarker(a){$(a._icon).addClass("top-marker")}function removeTopMarker(a){$(a._icon).removeClass("top-marker")}function removeHighlight(a){null!==highlight&&($(highlight._icon).removeClass("highlight-marker"),a?highlight=a:highlight=null)}function resetPlots(){"use strict";var a,b,c;firstClick?(a='<h3>Summary view for selected samples</h3><div id="pie-chart-header" style="text-align: center; margin-top: 30px"><i class="fa fa-pie-chart" style="color: #2c699e; font-size: 12em"></i><h1>Go on!</h1><h4>click a marker on the map</h4><h4>to plot some real data</h4> </div><div id="pie-chart-area"><svg></svg></div>',b='<div style="text-align: center; margin-top: 30px"><i class="fa fa-area-chart" style="color: #2c699e; font-size: 12em"></i><h1>Go on!</h1><h4>click a marker on the map</h4><h4>to plot some real data</h4> </div>',c='<div style="text-align: center; margin-top: 30px"><i class="fa fa-table" style="color: #2c699e; font-size: 12em"></i><h1>Go on!</h1><h4>click a marker on the map</h4><h4>to see some real data</h4> </div>'):(a='<h3>Summary view for selected samples</h3><div id="pie-chart-header" style="text-align: center; margin-top: 30px"><i class="fa fa-pie-chart" style="color: #2c699e; font-size: 12em"></i><h4>click a marker on the map</h4></div><div id="pie-chart-area"><svg></svg></div>',b='<div style="text-align: center; margin-top: 30px"><i class="fa fa-area-chart" style="color: #2c699e; font-size: 12em"></i><h4>click a marker on the map</h4></div>',c='<div style="text-align: center; margin-top: 30px"><i class="fa fa-table" style="color: #2c699e; font-size: 12em"></i><h4>click a marker on the map</h4></div>'),$("#graphs").html(a),$("#swarm-chart-area").html(b),$("#marker-table").off("scroll"),$("#table-contents-header").html(c),$("#table-contents").empty()}function markerColor(a){var b,c;return 0>a?["white","#555"]:(b=trafficLight.evaluate(a),c=.3>a?"#fff":a>.7?"#fff":"#555",[b,c])}function getContrastYIQ(a){var b=parseInt(a.substr(0,2),16),c=parseInt(a.substr(2,2),16),d=parseInt(a.substr(4,2),16),e=(299*b+587*c+114*d)/1e3;return e>=128?"black":"white"}function constructSeasonal(a){for(var b,c,d="YYYY-MM",e="MMM",f=[],g=[],h=!1,i=new Date(1600,0,1),j=new Date(1600,0,1),k=1;13>k;k++){var l=a[k];l?(h?j.setMonth(k-1):(i.setMonth(k-1),j.setMonth(k-1),h=!0),12===k&&(b=dateConvert(i,d)+" TO "+dateConvert(j,d),f.push(b),c=i.getTime()===j.getTime()?dateConvert(i,e):dateConvert(i,e)+"-"+dateConvert(j,e),g.push(c),h=!1)):h&&(b=dateConvert(i,d)+" TO "+dateConvert(j,d),f.push(b),c=i.getTime()===j.getTime()?dateConvert(i,e):dateConvert(i,e)+"-"+dateConvert(j,e),g.push(c),h=!1)}return{ranges:f,rangesText:g}}function constructIrNorm(a,b){return{}}function dateResolution(a){var b=/^([\+-]?\d{4}(?!\d{2}\b))((-?)((0[1-9]|1[0-2])(\3([12]\d|0[1-9]|3[01]))?|W([0-4]\d|5[0-2])(-?[1-7])?|(00[1-9]|0[1-9]\d|[12]\d{2}|3([0-5]\d|6[1-6])))([T\s]((([01]\d|2[0-3])((:?)[0-5]\d)?|24\:?00)([\.,]\d+(?!:))?)?(\17[0-5]\d([\.,]\d+)?)?([zZ]|([\+-])([01]\d|2[0-3]):?([0-5]\d)?)?)?)?$/g,c=b.exec(a),d=c[1],e=c[5],f=c[7],g=new Date(a);if("undefined"!=typeof f)return g.toDateString();if("undefined"!=typeof e){var h="MMM YYYY";return dateConvert(g,h)}if("undefined"!=typeof d){var h="YYYY";return dateConvert(g,h)}return!1}function setDateRange(a,b,c){var d=new Date,e=new Date(Date.UTC(d.getUTCFullYear(),d.getUTCMonth(),d.getUTCDate()));d.setUTCFullYear(d.getUTCFullYear()-c);var f=new Date(Date.UTC(d.getUTCFullYear(),0,1));$(a).datepicker("setUTCDate",f),$(b).datepicker("setUTCDate",e)}function dateConvert(a,b){var c=a.getFullYear(),d=("0"+(a.getMonth()+1)).slice(-2),e=("0"+a.getDate()).slice(-2),f=(("0"+a.getHours()).slice(-2),("0"+a.getMinutes()).slice(-2),("0"+a.getSeconds()).slice(-2),a.getDay()),g=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],h=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],i="";switch(b){case"YYYY-MM-DD":i=c+"-"+d+"-"+e;break;case"YYYY-MM":i=c+"-"+d;break;case"MMM YYYY":i=g[parseInt(d)-1]+" "+c;break;case"YYYY-MMM-DD DDD":i=c+"-"+g[parseInt(d)-1]+"-"+e+" "+h[parseInt(f)];break;case"MMM":i=g[parseInt(d)-1];break;case"YYYY":i=c}return i}function addViolin(a,b,c,d,e,f,g,h){"use strict";var i,j=b.length-1,k=b[j].count,l=b[j].val,m=(e[1]-e[0])/f;b.push({val:l+m,count:k});var n=d3.scale.linear().range([d/2,0]).domain([0,Math.max(d3.max(b,function(a){return 1.5*a.count}))]),o=d3.select("#plotTooltip");i=h?d3.scale.log().range(c).domain(e).nice():d3.scale.linear().range(c).domain(e).nice();var p=(a.append("circle").attr("r",7).style("display","none").style("fill","#FFFFFF").style("pointer-events","none").style("stroke","#FB5050").style("stroke-width","3px"),
d3.bisector(function(a){return a.val}).left),q=d3.svg.area().interpolate(g).x(function(a){return i(a.val)}).y0(d/2).y1(function(a){return n(a.count)}),r=d3.svg.line().interpolate(g).x(function(a){return i(a.val)}).y(function(a){return n(a.count)}),s=a.append("g"),t=a.append("g");s.append("path").datum(b).attr("class","area").attr("d",q).on("mouseover",function(){o.transition().duration(100).style("opacity",1)}).on("mouseout",function(a){o.transition().duration(500).style("opacity",0)}).on("mousemove",function(a){var b=d3.mouse(this),c=i.invert(b[0]),d=p(a,c),e=a.length-1;if(0===d)var f="Range: "+a[d].val.roundDecimals(4)+"-"+(a[d].val+m).roundDecimals(4),g=a[d].count;else if(e>d)var f="Range: "+a[d-1].val.roundDecimals(4)+"-"+(a[d-1].val+m).roundDecimals(4),g=a[d-1].count;else var f="Range: "+a[e-1].val.roundDecimals(4)+"-"+(a[e-1].val+m).roundDecimals(4),g=a[e-1].count;var h='<h3 style="background-color: #CCCCCC;"><font color="white">Count of phenotypes</font></h3><p>%BIN</p><p><b>%COUNT</b></p>'.replace("%BIN",f).replace("%COUNT",g);o.html(h).style("left",d3.event.pageX+5+"px").style("top",d3.event.pageY-28+"px")}),s.append("path").datum(b).attr("class","violin").attr("d",r),t.append("path").datum(b).attr("class","area").attr("d",q).on("mouseover",function(){o.transition().duration(100).style("opacity",1)}).on("mouseout",function(a){o.transition().duration(500).style("opacity",0)}).on("mousemove",function(a){var b=d3.mouse(this),c=i.invert(b[0]),d=p(a,c),e=a.length-1;if(0===d)var f="Range: "+a[d].val.roundDecimals(4)+"-"+(a[d].val+m).roundDecimals(4),g=a[d].count;else if(e>d)var f="Range: "+a[d-1].val.roundDecimals(4)+"-"+(a[d-1].val+m).roundDecimals(4),g=a[d-1].count;else var f="Range: "+a[e-1].val.roundDecimals(4)+"-"+(a[e-1].val+m).roundDecimals(4),g=a[e-1].count;var h='<h3 style="background-color: #CCCCCC;"><font color="white">Count of phenotypes</font></h3><p>%BIN</p><p><b>%COUNT</b></p>'.replace("%BIN",f).replace("%COUNT",g);o.html(h).style("left",d3.event.pageX+5+"px").style("top",d3.event.pageY-28+"px")}),t.append("path").datum(b).attr("class","violin").attr("d",r),s.attr("transform","rotate(90,0,0)  translate(0,-"+d+")"),t.attr("transform","rotate(90,0,0) scale(1,-1)")}function addBoxPlot(a,b,c,d,e,f,g,h){"use strict";var i=d3.select("#plotTooltip");if(h){var j=d3.scale.log().range(d).domain(f).nice();console.log("Printing log in boxplot")}else var j=d3.scale.linear().range(d).domain(f).nice();for(var k=d3.scale.linear().range([0,e]),l=.5-g/2,m=.5+g/2,n=[.05,.25,.5,.75,.95],o=0;o<n.length;o++)n[o]=j(b[o]);var p=a.append("g");p.append("rect").attr("class","boxplot fill").attr("x",k(l)).attr("width",k(m)-k(l)).attr("y",n[3]).attr("height",-n[3]+n[1]),p.append("rect").attr("class","boxplot").attr("x",k(l)).attr("width",k(m)-k(l)).attr("y",n[3]).attr("height",-n[3]+n[1]);var q=[[0,1],[3,4]];for(o=0;o<q.length;o++)p.append("line").attr("class","boxplot").attr("x1",k(.5)).attr("x2",k(.5)).attr("y1",n[q[o][0]]).attr("y2",n[q[o][1]]);q=[0,1,2,3,4];for(var r=["","","median","",""],s=['<h3 style="background-color: #000000"><font color="white">5th percentile</font></h3><p><b>%VALUE</b></p>','<h3 style="background-color: #000000"><font color="white">25th percentile</font></h3><p><b>%VALUE</b></p>','<h3 style="background-color: #ff0000"><font color="white">Median</font></h3><p><b>%VALUE</b></p>','<h3 style="background-color: #000000"><font color="white">75th percentile</font></h3><p><b>%VALUE</b></p>','<h3 style="background-color: #000000"><font color="white">95th percentile</font></h3><p><b>%VALUE</b></p>'],o=0;o<q.length;o++)!function(a){var c=s[o].replace("%VALUE",b[q[o]].roundDecimals(4));p.append("line").attr("class","boxplot "+r[o]).attr("x1",k(l)).attr("x2",k(m)).attr("y1",n[q[o]]).attr("y2",n[q[o]]).on("mouseover",function(){i.transition().duration(100).style("opacity",1),i.html(c).style("left",d3.event.pageX+5+"px").style("top",d3.event.pageY-28+"px")}).on("mouseout",function(a){i.transition().duration(500).style("opacity",0)})}(o);var t='<h3 style="background-color: #ff0000"><font color="white">Mean</font></h3><p><b>'+c.roundDecimals(4)+"</b></p>";p.append("circle").attr("class","boxplot mean").attr("cx",k(.5)).attr("cy",j(c)).attr("r",k(g/5)).on("mouseover",function(){i.transition().duration(100).style("opacity",1),i.html(t).style("left",d3.event.pageX+5+"px").style("top",d3.event.pageY-28+"px")}).on("mouseout",function(a){i.transition().duration(500).style("opacity",0)})}function addBeeswarm(a,b,c,d,e,f,g){"use strict";var h,i=d3.select("#beeswarmPointTooltip");h=g?d3.scale.log().range(c).domain(e).nice():d3.scale.linear().range(c).domain(e).nice();var j=d3.scale.linear().range(d).domain(f).nice(),k=a.append("g");b.swarm.forEach(function(a,c){var d,e=b.data[c],f=e.bgColor,g=(e.y,e.collectionDate);if(g&&g.length>1){var l=new Date(g[0]),m=new Date(g[1]);d=l.toDateString()+"-"+m.toDateString()}else if(g&&g.length>0){var n=new Date(g[0]);d=n.toDateString()}e.collectionDate=d;var o=e.species?e.species:"Unknown";e.species=o;var p=$.templates("#irBsPointTemplate"),q=p.render(e);k.append("circle").attr("cx",j(a.x)).attr("cy",h(a.y)).attr("r",4).style("fill",f).on("mouseover",function(a){if(!stickyHover){$("#cancel-hover").css("display","none"),i.transition().duration(100).style("opacity",1).style("z-index",1e6),i.html(q);var b,c=window.innerHeight,d=i.node().getBoundingClientRect().height;b=d3.event.pageY-8+d>c?d3.event.pageY-d+28:d3.event.pageY-28,i.style("left",d3.event.pageX+20+"px").style("top",b+"px")}}).on("mouseout",function(a){stickyHover||i.transition().duration(500).style("opacity",0).style("z-index",-1e6)}).on("click",function(){i.transition().duration(100).style("opacity",1),stickyHover=!0,$("#no-interactions").addClass("foreground").on("click",function(){i.transition().duration(500).style("opacity",0).style("z-index",-1e6),$("#no-interactions").removeClass("foreground"),stickyHover=!1}),$("#cancel-hover").css("display","inline").on("click",function(){i.transition().duration(500).style("opacity",0).style("z-index",-1e6),$("#no-interactions").removeClass("foreground"),stickyHover=!1})})})}function createBeeViolinPlot(a,b){"use strict";if("smpl"===$("#view-mode").val())return void $(a).html('<div style="text-align: center; margin-top: 30px"><i class="fa fa-area-chart" style="color: #C3312D; font-size: 12em"></i><h1>Ooops</h1><h4>this plot type only works with Insecticide Resistance data</h4><h4>switch to IR phenotypes view and try again</h4></div>');var c=solrPopbioUrl+"irViolinStats?&"+qryUrl+b+"&json.wrf=?&callback=?";$(a).empty(),$.getJSON(c).done(function(c){if(c.facets.count&&c.facets.count>0){var d=$("<label>").text("Phenotypes included in background: "),e=$("<select />").attr("id","bgPlotType").attr("class","form-control");$("<option/>",{text:"phenotypes matching search",value:1}).appendTo(e),$("<option/>",{text:"phenotypes visible on map (including the ones behind this panel)",value:2}).appendTo(e),$("<option/>",{text:"all phenotypes",value:3}).appendTo(e),d.appendTo($(a)),e.val(bgPlotType).appendTo($(a)),d=$("<label>").text("Measurement type: ");var f=$("<select />").attr("id","plotType").attr("class","form-control");c.facets.vtypes.buckets.forEach(function(a){a.vunits.buckets.forEach(function(b){var c=a.val+" ("+b.val+"): "+b.count+" phenotypes";$("<option/>",{text:c,value:b.val,data:{phenotype_value_type_s:a.val,phenotype_value_unit_s:b.val,count:b.count,min:b.pmin,max:b.pmax}}).appendTo(f)})}),d.appendTo($(a)),f.appendTo($(a));var g=f.find(":selected").data();PaneSpin("swarm-plots","start"),buildPlot(a,b,g),f.change(function(){PaneSpin("swarm-plots","start"),g=f.find(":selected").data(),buildPlot(a,b,g)}),e.change(function(){PaneSpin("swarm-plots","start"),g=f.find(":selected").data(),bgPlotType=e.find(":selected").val(),buildPlot(a,b,g)})}}).fail(function(){PaneSpin("swarm-plots","stop"),console.log("Failed while loading irViolinStats")})}function buildPlot(a,b,c){"use strict";function d(a,b,c,d,e){var f=d3.scale.linear().range([j-u.bottom,u.top]).domain(a).nice(),h=d3.svg.axis().scale(f).orient("left");r.append("g").attr("class","axis").attr("transform","translate("+u.left+",0)").call(h),r.append("text").attr("x",u.left+s+t/2).attr("y",10).style("text-anchor","middle").text(g.capitalizeFirstLetter()),r.append("text").attr("x",u.left+s/2).attr("y",j-u.bottom+24).style("text-anchor","middle").style("font-weight","bold").text("Background"),r.append("text").attr("x",u.left+s/2).attr("y",j-u.bottom+40).style("text-anchor","middle").text("n="+b),c>0&&r.append("text").attr("x",u.left+s/2).attr("y",j-u.bottom+54).style("text-anchor","middle").text(c>1?c+" outliers excluded":c+" outlier excluded"),r.append("text").attr("x",u.left+s+t+s/2).attr("y",j-u.bottom+22).style("text-anchor","middle").style("font-weight","bold").text("Selection"),r.append("text").attr("x",u.left+s+t+s/2).attr("y",j-u.bottom+40).style("text-anchor","middle").text("n="+d),e>0&&r.append("text").attr("x",u.left+s+t+s/2).attr("y",j-u.bottom+54).style("text-anchor","middle").text(e>1?e+" outliers excluded":e+" outlier excluded")}var e,f=c.count,g=(c.min,c.max,c.phenotype_value_type_s),h=c.phenotype_value_unit_s,i=380,j=500,k=d3.select(a),l=25,m="basis";if(3>f)var n={pmin:"min(phenotype_value_f)",pmax:"max(phenotype_value_f)"};else var n={pmin:"percentile(phenotype_value_f,1)",pmax:"percentile(phenotype_value_f,99)"};var o=buildBbox(map.getBounds());d3.select("#beeViolinPlot")&&d3.select("#beeViolinPlot").remove();var p,q,r=k.append("svg").attr("width",i).attr("height",j).attr("style","width: "+i+"px; height: "+j+"px; border: 0; padding-top:10px").attr("id","beeViolinPlot"),s=150,t=10,u={top:25,bottom:65,left:40,right:20};switch($("#bgPlotType").val()){case"1":q=solrPopbioUrl+"irViolin?&"+qryUrl+'&fq=phenotype_value_type_s:"'+g+'"&fq=phenotype_value_unit_s:"'+h+'"&json.facet='+JSON.stringify(n)+"&json.wrf=?&callback=?";break;case"2":q=solrPopbioUrl+"irViolin?&"+qryUrl+o+'&fq=phenotype_value_type_s:"'+g+'"&fq=phenotype_value_unit_s:"'+h+'"&json.facet='+JSON.stringify(n)+"&json.wrf=?&callback=?";break;case"3":q=solrPopbioUrl+'irViolin?&q=*&fq=phenotype_value_type_s:"'+g+'"&fq=phenotype_value_unit_s:"'+h+'"&json.facet='+JSON.stringify(n)+"&json.wrf=?&callback=?"}$.getJSON(q).done(function(a){e=a.response.numFound;var c=a.facets.pmin,i=a.facets.pmax,k="&fq=phenotype_value_f:["+c+" TO "+i+"]";switch("percent"===h&&"mortality rate"===g&&(c=0,i=100),n={pmean:"avg(phenotype_value_f)",pperc:"percentile(phenotype_value_f,5,25,50,75,95)",pmin:"min(phenotype_value_f)",pmax:"max(phenotype_value_f)",denplot:{type:"range",field:"phenotype_value_f",gap:(i-c)/l,start:c,end:i,include:"edge"}},$("#bgPlotType").val()){case"1":p=solrPopbioUrl+"irBeeswarm?&"+qryUrl+k+'&fq=phenotype_value_type_s:"'+g+'"&fq=phenotype_value_unit_s:"'+h+'"&json.wrf=?&callback=?',q=solrPopbioUrl+"irViolin?&"+qryUrl+k+'&fq=phenotype_value_type_s:"'+g+'"&fq=phenotype_value_unit_s:"'+h+'"&json.facet='+JSON.stringify(n)+"&json.wrf=?&callback=?";break;case"2":p=solrPopbioUrl+"irBeeswarm?&"+qryUrl+k+o+'&fq=phenotype_value_type_s:"'+g+'"&fq=phenotype_value_unit_s:"'+h+'"&json.wrf=?&callback=?',q=solrPopbioUrl+"irViolin?&"+qryUrl+k+o+'&fq=phenotype_value_type_s:"'+g+'"&fq=phenotype_value_unit_s:"'+h+'"&json.facet='+JSON.stringify(n)+"&json.wrf=?&callback=?";break;case"3":p=solrPopbioUrl+"irBeeswarm?&q=*"+k+'&fq=phenotype_value_type_s:"'+g+'"&fq=phenotype_value_unit_s:"'+h+'"&json.wrf=?&callback=?',q=solrPopbioUrl+"irViolin?&q=*"+k+'&fq=phenotype_value_type_s:"'+g+'"&fq=phenotype_value_unit_s:"'+h+'"&json.facet='+JSON.stringify(n)+"&json.wrf=?&callback=?"}var v=$.getJSON(q);v.done(function(a){var o=r.append("g").attr("transform","translate("+(0*(s+t)+u.left)+",0)"),q=a.response.numFound;"percent"===h&&"mortality rate"===g&&(c=0,i=100);var v,w,x,y,z,A,B,C,D,E=[c,i],F=s/2;if(q>50)a.facets.count>0&&(A=a.facets.denplot.buckets,B=a.facets.pmean,C=a.facets.pperc,D=a.facets.count,addViolin(o,A,[j-u.bottom,u.top],s,E,l,m,!1),addBoxPlot(o,C,B,[j-u.bottom,u.top],s,E,.15,!1));else if(q>=10&&50>=q){var G=$.getJSON(p);G.fail(function(){console.log("Failed while loading irBeeswarm")}),G.done(function(b){if(b.grouped.phenotype_value_type_s.matches>0){w=b.grouped.phenotype_value_type_s.groups[0],F=s/2,v=[],y=(4*(i-c)/s).toFixed(6);var d=getScaleFactor(y),e=y*d;w.doclist.docs.forEach(function(a,b){v.push({x:void 0,y:a.phenotype_value_f,species:a.species_category,insecticide:a.insecticide_s,concentration:a.concentration_f,duration:a.duration_f,accession:a.accession,bundleName:a.bundle_name,url:a.url,sampleType:a.sample_type,geoCoords:a.geo_coords,geolocation:a.geolocations[0],bgColor:a.species_category?palette[a.species_category[0]]:palette.Unknown,textColor:getContrastYIQ(a.species_category?palette[a.species_category[0]]:palette.Unknown),collectionDate:a.collection_date,projects:a.projects,collectionProtocols:a.collection_protocols,protocols:a.protocols,phenotypeValue:a.phenotype_value_f,phenotypeValueType:a.phenotype_value_type_s,phenotypeValueUnit:a.phenotype_value_unit_s,sampleSize:a.sample_size_i,concentrationUnit:a.concentration_unit_s,durationUnit:a.duration_unit_s})}),x=new Beeswarm(v,0,e,d),z=[(s-8*x.maxPoints)/2,(s-8*x.maxPoints)/2+8*x.maxPoints],8*x.maxPoints>s&&(z=[0,s]),addBeeswarm(o,x,[j-u.bottom,u.top],z,E,x.domain,!1)}a.facets.count>0&&(A=a.facets.denplot.buckets,B=a.facets.pmean,C=a.facets.pperc,D=a.facets.count,addBoxPlot(o,C,B,[j-u.bottom,u.top],s,E,.15,!1))})}else{var G=$.getJSON(p);G.fail(function(){console.log("Failed while loading irBeeswarm")}),G.done(function(a){if(a.grouped.phenotype_value_type_s.matches>0){w=a.grouped.phenotype_value_type_s.groups[0],v=[],y=(4*(i-c)/s).toFixed(6);var b=getScaleFactor(y),d=y*b;w.doclist.docs.forEach(function(a,b){v.push({x:void 0,y:a.phenotype_value_f,species:a.species_category,insecticide:a.insecticide_s,concentration:a.concentration_f,duration:a.duration_f,accession:a.accession,bundleName:a.bundle_name,url:a.url,sampleType:a.sample_type,geoCoords:a.geo_coords,geolocation:a.geolocations[0],bgColor:a.species_category?palette[a.species_category[0]]:palette.Unknown,textColor:getContrastYIQ(a.species_category?palette[a.species_category[0]]:palette.Unknown),collectionDate:a.collection_date,projects:a.projects,collectionProtocols:a.collection_protocols,protocols:a.protocols,phenotypeValue:a.phenotype_value_f,phenotypeValueType:a.phenotype_value_type_s,phenotypeValueUnit:a.phenotype_value_unit_s,sampleSize:a.sample_size_i,concentrationUnit:a.concentration_unit_s,durationUnit:a.duration_unit_s})}),x=new Beeswarm(v,0,d,b),z=[(s-8*x.maxPoints)/2,(s-8*x.maxPoints)/2+8*x.maxPoints],8*x.maxPoints>s&&(z=[0,s]),addBeeswarm(o,x,[j-u.bottom,u.top],z,E,x.domain,!1)}})}var H=solrPopbioUrl+"irBeeswarm?&"+qryUrl+k+'&fq=phenotype_value_type_s:"'+g+'"&fq=phenotype_value_unit_s:"'+h+'"'+b+"&json.wrf=?&callback=?",I=solrPopbioUrl+"irViolin?&"+qryUrl+k+'&fq=phenotype_value_type_s:"'+g+'"&fq=phenotype_value_unit_s:"'+h+'"&json.facet='+JSON.stringify(n)+b+"&json.wrf=?&callback=?",J=$.getJSON(H),K=$.getJSON(I);$.when(J,K).done(function(a,b){var g,h,k,n,o,p,v,w,x=b[0].response.numFound,y=(b[0].facets.pmin,b[0].facets.pmax,r.append("g").attr("transform","translate("+(1*(s+t)+u.left)+",0)")),z=s/2;if(x>50)b[0].facets.count>0&&(p=b[0].facets.denplot.buckets,v=b[0].facets.pmean,w=b[0].facets.pperc,addViolin(y,p,[j-u.bottom,u.top],s,E,l,m,!1),addBoxPlot(y,w,v,[j-u.bottom,u.top],s,E,.15,!1));else if(x>=10&&50>=x){if(a[0].grouped.phenotype_value_type_s.matches>0){h=a[0].grouped.phenotype_value_type_s.groups[0],z=s/2,g=[],n=(4*(i-c)/s).toFixed(6);var A=getScaleFactor(n),B=n*A;h.doclist.docs.forEach(function(a,b){g.push({x:void 0,y:a.phenotype_value_f,species:a.species_category,insecticide:a.insecticide_s,concentration:a.concentration_f,duration:a.duration_f,accession:a.accession,bundleName:a.bundle_name,url:a.url,sampleType:a.sample_type,geoCoords:a.geo_coords,geolocation:a.geolocations[0],bgColor:a.species_category?palette[a.species_category[0]]:palette.Unknown,textColor:getContrastYIQ(a.species_category?palette[a.species_category[0]]:palette.Unknown),collectionDate:a.collection_date,projects:a.projects,collectionProtocols:a.collection_protocols,protocols:a.protocols,phenotypeValue:a.phenotype_value_f,phenotypeValueType:a.phenotype_value_type_s,phenotypeValueUnit:a.phenotype_value_unit_s,sampleSize:a.sample_size_i,concentrationUnit:a.concentration_unit_s,durationUnit:a.duration_unit_s})}),k=new Beeswarm(g,0,B,A),o=[(s-8*k.maxPoints)/2,(s-8*k.maxPoints)/2+8*k.maxPoints],8*k.maxPoints>s&&(o=[0,s]),addBeeswarm(y,k,[j-u.bottom,u.top],o,E,k.domain,!1)}b[0].facets.count>0&&(v=b[0].facets.pmean,w=b[0].facets.pperc,addBoxPlot(y,w,v,[j-u.bottom,u.top],s,E,.15,!1))}else if(a[0].grouped.phenotype_value_type_s.matches>0){h=a[0].grouped.phenotype_value_type_s.groups[0],g=[],n=(4*(i-c)/s).toFixed(6);var A=getScaleFactor(n),B=n*A;h.doclist.docs.forEach(function(a,b){g.push({x:void 0,y:a.phenotype_value_f,species:a.species_category,insecticide:a.insecticide_s,concentration:a.concentration_f,duration:a.duration_f,accession:a.accession,bundleName:a.bundle_name,url:a.url,sampleType:a.sample_type,geoCoords:a.geo_coords,geolocation:a.geolocations[0],bgColor:a.species_category?palette[a.species_category[0]]:palette.Unknown,textColor:getContrastYIQ(a.species_category?palette[a.species_category[0]]:palette.Unknown),collectionDate:a.collection_date,projects:a.projects,collectionProtocols:a.collection_protocols,protocols:a.protocols,phenotypeValue:a.phenotype_value_f,phenotypeValueType:a.phenotype_value_type_s,phenotypeValueUnit:a.phenotype_value_unit_s,sampleSize:a.sample_size_i,concentrationUnit:a.concentration_unit_s,durationUnit:a.duration_unit_s})}),k=new Beeswarm(g,0,B,A),o=[(s-8*k.maxPoints)/2,(s-8*k.maxPoints)/2+8*k.maxPoints],8*k.maxPoints>s&&(o=[0,s]),addBeeswarm(y,k,[j-u.bottom,u.top],o,E,k.domain,!1)}d(E,q,e-q,x,f-x),PaneSpin("swarm-plots","stop")}),J.fail(function(){console.log("Failed while loading irBeeswarm"),PaneSpin("swarm-plots","stop")}),K.fail(function(){console.log("Failed while loading irViolin"),PaneSpin("swarm-plots","stop")})}),v.fail(function(){console.log("Failed while loading irViolin")})}).fail(function(){console.log("Failed while loading irViolin")})}function getScaleFactor(a){a=parseFloat(a)+"";var b=a.indexOf(".");return-1==b?1:Math.pow(10,a.length-b-1)}L.Icon.Canvas=L.Icon.extend({options:{iconSize:new L.Point(20,20),className:"leaflet-canvas-icon",population:0,stats:[]},createIcon:function(){var a=document.createElement("canvas");this._setIconStyles(a,"icon");var b=this.options.iconSize;this.options.population;return a.width=b.x,a.height=b.y,this.draw(a.getContext("2d"),b.x,b.y),a},createShadow:function(){return null},draw:function(a,b,c){var d=this.options.iconSize.x,e=d/2,f=d/2.5,g=2*Math.PI,h=1.5*Math.PI;for(var i in this.options.stats)if(this.options.stats.hasOwnProperty(i)){var j=this.options.stats[i]/this.options.population;if(j>0){a.beginPath(),a.moveTo(e,e),palette.hasOwnProperty(i)?a.fillStyle=palette[i]:a.fillStyle=palette.others;var k=h,l=h+j*g;k>l&&(k=h),a.arc(e,e,e,k,l),h+=j*g,a.lineTo(e,e),a.fill(),a.closePath()}}a.beginPath(),a.fillStyle="white",a.arc(e,e,f,0,2*Math.PI),a.fill(),a.closePath();var m=markerColor(this.options.trafficlight);"ir"===$("#view-mode").val()&&(a.beginPath(),a.fillStyle=m[0],a.arc(e,e,e-7,0,2*Math.PI),a.fill(),a.closePath()),a.fillStyle="ir"===$("#view-mode").val()?m[1]:"#555",a.textAlign="center",a.textBaseline="middle",a.font="bold 12px sans-serif",a.fillText(this.options.population,e,e,d)}}),L.Control.MapLegend=L.Control.extend({options:{position:"bottomright",numberOfColors:20,sortType:"color"},addLegendIcon:function(){this._legendDiv=L.DomUtil.create("div","info legend"),legendDiv=this._legendDiv,L.easyButton("fa-info",function(){L.DomUtil.hasClass(legendDiv,"active")?(legend.removeFrom(map),L.DomUtil.removeClass(legendDiv,"active")):(legend.addTo(map),L.DomUtil.addClass(legendDiv,"active"))},"Toggle legend ON of OFF")},sortHashByValue:function(a){var b=[];for(var c in a)a.hasOwnProperty(c)&&b.push([c,a[c]]);return b.sort(function(a,b){return b[1]-a[1]}),b},generatePalette:function(a){for(var b=[],c=[],d=["#FFB300","#803E75","#FF6800","#A6BDD7","#C10020","#CEA262","#817066","#007D34","#F6768E","#00538A","#FF7A5C","#53377A","#FF8E00","#B32851","#F4C800","#7F180D","#93AA00","#593315","#F13A13","#232C16"],e=a.length,f=e,g=0;g<this.options.numberOfColors;g++)if("undefined"!=typeof a[g]){var h=a[g][0];b[h]=d[g],e--}c=b;for(var i=.5/e,j=.7,k=0;e>k;k++){var l=f-e+k,h=a[l][0];b[h]=colorLuminance("#FFFFFF",-j),j-=i}return b.others="radial-gradient("+colorLuminance("#FFFFFF",-.7)+", "+colorLuminance("#FFFFFF",-j)+")",c.others="radial-gradient("+colorLuminance("#FFFFFF",-.7)+", "+colorLuminance("#FFFFFF",-j)+")",b.Unknown="black",c.Unknown="black",[b,c]},Color:function(a){this.hex=a},constructColor:function(a){var b=a.hex.substring(1),c=parseInt(b.substring(0,2),16)/255,d=parseInt(b.substring(2,4),16)/255,e=parseInt(b.substring(4,6),16)/255,f=Math.max.apply(Math,[c,d,e]),g=Math.min.apply(Math,[c,d,e]),h=f-g,i=0,j=f,k=0;return j>0&&(k=h/j,k>0&&(c==f?(i=60*((d-g-(e-g))/h),0>i&&(i+=360)):d==f?i=120+60*((e-g-(c-g))/h):e==f&&(i=240+60*((c-g-(d-g))/h)))),a.chroma=h,a.hue=i,a.sat=k,a.val=j,a.luma=.3*c+.59*d+.11*e,a.red=parseInt(b.substring(0,2),16),a.green=parseInt(b.substring(2,4),16),a.blue=parseInt(b.substring(4,6),16),a},sortColorsByHue:function(a){var b=[],c=[];for(var d in a)a.hasOwnProperty(d)&&b.push([d,a[d]]);b.sort(function(a,b){return a=a[1],b=b[1],a.hue-b.hue});for(var e=0;e<b.length;e++){var f=b[e][0],g=b[e][1];c[f]=g.hex}return c},outputColors:function(a){var b=[],c=1;for(var d in palette)if(palette.hasOwnProperty(d)){if(c>legendSpecies-1)break;var e=new this.Color(palette[d]);this.constructColor(e),b[d]=e,c++}return this.sortColorsByHue(b)},generateHTML:function(a){var b="",c=1;for(var d in a)if(a.hasOwnProperty(d)){if(c>legendSpecies-1){b+='<i style="background:'+a.others+';"></i> Others<br />',$("#legend").html(b);break}var e=d.replace(/^(\w{2})\S+\s(\w+)/,"$1. $2");b+='<i style="background:'+a[d]+';" title="'+d+'"></i> '+(d?"<em>"+e+"</em><br>":"+"),c++}if("ir"===$("#view-mode").val()){b+='<div class="data-layer-legend" style="border: 0">',b+="<p>Resistance</p>",b+='<div class="min-value" style="border: 0">Low</div>',b+='<div class="scale-bars">';var f=L.ColorBrewer.Diverging.RdYlBu[10].slice();$.each(f.reverse(),function(a,c){b+='<i style="margin: 0; border-radius: 0; border: 0; color: '+c+"; width: 10px; background-color: "+c+' ;"></i>'}),b+='</div><div class="max-value" style="border: 0;">High</div></div><p style="font-size: smaller; word-wrap: break-word; width: 200px; margin-top: 20px;">Values have been rescaled globally and only give a relative indication of resistance/susceptibility</p>'}legend.onAdd=function(a){return this._legendDiv.innerHTML=b,this._legendDiv},L.DomUtil.hasClass(this._legendDiv,"active")&&(legend.removeFrom(map),legend.addTo(map))},populateLegend:function(a,b){var c="geohash_2";b||(b="species_category");var d=c+","+b,e=a.facet_counts.facet_pivot[d],f=[];for(var g in e)if(e.hasOwnProperty(g)){var h=e[g].count,i=e[g].pivot;for(var j in i)if(i.hasOwnProperty(j)){var k,l=i[j].count/h,m=i[j].value,n=parseInt(j);switch(n){case 1:k=7*l;break;case 2:k=3*l;break;case 3:k=1*l;break;default:k=0}f.hasOwnProperty(m)?f[m]+=k:f[m]=k}}var o=this.sortHashByValue(f),p=[],q=[];p=this.generatePalette(o,legendSpecies,1),palette=p[0],q=p[1];var r;r="name"===this.options.sortType?q:this.outputColors(q),this.generateHTML(r),loadSolr({clear:1,zoomLevel:map.getZoom()})}}),L.control.legend=function(a,b){var c=new L.Control.MapLegend(b);return c.addLegendIcon(),$.getJSON(a,function(a){c.populateLegend(a,"species_category")}),c};var nv=window.nv||{};window.nv=nv,nv.dev=!1,nv.tooltip=nv.tooltip||{},nv.utils=nv.utils||{},nv.models=nv.models||{},nv.charts={},nv.graphs=[],nv.logs={},nv.dispatch=d3.dispatch("render_start","render_end"),Function.prototype.bind||(Function.prototype.bind=function(a){if("function"!=typeof this)throw new TypeError("Function.prototype.bind - what is trying to be bound is not callable");var b=Array.prototype.slice.call(arguments,1),c=this,d=function(){},e=function(){return c.apply(this instanceof d&&a?this:a,b.concat(Array.prototype.slice.call(arguments)))};return d.prototype=this.prototype,e.prototype=new d,e}),nv.dev&&(nv.dispatch.on("render_start",function(a){nv.logs.startTime=+new Date}),nv.dispatch.on("render_end",function(a){nv.logs.endTime=+new Date,nv.logs.totalTime=nv.logs.endTime-nv.logs.startTime,nv.log("total",nv.logs.totalTime)})),nv.log=function(){if(nv.dev&&window.console&&console.log&&console.log.apply)console.log.apply(console,arguments);else if(nv.dev&&window.console&&"function"==typeof console.log&&Function.prototype.bind){var a=Function.prototype.bind.call(console.log,console);a.apply(console,arguments)}return arguments[arguments.length-1]},nv.deprecated=function(a){nv.dev&&console&&console.warn&&console.warn("`"+a+"` has been deprecated.")},nv.render=function(a){a=a||1,nv.render.active=!0,nv.dispatch.render_start(),setTimeout(function(){for(var b,c,d=0;a>d&&(c=nv.render.queue[d]);d++)b=c.generate(),typeof c.callback==typeof Function&&c.callback(b),nv.graphs.push(b);nv.render.queue.splice(0,d),nv.render.queue.length?setTimeout(arguments.callee,0):(nv.dispatch.render_end(),nv.render.active=!1)},0)},nv.render.active=!1,nv.render.queue=[],nv.addGraph=function(a){typeof arguments[0]==typeof Function&&(a={generate:arguments[0],callback:arguments[1]}),nv.render.queue.push(a),nv.render.active||nv.render()},nv.interactiveGuideline=function(){"use strict";function a(k){k.each(function(k){function l(){var c=d3.mouse(this),d=c[0],h=c[1],i=!0,k=!1;if(j&&(d=d3.event.offsetX,h=d3.event.offsetY,"svg"!==d3.event.target.tagName&&(i=!1),d3.event.target.className.baseVal.match("nv-legend")&&(k=!0)),i&&(d-=e.left,h-=e.top),0>d||0>h||d>n||h>o||d3.event.relatedTarget&&void 0===d3.event.relatedTarget.ownerSVGElement||k){if(j&&d3.event.relatedTarget&&void 0===d3.event.relatedTarget.ownerSVGElement&&d3.event.relatedTarget.className.match(b.nvPointerEventsClass))return;return g.elementMouseout({mouseX:d,mouseY:h}),void a.renderGuideLine(null)}var l=f.invert(d);g.elementMousemove({mouseX:d,mouseY:h,pointXValue:l}),"dblclick"===d3.event.type&&g.elementDblclick({mouseX:d,mouseY:h,pointXValue:l}),"click"===d3.event.type&&g.elementClick({mouseX:d,mouseY:h,pointXValue:l})}var m=d3.select(this),n=c||960,o=d||400,p=m.selectAll("g.nv-wrap.nv-interactiveLineLayer").data([k]),q=p.enter().append("g").attr("class"," nv-wrap nv-interactiveLineLayer");q.append("g").attr("class","nv-interactiveGuideLine"),i&&(i.on("mousemove",l,!0).on("mouseout",l,!0).on("dblclick",l).on("click",l),a.renderGuideLine=function(a){if(h){var b=p.select(".nv-interactiveGuideLine").selectAll("line").data(null!=a?[nv.utils.NaNtoZero(a)]:[],String);b.enter().append("line").attr("class","nv-guideline").attr("x1",function(a){return a}).attr("x2",function(a){return a}).attr("y1",o).attr("y2",0),b.exit().remove()}})})}var b=nv.models.tooltip(),c=null,d=null,e={left:0,top:0},f=d3.scale.linear(),g=(d3.scale.linear(),d3.dispatch("elementMousemove","elementMouseout","elementClick","elementDblclick")),h=!0,i=null,j="ActiveXObject"in window;return a.dispatch=g,a.tooltip=b,a.margin=function(b){return arguments.length?(e.top="undefined"!=typeof b.top?b.top:e.top,e.left="undefined"!=typeof b.left?b.left:e.left,a):e},a.width=function(b){return arguments.length?(c=b,a):c},a.height=function(b){return arguments.length?(d=b,a):d},a.xScale=function(b){return arguments.length?(f=b,a):f},a.showGuideLine=function(b){return arguments.length?(h=b,a):h},a.svgContainer=function(b){return arguments.length?(i=b,a):i},a},nv.interactiveBisect=function(a,b,c){"use strict";if(!(a instanceof Array))return null;"function"!=typeof c&&(c=function(a,b){return a.x});var d=d3.bisector(c).left,e=d3.max([0,d(a,b)-1]),f=c(a[e],e);if("undefined"==typeof f&&(f=e),f===b)return e;var g=d3.min([e+1,a.length-1]),h=c(a[g],g);return"undefined"==typeof h&&(h=g),Math.abs(h-b)>=Math.abs(f-b)?e:g},nv.nearestValueIndex=function(a,b,c){"use strict";var d=1/0,e=null;return a.forEach(function(a,f){var g=Math.abs(b-a);d>=g&&c>g&&(d=g,e=f)}),e},function(){"use strict";window.nv.tooltip={},window.nv.models.tooltip=function(){function a(){if(k){var a=d3.select(k);"svg"!==a.node().tagName&&(a=a.select("svg"));var b=a.node()?a.attr("viewBox"):null;if(b){b=b.split(" ");var c=parseInt(a.style("width"))/b[2];m.left=m.left*c,m.top=m.top*c}}}function b(a){var b;b=k?d3.select(k):d3.select("body");var c=b.select(".nvtooltip");return null===c.node()&&(c=b.append("div").attr("class","nvtooltip "+(j?j:"xy-tooltip")).attr("id",o)),c.node().innerHTML=a,c.style("top",0).style("left",0).style("opacity",0),c.selectAll("div, table, td, tr").classed(p,!0),c.classed(p,!0),c.node()}function c(){if(n&&t(e)){a();var d=m.left,j=null!=i?i:m.top,o=b(s(e));if(l=o,k){var p=k.getElementsByTagName("svg")[0],q=(p?p.getBoundingClientRect():k.getBoundingClientRect(),{left:0,top:0});if(p){var r=p.getBoundingClientRect(),u=k.getBoundingClientRect(),v=r.top;if(0>v){var w=k.getBoundingClientRect();v=Math.abs(v)>w.height?0:v}q.top=Math.abs(v-u.top),q.left=Math.abs(r.left-u.left)}d+=k.offsetLeft+q.left-2*k.scrollLeft,j+=k.offsetTop+q.top-2*k.scrollTop}return h&&h>0&&(j=Math.floor(j/h)*h),nv.tooltip.calcTooltipPosition([d,j],f,g,o),c}}var d=null,e=null,f="w",g=50,h=25,i=null,j=null,k=null,l=null,m={left:null,top:null},n=!0,o="nvtooltip-"+Math.floor(1e5*Math.random()),p="nv-pointer-events-none",q=function(a,b){return a},r=function(a){return a},s=function(a){if(null!=d)return d;if(null==a)return"";var b=d3.select(document.createElement("table")),c=b.selectAll("thead").data([a]).enter().append("thead");c.append("tr").append("td").attr("colspan",3).append("strong").classed("x-value",!0).html(r(a.value));var e=b.selectAll("tbody").data([a]).enter().append("tbody"),f=e.selectAll("tr").data(function(a){return a.series}).enter().append("tr").classed("highlight",function(a){return a.highlight});f.append("td").classed("legend-color-guide",!0).append("div").style("background-color",function(a){return a.color}),f.append("td").classed("key",!0).html(function(a){return a.key}),f.append("td").classed("value",!0).html(function(a,b){return q(a.value,b)}),f.selectAll("td").each(function(a){if(a.highlight){var b=d3.scale.linear().domain([0,1]).range(["#fff",a.color]),c=.6;d3.select(this).style("border-bottom-color",b(c)).style("border-top-color",b(c))}});var g=b.node().outerHTML;return void 0!==a.footer&&(g+="<div class='footer'>"+a.footer+"</div>"),g},t=function(a){return!!(a&&a.series&&a.series.length>0)};return c.nvPointerEventsClass=p,c.content=function(a){return arguments.length?(d=a,c):d},c.tooltipElem=function(){return l},c.contentGenerator=function(a){return arguments.length?("function"==typeof a&&(s=a),c):s},c.data=function(a){return arguments.length?(e=a,c):e},c.gravity=function(a){return arguments.length?(f=a,c):f},c.distance=function(a){return arguments.length?(g=a,c):g},c.snapDistance=function(a){return arguments.length?(h=a,c):h},c.classes=function(a){return arguments.length?(j=a,c):j},c.chartContainer=function(a){return arguments.length?(k=a,c):k},c.position=function(a){return arguments.length?(m.left="undefined"!=typeof a.left?a.left:m.left,m.top="undefined"!=typeof a.top?a.top:m.top,c):m},c.fixedTop=function(a){return arguments.length?(i=a,c):i},c.enabled=function(a){return arguments.length?(n=a,c):n},c.valueFormatter=function(a){return arguments.length?("function"==typeof a&&(q=a),c):q},c.headerFormatter=function(a){return arguments.length?("function"==typeof a&&(r=a),c):r},c.id=function(){return o},c},nv.tooltip.show=function(a,b,c,d,e,f){var g=document.createElement("div");g.className="nvtooltip "+(f?f:"xy-tooltip");var h=e;e&&!e.tagName.match(/g|svg/i)||(h=document.getElementsByTagName("body")[0]),g.style.left=0,g.style.top=0,
g.style.opacity=0,"string"!=typeof b?g.appendChild(b):g.innerHTML=b,h.appendChild(g),e&&(a[0]=a[0]-e.scrollLeft,a[1]=a[1]-e.scrollTop),nv.tooltip.calcTooltipPosition(a,c,d,g)},nv.tooltip.findFirstNonSVGParent=function(a){for(;null!==a.tagName.match(/^g|svg$/i);)a=a.parentNode;return a},nv.tooltip.findTotalOffsetTop=function(a,b){var c=b;do isNaN(a.offsetTop)||(c+=a.offsetTop);while(a=a.offsetParent);return c},nv.tooltip.findTotalOffsetLeft=function(a,b){var c=b;do isNaN(a.offsetLeft)||(c+=a.offsetLeft);while(a=a.offsetParent);return c},nv.tooltip.calcTooltipPosition=function(a,b,c,d){var e,f,g=parseInt(d.offsetHeight),h=parseInt(d.offsetWidth),i=nv.utils.windowSize().width,j=nv.utils.windowSize().height,k=window.pageYOffset,l=window.pageXOffset;j=window.innerWidth>=document.body.scrollWidth?j:j-16,i=window.innerHeight>=document.body.scrollHeight?i:i-16,b=b||"s",c=c||20;var m=function(a){return nv.tooltip.findTotalOffsetTop(a,f)},n=function(a){return nv.tooltip.findTotalOffsetLeft(a,e)};switch(b){case"e":e=a[0]-h-c,f=a[1]-g/2;var o=n(d),p=m(d);l>o&&(e=a[0]+c>l?a[0]+c:l-o+e),k>p&&(f=k-p+f),p+g>k+j&&(f=k+j-p+f-g);break;case"w":e=a[0]+c,f=a[1]-g/2;var o=n(d),p=m(d);o+h>i&&(e=a[0]-h-c),k>p&&(f=k+5),p+g>k+j&&(f=k+j-p+f-g);break;case"n":e=a[0]-h/2-5,f=a[1]+c;var o=n(d),p=m(d);l>o&&(e=l+5),o+h>i&&(e=e-h/2+5),p+g>k+j&&(f=k+j-p+f-g);break;case"s":e=a[0]-h/2,f=a[1]-g-c;var o=n(d),p=m(d);l>o&&(e=l+5),o+h>i&&(e=e-h/2+5),k>p&&(f=k);break;case"none":e=a[0],f=a[1]-c;var o=n(d),p=m(d)}return d.style.left=e+"px",d.style.top=f+"px",d.style.opacity=1,d.style.position="absolute",d},nv.tooltip.cleanup=function(){for(var a=document.getElementsByClassName("nvtooltip"),b=[];a.length;)b.push(a[0]),a[0].style.transitionDelay="0 !important",a[0].style.opacity=0,a[0].className="nvtooltip-pending-removal";setTimeout(function(){for(;b.length;){var a=b.pop();a.parentNode.removeChild(a)}},500)}}(),nv.utils.windowSize=function(){var a={width:640,height:480};return document.body&&document.body.offsetWidth&&(a.width=document.body.offsetWidth,a.height=document.body.offsetHeight),"CSS1Compat"==document.compatMode&&document.documentElement&&document.documentElement.offsetWidth&&(a.width=document.documentElement.offsetWidth,a.height=document.documentElement.offsetHeight),window.innerWidth&&window.innerHeight&&(a.width=window.innerWidth,a.height=window.innerHeight),a},nv.utils.windowResize=function(a){return window.addEventListener?window.addEventListener("resize",a):nv.log("ERROR: Failed to bind to window.resize with: ",a),{callback:a,clear:function(){window.removeEventListener("resize",a)}}},nv.utils.getColor=function(a){return arguments.length?a instanceof Array?function(b,c){return b.color||a[c%a.length]}:a:nv.utils.defaultColor()},nv.utils.defaultColor=function(){var a=d3.scale.category20().range();return function(b,c){return b.color||a[c%a.length]}},nv.utils.customTheme=function(a,b,c){b=b||function(a){return a.key},c=c||d3.scale.category20().range();var d=c.length;return function(e,f){var g=b(e);return"function"==typeof a[g]?a[g]():void 0!==a[g]?a[g]:(d||(d=c.length),d-=1,c[d])}},nv.utils.pjax=function(a,b){var c=function(c){d3.html(c,function(c){var d=d3.select(b).node();d.parentNode.replaceChild(d3.select(c).select(b).node(),d),nv.utils.pjax(a,b)})};d3.selectAll(a).on("click",function(){history.pushState(this.href,this.textContent,this.href),c(this.href),d3.event.preventDefault()}),d3.select(window).on("popstate",function(){d3.event.state&&c(d3.event.state)})},nv.utils.calcApproxTextWidth=function(a){if("function"==typeof a.style&&"function"==typeof a.text){var b=parseInt(a.style("font-size").replace("px","")),c=a.text().length;return c*b*.5}return 0},nv.utils.NaNtoZero=function(a){return"number"!=typeof a||isNaN(a)||null===a||a===1/0||a===-(1/0)?0:a},d3.selection.prototype.watchTransition=function(a){var b=[this].concat([].slice.call(arguments,1));return a.transition.apply(a,b)},nv.utils.renderWatch=function(a,b){if(!(this instanceof nv.utils.renderWatch))return new nv.utils.renderWatch(a,b);var c=void 0!==b?b:250,d=[],e=this;this.models=function(a){return a=[].slice.call(arguments,0),a.forEach(function(a){a.__rendered=!1,function(a){a.dispatch.on("renderEnd",function(b){a.__rendered=!0,e.renderEnd("model")})}(a),d.indexOf(a)<0&&d.push(a)}),this},this.reset=function(a){void 0!==a&&(c=a),d=[]},this.transition=function(a,b,f){if(b=arguments.length>1?[].slice.call(arguments,1):[],f=b.length>1?b.pop():void 0!==c?c:250,a.__rendered=!1,d.indexOf(a)<0&&d.push(a),0===f)return a.__rendered=!0,a.delay=function(){return this},a.duration=function(){return this},a;0===a.length?a.__rendered=!0:a.every(function(a){return!a.length})?a.__rendered=!0:a.__rendered=!1;var g=0;return a.transition().duration(f).each(function(){++g}).each("end",function(c,d){0===--g&&(a.__rendered=!0,e.renderEnd.apply(this,b))})},this.renderEnd=function(){d.every(function(a){return a.__rendered})&&(d.forEach(function(a){a.__rendered=!1}),a.renderEnd.apply(this,arguments))}},nv.utils.deepExtend=function(a){var b=arguments.length>1?[].slice.call(arguments,1):[];b.forEach(function(b){for(key in b){var c=a[key]instanceof Array,d="object"==typeof a[key],e="object"==typeof b[key];d&&!c&&e?nv.utils.deepExtend(a[key],b[key]):a[key]=b[key]}})},nv.utils.state=function(){if(!(this instanceof nv.utils.state))return new nv.utils.state;var a={},b=function(){},c=function(){return{}},d=null,e=null;this.dispatch=d3.dispatch("change","set"),this.dispatch.on("set",function(a){b(a,!0)}),this.getter=function(a){return c=a,this},this.setter=function(a,c){return c||(c=function(){}),b=function(b,d){a(b),d&&c()},this},this.init=function(a){d=d||{},nv.utils.deepExtend(d,a)};var f=function(){var b=c();if(JSON.stringify(b)===JSON.stringify(a))return!1;for(var d in b)void 0===a[d]&&(a[d]={}),a[d]=b[d],e=!0;return!0};this.update=function(){d&&(b(d,!1),d=null),f.call(this)&&this.dispatch.change(a)}},nv.utils.optionsFunc=function(a){return nv.deprecated("nv.utils.optionsFunc"),a&&d3.map(a).forEach(function(a,b){"function"==typeof this[a]&&this[a](b)}.bind(this)),this},nv.utils.calcTicksX=function(a,b){var c=1,d=0;for(d;d<b.length;d+=1){var e=b[d]&&b[d].values?b[d].values.length:0;c=e>c?e:c}return nv.log("Requested number of ticks: ",a),nv.log("Calculated max values to be: ",c),a=a>c?a=c-1:a,a=1>a?1:a,a=Math.floor(a),nv.log("Calculating tick count as: ",a),a},nv.utils.calcTicksY=function(a,b){return nv.utils.calcTicksX(a,b)},nv.utils.initOption=function(a,b){a._calls&&a._calls[b]?a[b]=a._calls[b]:a[b]=function(c){return arguments.length?(a._options[b]=c,a):a._options[b]}},nv.utils.initOptions=function(a){var b=Object.getOwnPropertyNames(a._options||{}),c=Object.getOwnPropertyNames(a._calls||{});b=b.concat(c);for(var d in b)nv.utils.initOption(a,b[d])},nv.utils.inheritOptionsD3=function(a,b,c){a._d3options=c.concat(a._d3options||[]),c.unshift(b),c.unshift(a),d3.rebind.apply(this,c)},nv.utils.arrayUnique=function(a){return a.sort().filter(function(b,c){return!c||b!=a[c-1]})},nv.utils.symbolMap=d3.map(),nv.utils.symbol=function(){function a(a,d){var e=b.call(this,a,d),f=c.call(this,a,d);return-1!==d3.svg.symbolTypes.indexOf(e)?d3.svg.symbol().type(e).size(f)():nv.utils.symbolMap.get(e)(f)}var b,c=64;return a.type=function(c){return arguments.length?(b=d3.functor(c),a):b},a.size=function(b){return arguments.length?(c=d3.functor(b),a):c},a},nv.utils.inheritOptions=function(a,b){var c=Object.getOwnPropertyNames(b._options||{}),d=Object.getOwnPropertyNames(b._calls||{}),e=b._inherited||[],f=b._d3options||[],g=c.concat(d).concat(e).concat(f);g.unshift(b),g.unshift(a),d3.rebind.apply(this,g),a._inherited=nv.utils.arrayUnique(c.concat(d).concat(e).concat(c).concat(a._inherited||[])),a._d3options=nv.utils.arrayUnique(f.concat(a._d3options||[]))},nv.utils.initSVG=function(a){a.classed({"nvd3-svg":!0})},nv.models.legend=function(){"use strict";function a(l){return l.each(function(a){var l=c-b.left-b.right,m=d3.select(this);nv.utils.initSVG(m);var n=m.selectAll("g.nv-legend").data([a]),o=(n.enter().append("g").attr("class","nvd3 nv-legend").append("g"),n.select("g"));n.attr("transform","translate("+b.left+","+b.top+")");var p=o.selectAll(".nv-series").data(function(a){return a}),q=p.enter().append("g").attr("class","nv-series").on("mouseover",function(a,b){k.legendMouseover(a,b)}).on("mouseout",function(a,b){k.legendMouseout(a,b)}).on("click",function(b,c){k.legendClick(b,c),i&&(j?(a.forEach(function(a){a.disabled=!0}),b.disabled=!1):(b.disabled=!b.disabled,a.every(function(a){return a.disabled})&&a.forEach(function(a){a.disabled=!1})),k.stateChange({disabled:a.map(function(a){return!!a.disabled})}))}).on("dblclick",function(b,c){k.legendDblclick(b,c),i&&(a.forEach(function(a){a.disabled=!0}),b.disabled=!1,k.stateChange({disabled:a.map(function(a){return!!a.disabled})}))});if(q.append("circle").style("stroke-width",2).attr("class","nv-legend-symbol").attr("r",5),q.append("text").attr("text-anchor","start").attr("class","nv-legend-text").attr("dy",".32em").attr("dx","8"),p.classed("nv-disabled",function(a){return a.disabled}),p.exit().remove(),p.select("circle").style("fill",function(a,b){return a.color||f(a,b)}).style("stroke",function(a,b){return a.color||f(a,b)}),p.select("text").text(e),g){var r=[];p.each(function(a,b){var c,d=d3.select(this).select("text");try{if(c=d.node().getComputedTextLength(),0>=c)throw Error()}catch(e){c=nv.utils.calcApproxTextWidth(d)}r.push(c+28)});for(var s=0,t=0,u=[];l>t&&s<r.length;)u[s]=r[s],t+=r[s++];for(0===s&&(s=1);t>l&&s>1;){u=[],s--;for(var v=0;v<r.length;v++)r[v]>(u[v%s]||0)&&(u[v%s]=r[v]);t=u.reduce(function(a,b,c,d){return a+b})}for(var w=[],x=0,y=0;s>x;x++)w[x]=y,y+=u[x];p.attr("transform",function(a,b){return"translate("+w[b%s]+","+(5+20*Math.floor(b/s))+")"}),h?o.attr("transform","translate("+(c-b.right-t)+","+b.top+")"):o.attr("transform","translate(0,"+b.top+")"),d=b.top+b.bottom+20*Math.ceil(r.length/s)}else{var z,A=5,B=5,C=0;p.attr("transform",function(a,d){var e=d3.select(this).select("text").node().getComputedTextLength()+28;return z=B,c<b.left+b.right+z+e&&(B=z=5,A+=20),B+=e,B>C&&(C=B),"translate("+z+","+A+")"}),o.attr("transform","translate("+(c-b.right-C)+","+b.top+")"),d=b.top+b.bottom+A+15}}),a}var b={top:5,right:0,bottom:5,left:0},c=400,d=20,e=function(a){return a.key},f=nv.utils.defaultColor(),g=!0,h=!1,i=!0,j=!1,k=d3.dispatch("legendClick","legendDblclick","legendMouseover","legendMouseout","stateChange");return a.dispatch=k,a.options=nv.utils.optionsFunc.bind(a),a._options=Object.create({},{width:{get:function(){return c},set:function(a){c=a}},height:{get:function(){return d},set:function(a){d=a}},key:{get:function(){return e},set:function(a){e=a}},align:{get:function(){return g},set:function(a){g=a}},rightAlign:{get:function(){return h},set:function(a){h=a}},updateState:{get:function(){return i},set:function(a){i=a}},radioButtonMode:{get:function(){return j},set:function(a){j=a}},margin:{get:function(){return b},set:function(a){b.top=void 0!==a.top?a.top:b.top,b.right=void 0!==a.right?a.right:b.right,b.bottom=void 0!==a.bottom?a.bottom:b.bottom,b.left=void 0!==a.left?a.left:b.left}},color:{get:function(){return f},set:function(a){f=nv.utils.getColor(a)}}}),nv.utils.initOptions(a),a},nv.models.pie=function(){"use strict";function a(j){return B.reset(),j.each(function(a){function j(a){a.endAngle=isNaN(a.endAngle)?0:a.endAngle,a.startAngle=isNaN(a.startAngle)?0:a.startAngle,q||(a.innerRadius=0);var b=d3.interpolate(this._current,a);return this._current=b(0),function(a){return M(b(a))}}var C=c-b.left-b.right,D=e-b.top-b.bottom,E=Math.min(C,D)/2,F=E-E/5,G=d3.select(this);nv.utils.initSVG(G);var H=G.selectAll(".nv-wrap.nv-pie").data(a),I=H.enter().append("g").attr("class","nvd3 nv-wrap nv-pie nv-chart-"+h),J=I.append("g"),K=H.select("g"),L=J.append("g").attr("class","nv-pie");J.append("g").attr("class","nv-pieLabels"),H.attr("transform","translate("+b.left+","+b.top+")"),K.select(".nv-pie").attr("transform","translate("+C/2+","+D/2+")"),K.select(".nv-pieLabels").attr("transform","translate("+C/2+","+D/2+")"),G.on("click",function(a,b){A.chartClick({data:a,index:b,pos:d3.event,id:h})});var M=d3.svg.arc().outerRadius(F),N=d3.svg.arc().outerRadius(F+5);v&&(M.startAngle(v),N.startAngle(v)),x&&(M.endAngle(x),N.endAngle(x)),q&&(M.innerRadius(E*z),N.innerRadius(E*z));var O=d3.layout.pie().sort(null).value(function(a){return a.disabled?0:g(a)});if(O.padAngle&&w&&O.padAngle(w),M.cornerRadius&&y&&(M.cornerRadius(y),N.cornerRadius(y)),q&&r){var P=L.append("g").attr("class","nv-pie");P.append("text").style("text-anchor","middle").attr("class","nv-pie-title").text(function(a){return r}).attr("dy","0.35em").attr("transform",function(a,b){return"translate(0, "+t+")"})}var Q=H.select(".nv-pie").selectAll(".nv-slice").data(O),R=H.select(".nv-pieLabels").selectAll(".nv-label").data(O);Q.exit().remove(),R.exit().remove();var S=Q.enter().append("g");S.attr("class","nv-slice"),S.on("mouseover",function(a,b){d3.select(this).classed("hover",!0),s&&d3.select(this).select("path").transition().duration(70).attr("d",N),A.elementMouseover({label:f(a.data),value:g(a.data),point:a.data,pointIndex:b,pos:[d3.event.pageX,d3.event.pageY],id:h,color:d3.select(this).style("fill")})}),S.on("mouseout",function(a,b){d3.select(this).classed("hover",!1),s&&d3.select(this).select("path").transition().duration(50).attr("d",M),A.elementMouseout({label:f(a.data),value:g(a.data),point:a.data,index:b,id:h})}),Q.attr("fill",function(a,b){return i(a,b)}),Q.attr("stroke",function(a,b){return i(a,b)});var T=S.append("path").each(function(a){this._current=a});if(T.on("click",function(a,b){A.elementClick({label:f(a.data),value:g(a.data),point:a.data,index:b,pos:d3.event,id:h}),d3.event.stopPropagation()}),T.on("dblclick",function(a,b){A.elementDblClick({label:f(a.data),value:g(a.data),point:a.data,index:b,pos:d3.event,id:h}),d3.event.stopPropagation()}),Q.select("path").transition().attr("d",M).attrTween("d",j),l){var U=d3.svg.arc().innerRadius(0);if(m)var U=M;n&&(U=d3.svg.arc().outerRadius(M.outerRadius())),R.enter().append("g").classed("nv-label",!0).each(function(a,b){var c=d3.select(this);c.attr("transform",function(a){if(u){a.outerRadius=F+10,a.innerRadius=F+15;var b=(a.startAngle+a.endAngle)/2*(180/Math.PI);return(a.startAngle+a.endAngle)/2<Math.PI?b-=90:b+=90,"translate("+U.centroid(a)+") rotate("+b+")"}return a.outerRadius=E+10,a.innerRadius=E+15,"translate("+U.centroid(a)+")"}),c.append("rect").style("stroke","#fff").style("fill","#fff").attr("rx",3).attr("ry",3),c.append("text").style("text-anchor",u?(a.startAngle+a.endAngle)/2<Math.PI?"start":"end":"middle").style("fill","#fff")});var V={},W=14,X=140,Y=function(a){return Math.floor(a[0]/X)*X+","+Math.floor(a[1]/W)*W};R.watchTransition(B,"pie labels").attr("transform",function(a){if(u){a.outerRadius=F+10,a.innerRadius=F+15;var b=(a.startAngle+a.endAngle)/2*(180/Math.PI);return(a.startAngle+a.endAngle)/2<Math.PI?b-=90:b+=90,"translate("+U.centroid(a)+") rotate("+b+")"}a.outerRadius=E+10,a.innerRadius=E+15;var c=U.centroid(a);if(a.value){var d=Y(c);V[d]&&(c[1]-=W),V[Y(c)]=!0}return"translate("+c+")"}),R.select(".nv-label text").style("text-anchor",u?(d.startAngle+d.endAngle)/2<Math.PI?"start":"end":"middle").text(function(a,b){var c=(a.endAngle-a.startAngle)/(2*Math.PI),d={key:f(a.data),value:g(a.data),percent:k(c)};return a.value&&c>p?d[o]:""})}}),B.renderEnd("pie immediate"),a}var b={top:0,right:0,bottom:0,left:0},c=500,e=500,f=function(a){return a.x},g=function(a){return a.y},h=Math.floor(1e4*Math.random()),i=nv.utils.defaultColor(),j=d3.format(",.0f"),k=d3.format("%"),l=!0,m=!0,n=!1,o="key",p=.02,q=!1,r=!1,s=!0,t=0,u=!1,v=!1,w=!1,x=!1,y=0,z=.5,A=d3.dispatch("chartClick","elementClick","elementDblClick","elementMouseover","elementMouseout","renderEnd"),B=nv.utils.renderWatch(A);return a.dispatch=A,a.options=nv.utils.optionsFunc.bind(a),a._options=Object.create({},{width:{get:function(){return c},set:function(a){c=a}},height:{get:function(){return e},set:function(a){e=a}},showLabels:{get:function(){return l},set:function(a){l=a}},title:{get:function(){return r},set:function(a){r=a}},titleOffset:{get:function(){return t},set:function(a){t=a}},labelThreshold:{get:function(){return p},set:function(a){p=a}},labelFormat:{get:function(){return k},set:function(a){k=a}},valueFormat:{get:function(){return j},set:function(a){j=a}},x:{get:function(){return f},set:function(a){f=a}},id:{get:function(){return h},set:function(a){h=a}},endAngle:{get:function(){return x},set:function(a){x=a}},startAngle:{get:function(){return v},set:function(a){v=a}},padAngle:{get:function(){return w},set:function(a){w=a}},cornerRadius:{get:function(){return y},set:function(a){y=a}},donutRatio:{get:function(){return z},set:function(a){z=a}},pieLabelsOutside:{get:function(){return m},set:function(a){m=a}},donutLabelsOutside:{get:function(){return n},set:function(a){n=a}},labelSunbeamLayout:{get:function(){return u},set:function(a){u=a}},donut:{get:function(){return q},set:function(a){q=a}},growOnHover:{get:function(){return s},set:function(a){s=a}},margin:{get:function(){return b},set:function(a){b.top="undefined"!=typeof a.top?a.top:b.top,b.right="undefined"!=typeof a.right?a.right:b.right,b.bottom="undefined"!=typeof a.bottom?a.bottom:b.bottom,b.left="undefined"!=typeof a.left?a.left:b.left}},y:{get:function(){return g},set:function(a){g=d3.functor(a)}},color:{get:function(){return i},set:function(a){i=nv.utils.getColor(a)}},labelType:{get:function(){return o},set:function(a){o=a||"key"}}}),nv.utils.initOptions(a),a},nv.models.pieChart=function(){"use strict";function a(h){return q.reset(),q.models(b),h.each(function(h){var i=d3.select(this);nv.utils.initSVG(i);var j=(e||parseInt(i.style("width"),10)||960)-d.left-d.right,n=(f||parseInt(i.style("height"),10)||400)-d.top-d.bottom;if(a.update=function(){i.transition().call(a)},a.container=this,k.setter(s(h),a.update).getter(r(h)).update(),k.disabled=h.map(function(a){return!!a.disabled}),!l){var p;l={};for(p in k)k[p]instanceof Array?l[p]=k[p].slice(0):l[p]=k[p]}if(!h||!h.length){var q=i.selectAll(".nv-noData").data([m]);return q.enter().append("text").attr("class","nvd3 nv-noData").attr("dy","-.7em").style("text-anchor","middle"),q.attr("x",d.left+j/2).attr("y",d.top+n/2).text(function(a){return a}),a}i.selectAll(".nv-noData").remove();var t=i.selectAll("g.nv-wrap.nv-pieChart").data([h]),u=t.enter().append("g").attr("class","nvd3 nv-wrap nv-pieChart").append("g"),v=t.select("g");u.append("g").attr("class","nv-pieWrap"),u.append("g").attr("class","nv-legendWrap"),g&&(c.width(j).key(b.x()),t.select(".nv-legendWrap").datum(h).call(c),d.top!=c.height()&&(d.top=c.height(),n=(f||parseInt(i.style("height"))||400)-d.top-d.bottom),t.select(".nv-legendWrap").attr("transform","translate(0,"+-d.top+")")),t.attr("transform","translate("+d.left+","+d.top+")"),b.width(j).height(n);var w=v.select(".nv-pieWrap").datum([h]);d3.transition(w).call(b),c.dispatch.on("stateChange",function(b){for(var c in b)k[c]=b[c];o.stateChange(k),a.update()}),b.dispatch.on("elementMouseout.tooltip",function(a){o.tooltipHide(a)}),o.on("changeState",function(b){"undefined"!=typeof b.disabled&&(h.forEach(function(a,c){a.disabled=b.disabled[c]}),k.disabled=b.disabled),a.update()})}),q.renderEnd("pieChart immediate"),a}var b=nv.models.pie(),c=nv.models.legend(),d={top:0,right:20,bottom:20,left:20},e=null,f=null,g=!0,h=nv.utils.defaultColor(),i=!0,j=function(a,b,c,d){return'<h3 style="background-color: '+c.color+'"><font color="white">'+a+"</font></h3><p>"+b+"</p>"},k=nv.utils.state(),l=null,m="No Data Available.",n=250,o=d3.dispatch("tooltipShow","tooltipHide","stateChange","changeState","renderEnd"),p=function(c,d){var e=b.x()(c.point),f=c.pos[0]+(d&&d.offsetLeft||0),g=c.pos[1]+(d&&d.offsetTop||0),h=b.valueFormat()(b.y()(c.point)),i=j(e,h,c,a);nv.tooltip.show([f,g],i,c.value<0?"n":"s",null,d)},q=nv.utils.renderWatch(o),r=function(a){return function(){return{active:a.map(function(a){return!a.disabled})}}},s=function(a){return function(b){void 0!==b.active&&a.forEach(function(a,c){a.disabled=!b.active[c]})}};return b.dispatch.on("elementMouseover.tooltip",function(a){a.pos=[a.pos[0]+d.left,a.pos[1]+d.top],o.tooltipShow(a)}),o.on("tooltipShow",function(a){i&&p(a)}),o.on("tooltipHide",function(){i&&nv.tooltip.cleanup()}),a.legend=c,a.dispatch=o,a.pie=b,a.options=nv.utils.optionsFunc.bind(a),a._options=Object.create({},{noData:{get:function(){return m},set:function(a){m=a}},tooltipContent:{get:function(){return j},set:function(a){j=a}},tooltips:{get:function(){return i},set:function(a){i=a}},showLegend:{get:function(){return g},set:function(a){g=a}},defaultState:{get:function(){return l},set:function(a){l=a}},color:{get:function(){return h},set:function(a){h=a,c.color(h),b.color(h)}},duration:{get:function(){return n},set:function(a){n=a,q.reset(n)}}}),nv.utils.inheritOptions(a,b),nv.utils.initOptions(a),a},$.fn.redraw=function(){$(this).each(function(){this.offsetHeight})},String.prototype.capitalizeFirstLetter=function(){return this.charAt(0).toUpperCase()+this.slice(1)},Number.prototype.roundDecimals=function(a){if(Math.floor(this.valueOf())===this.valueOf())return this.valueOf();var b=this.toString().split(".")[1].length;return a>b?this.valueOf():this.valueOf().toFixed(a)},function(a){var b=/([^&=]+)=?([^&]*)/g,c=function(a){return decodeURIComponent(a.replace(/\+/g," "))};a.parseParams=function(d){function e(b,c,d){if(c+="",-1!==c.indexOf(".")){var f=c.split("."),g=c.split(/\.(.+)?/)[1];b[f[0]]||(b[f[0]]={}),""!==g?e(b[f[0]],g,d):console.warn('parseParams :: empty property in key "'+c+'"')}else if(-1!==c.indexOf("[")){var f=c.split("[");c=f[0];var f=f[1].split("]"),h=f[0];""==h?(b||(b={}),b[c]&&a.isArray(b[c])||(b[c]=[]),b[c].push(d)):(b||(b={}),b[c]&&a.isArray(b[c])||(b[c]=[]),b[c][parseInt(h)]=d)}else b||(b={}),b[c]=d}d?d+="":d=window.location+"";var f,g={};if(d){if(-1!==d.indexOf("#")&&(d=d.substr(0,d.indexOf("#"))),-1===d.indexOf("?"))return{};if(d=d.substr(d.indexOf("?")+1,d.length),""==d)return{};for(;f=b.exec(d);){var h=c(f[1]),i=c(f[2]);e(g,h,i)}}return g}}(jQuery),function(a){a.encodeURL=function(b){function c(b,d){if(null===b)return"";if(a.isArray(b)){for(var e=0,f="",g=0;g<b.length;g++)e>0&&(f+="&"),f+=d+"[]="+b[g],e++;return f}if("object"==typeof b){var e=0,f="";for(var h in b)b.hasOwnProperty(h)&&(e>0&&(f+="&"),f+=c(b[h],d+"."+h),e++);return f}return d+"="+b}var d="?",e=0;for(var f in b)b.hasOwnProperty(f)&&(e>0&&(d+="&"),d+=c(b[f],f),e++);return d}}(jQuery);