L.Control.MapLegend=L.Control.extend({options:{position:"bottomright",numberOfColors:20,sortType:"color"},addLegendIcon:function(){this._legendDiv=L.DomUtil.create("div","info legend");legendDiv=this._legendDiv;L.easyButton("fa-info",function(){if(L.DomUtil.hasClass(legendDiv,"active")){legend.removeFrom(map);L.DomUtil.removeClass(legendDiv,"active")}else{legend.addTo(map);L.DomUtil.addClass(legendDiv,"active")}},"Toggle legend ON of OFF")},sortHashByValue:function(c){var b=[];for(var a in c){if(c.hasOwnProperty(a)){b.push([a,c[a]])}}b.sort(function(e,d){return d[1]-e[1]});return b},generatePalette:function(j){var e=[];var h=[];var d=["#FFB300","#803E75","#FF6800","#A6BDD7","#C10020","#CEA262","#817066","#007D34","#F6768E","#00538A","#FF7A5C","#53377A","#FF8E00","#B32851","#F4C800","#7F180D","#93AA00","#593315","#F13A13","#232C16"];var o=["#575757","#A0A0A0","#FFFFFF","#2A4BD7","#1D6914","#814A19","#8126C0","#9DAFFF","#81C57A","#E9DEBB","#AD2323","#29D0D0","#FFEE33","#FF9233","#FFCDF3"];var b=j.length,m=b;for(var g=0;g<this.options.numberOfColors;g++){if(typeof(j[g])!=="undefined"){var n=j[g][0];e[n]=d[g];b--}}h=e;var l=0.5/b,a=0.7;for(var k=0;k<b;k++){var f=m-b+k;var n=j[f][0];e[n]=colorLuminance("#FFFFFF",-a);a-=l}e.others="radial-gradient("+colorLuminance("#FFFFFF",-0.7)+", "+colorLuminance("#FFFFFF",-a)+")";h.others="radial-gradient("+colorLuminance("#FFFFFF",-0.7)+", "+colorLuminance("#FFFFFF",-a)+")";e.Unknown="black";h.Unknown="black";return[e,h]},Color:function Color(a){this.hex=a},constructColor:function(k){var e=k.hex.substring(1);var a=parseInt(e.substring(0,2),16)/255;var j=parseInt(e.substring(2,4),16)/255;var l=parseInt(e.substring(4,6),16)/255;var m=Math.max.apply(Math,[a,j,l]);var h=Math.min.apply(Math,[a,j,l]);var f=m-h;var i=0;var d=m;var c=0;if(d>0){c=f/d;if(c>0){if(a==m){i=60*(((j-h)-(l-h))/f);if(i<0){i+=360}}else{if(j==m){i=120+60*(((l-h)-(a-h))/f)}else{if(l==m){i=240+60*(((a-h)-(j-h))/f)}}}}}k.chroma=f;k.hue=i;k.sat=c;k.val=d;k.luma=0.3*a+0.59*j+0.11*l;k.red=parseInt(e.substring(0,2),16);k.green=parseInt(e.substring(2,4),16);k.blue=parseInt(e.substring(4,6),16);return k},sortColorsByHue:function(a){var d=[];var g=[];for(var f in a){if(a.hasOwnProperty(f)){d.push([f,a[f]])}}d.sort(function(i,h){i=i[1];h=h[1];return i.hue-h.hue});for(var c=0;c<d.length;c++){var b=d[c][0];var e=d[c][1];g[b]=e.hex}return g},outputColors:function(d){var c=[];var b=1;for(var a in palette){if(palette.hasOwnProperty(a)){if(b>legendSpecies-1){break}var e=new this.Color(palette[a]);this.constructColor(e);c[a]=e;b++}}return this.sortColorsByHue(c)},generateHTML:function(b){var e="";var a=1;for(var f in b){if(b.hasOwnProperty(f)){if(a>legendSpecies-1){e+='<i style="background:'+b.others+';"></i> Others<br />';$("#legend").html(e);break}var d=f.replace(/^(\w{2})\S+\s(\w+)/,"$1. $2");e+='<i style="background:'+b[f]+';" title="'+f+'"></i> '+(f?"<em>"+d+"</em><br>":"+");a++}}if($("#view-mode").val()==="ir"){e+='<div class="data-layer-legend" style="border: 0">';e+="<p>Resistance</p>";e+='<div class="min-value" style="border: 0">Low</div>';e+='<div class="scale-bars">';var c=L.ColorBrewer.Diverging.RdYlBu[10].slice();$.each(c.reverse(),function(g,h){e+='<i style="margin: 0; border-radius: 0; border: 0; color: '+h+"; width: 10px; background-color: "+h+' ;"></i>'});e+='</div><div class="max-value" style="border: 0;">High</div></div><p style="font-size: smaller; word-wrap: break-word; width: 200px; margin-top: 20px;">Values have been rescaled globally and only give a relative indication of resistance/susceptibility</p>'}legend.onAdd=function(g){this._legendDiv.innerHTML=e;return this._legendDiv};if(L.DomUtil.hasClass(this._legendDiv,"active")){legend.removeFrom(map);legend.addTo(map)}},populateLegend:function(k,d){var e="geohash_2";if(!d){d="species_category"}var q=e+","+d;var r=k.facet_counts.facet_pivot[q];var m=[];for(var l in r){if(r.hasOwnProperty(l)){var f=r[l].count;var h=r[l].pivot;for(var a in h){if(h.hasOwnProperty(a)){var i=h[a].count/f;var j=h[a].value;var g=parseInt(a);var o;switch(g){case 1:o=7*i;break;case 2:o=3*i;break;case 3:o=1*i;break;default:o=0;break}if(m.hasOwnProperty(j)){m[j]+=o}else{m[j]=o}}}}}var p=this.sortHashByValue(m);var b=[];var n=[];b=this.generatePalette(p,legendSpecies,1);palette=b[0];n=b[1];var c;if(this.options.sortType==="name"){c=n}else{c=this.outputColors(n)}this.generateHTML(c);loadSolr({clear:1,zoomLevel:map.getZoom()})}});L.control.legend=function(b,a){var c=new L.Control.MapLegend(a);c.addLegendIcon();$.getJSON(b,function(d){c.populateLegend(d,"species_category")});return c};