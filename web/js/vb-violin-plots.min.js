function addViolin(i,h,e,c,a,d,f,g){var l,o=((a[1]-a[0])/d)/2;var k=d3.scale.linear().range([c/2,0]).domain([0,Math.max(d3.max(h,function(p){return p.count*1.5}))]);if(g){l=d3.scale.log().range(e).domain(a).nice();console.log("Printing log in violin")}else{l=d3.scale.linear().range(e).domain(a).nice()}console.log("Now printing scaled violin area data");var b=d3.svg.area().interpolate(f).x(function(p){return l(p.val+o)}).y0(c/2).y1(function(p){return k(p.count)});var n=d3.svg.line().interpolate(f).x(function(p){return l(p.val+o)}).y(function(p){return k(p.count)});var m=i.append("g");var j=i.append("g");m.append("path").datum(h).attr("class","area").attr("d",b);m.append("path").datum(h).attr("class","violin").attr("d",n);j.append("path").datum(h).attr("class","area").attr("d",b);j.append("path").datum(h).attr("class","violin").attr("d",n);m.attr("transform","rotate(90,0,0)  translate(0,-"+c+")");j.attr("transform","rotate(90,0,0) scale(1,-1)")}function addBoxPlot(h,e,p,d,b,a,q,f){if(f){var l=d3.scale.log().range(d).domain(a).nice();console.log("Printing log in boxplot")}else{var l=d3.scale.linear().range(d).domain(a).nice()}var m=d3.scale.linear().range([0,b]);var c=0.5-q/2;var o=0.5+q/2;var j=[0.05,0.25,0.5,0.75,0.95];for(var g=0;g<j.length;g++){j[g]=l(e[g])}var r=h.append("g");r.append("rect").attr("class","boxplot fill").attr("x",m(c)).attr("width",m(o)-m(c)).attr("y",j[3]).attr("height",-j[3]+j[1]);var n=[0,2,4];var k=["","median",""];for(var g=0;g<n.length;g++){r.append("line").attr("class","boxplot "+k[g]).attr("x1",m(c)).attr("x2",m(o)).attr("y1",j[n[g]]).attr("y2",j[n[g]])}n=[[0,1],[3,4]];for(g=0;g<n.length;g++){r.append("line").attr("class","boxplot").attr("x1",m(0.5)).attr("x2",m(0.5)).attr("y1",j[n[g][0]]).attr("y2",j[n[g][1]])}r.append("rect").attr("class","boxplot").attr("x",m(c)).attr("width",m(o)-m(c)).attr("y",j[3]).attr("height",-j[3]+j[1]);r.append("circle").attr("class","boxplot mean").attr("cx",m(0.5)).attr("cy",l(p)).attr("r",m(q/5))}function addBeeswarm(e,j,c,b,a,f,d){var g,k=d3.select("#beeSwarmTooltip");if(d){g=d3.scale.log().range(c).domain(a).nice()}else{g=d3.scale.linear().range(c).domain(a).nice()}var h=d3.scale.linear().range(b).domain(f).nice();var i=e.append("g");j.swarm.forEach(function(o,n){var m=j.data[n].species,l=j.data[n].insecticide;i.append("circle").attr("cx",h(o.x)).attr("cy",g(o.y)).attr("r",4).style("fill",palette[m]).on("mouseover",function(p){k.transition().duration(200).style("opacity",1);k.html(m+"<br/> ("+l+": "+j.data[n].y+")").style("left",(d3.event.pageX+5)+"px").style("top",(d3.event.pageY-28)+"px")}).on("mouseout",function(p){k.transition().duration(500).style("opacity",0)})})}function createBeeViolinPlot(e,b,d){if($("#view-mode").val()==="smpl"){return}var a=this;var c="http://funcgen.vectorbase.org/popbio-map-preview/asolr/solr/vb_popbio/irViolinStats?&"+qryUrl+b+"&json.wrf=?&callback=?";$(e).empty();$.getJSON(c).done(function(g){if(g.facets.count&&g.facets.count>0){var f=$("<select />").attr("id","bgPlotType");$("<option/>",{text:"Phenotypes matching search",value:1}).appendTo(f);$("<option/>",{text:"Phenotypes visible on map",value:2}).appendTo(f);$("<option/>",{text:"All phenotypes",value:3}).appendTo(f);f.appendTo($(e));var h=$("<select />").attr("id","plotType");g.facets.vtypes.buckets.forEach(function(k){var j=0;k.vunits.buckets.forEach(function(l){var m=k.val+" ("+l.val+"): "+l.count+" phenotypes";$("<option/>",{text:m,value:l.val,data:{phenotype_value_type_s:k.val,phenotype_value_unit_s:l.val,count:l.count,min:l.pmin,max:l.pmax}}).appendTo(h)})});h.appendTo($(e));var i=h.find(":selected").data();buildPlot(e,b,i);h.change(function(){i=h.find(":selected").data();buildPlot(e,b,i)});f.change(function(){i=h.find(":selected").data();buildPlot(e,b,i)})}}).fail(function(){console.log("Failed while loading irViolinStats")})}function buildPlot(b,i,v){var d=v.count,o=v.min,r=v.max,g=v.phenotype_value_type_s,s=v.phenotype_value_unit_s;var m=380,j=300;var l=d3.select(b);var p=25,f="basis";if(d3.select("#beeViolinPlot")){d3.select("#beeViolinPlot").remove()}var k=l.append("svg").attr("style","width: 380px; height: 500px; border: 0; padding-top:20px").attr("id","beeViolinPlot");var e=150,q=10;var h={top:30,bottom:30,left:30,right:20};var t={pmean:"avg(phenotype_value_f)",pperc:"percentile(phenotype_value_f,5,25,50,75,95)",pmin:"min(phenotype_value_f)",pmax:"max(phenotype_value_f)",denplot:{type:"range",field:"phenotype_value_f",gap:(r-o)/p,start:o,end:r}};var n,u;switch($("#bgPlotType").val()){case"1":n="http://funcgen.vectorbase.org/popbio-map-preview/asolr/solr/vb_popbio/irBeeswarm?&"+qryUrl+'&fq=phenotype_value_type_s:"'+g+'"&fq=phenotype_value_unit_s:"'+s+'"&json.wrf=?&callback=?';u="http://funcgen.vectorbase.org/popbio-map-preview/asolr/solr/vb_popbio/irViolin?&"+qryUrl+'&fq=phenotype_value_type_s:"'+g+'"&fq=phenotype_value_unit_s:"'+s+'"&json.facet='+JSON.stringify(t)+"&json.wrf=?&callback=?";break;case"2":n="http://funcgen.vectorbase.org/popbio-map-preview/asolr/solr/vb_popbio/irBeeswarm?&"+qryUrl+i+'&fq=phenotype_value_type_s:"'+g+'"&fq=phenotype_value_unit_s:"'+s+'"&json.wrf=?&callback=?';u="http://funcgen.vectorbase.org/popbio-map-preview/asolr/solr/vb_popbio/irViolin?&"+qryUrl+i+'&fq=phenotype_value_type_s:"'+g+'"&fq=phenotype_value_unit_s:"'+s+'"&json.facet='+JSON.stringify(t)+"&json.wrf=?&callback=?";break;case"3":n='http://funcgen.vectorbase.org/popbio-map-preview/asolr/solr/vb_popbio/irBeeswarm?&q=*&fq=phenotype_value_type_s:"'+g+'"&fq=phenotype_value_unit_s:"'+s+'"&json.wrf=?&callback=?';u='http://funcgen.vectorbase.org/popbio-map-preview/asolr/solr/vb_popbio/irViolin?&q=*&fq=phenotype_value_type_s:"'+g+'"&fq=phenotype_value_unit_s:"'+s+'"&json.facet='+JSON.stringify(t)+"&json.wrf=?&callback=?";break;default:break}var c=$.getJSON(u);c.done(function(P){var Q=k.append("g").attr("transform","translate("+(0*(e+q)+h.left)+",0)");var O=P.response.numFound,C=P.facets.pmin,E=P.facets.pmax;if(s==="percent"){C=0;E=100}var L=[C,E];var B,A,w,x=e/2,F,G;var I,y,H,K;a(L);if(O>50){if(P.facets.count>0){I=P.facets.denplot.buckets;y=P.facets.pmean;H=P.facets.pperc;K=P.facets.count;addViolin(Q,I,[j-h.bottom,h.top],e,L,p,f,false);addBoxPlot(Q,H,y,[j-h.bottom,h.top],e,L,0.15,false)}}else{if(O>=10&&O<=50){var J=$.getJSON(n);J.fail(function(){console.log("Failed while loading irBeeswarm")});J.done(function(R){if(R.grouped.phenotype_value_type_s.matches>0){A=R.grouped.phenotype_value_type_s.groups[0];x=e/2;B=[];F=4*(r-o)/e;A.doclist.docs.forEach(function(T,S){B.push({x:undefined,y:T.phenotype_value_f,species:T.species_category[0],insecticide:T.insecticide_s})});w=new Beeswarm(B,0,F);G=[(e-8*w.maxPoints)/2,(e-8*w.maxPoints)/2+8*w.maxPoints];if(8*w.maxPoints>e){G=[0,e]}addBeeswarm(Q,w,[j-h.bottom,h.top],G,L,w.domain,false)}if(P.facets.count>0){I=P.facets.denplot.buckets;y=P.facets.pmean;H=P.facets.pperc;K=P.facets.count;addBoxPlot(Q,H,y,[j-h.bottom,h.top],e,L,0.15,false)}})}else{var J=$.getJSON(n);J.fail(function(){console.log("Failed while loading irBeeswarm")});J.done(function(R){if(R.grouped.phenotype_value_type_s.matches>0){A=R.grouped.phenotype_value_type_s.groups[0];B=[];F=4*(r-o)/e;A.doclist.docs.forEach(function(T,S){B.push({x:undefined,y:T.phenotype_value_f,species:T.species_category[0],insecticide:T.insecticide_s})});w=new Beeswarm(B,0,F);G=[(e-8*w.maxPoints)/2,(e-8*w.maxPoints)/2+8*w.maxPoints];if(8*w.maxPoints>e){G=[0,e]}addBeeswarm(Q,w,[j-h.bottom,h.top],G,L,w.domain,false)}})}}var D="http://funcgen.vectorbase.org/popbio-map-preview/asolr/solr/vb_popbio/irBeeswarm?&"+qryUrl+'&fq=phenotype_value_type_s:"'+g+'"&fq=phenotype_value_unit_s:"'+s+'"'+i+"&json.wrf=?&callback=?";var N="http://funcgen.vectorbase.org/popbio-map-preview/asolr/solr/vb_popbio/irViolin?&"+qryUrl+'&fq=phenotype_value_type_s:"'+g+'"&fq=phenotype_value_unit_s:"'+s+'"&json.facet='+JSON.stringify(t)+i+"&json.wrf=?&callback=?";var z=$.getJSON(D),M=$.getJSON(N);$.when(z,M).done(function(Y,S){var U=k.append("g").attr("transform","translate("+(1*(e+q)+h.left)+",0)");var X,V,ab,ac=e/2,W,R;var aa,T,ad,Z;if(d>50){if(S[0].facets.count>0){aa=S[0].facets.denplot.buckets;T=S[0].facets.pmean;ad=S[0].facets.pperc;Z=S[0].facets.count;addViolin(U,aa,[j-h.bottom,h.top],e,L,p,f,false);addBoxPlot(U,ad,T,[j-h.bottom,h.top],e,L,0.15,false)}}else{if(d>=10&&d<=50){if(Y[0].grouped.phenotype_value_type_s.matches>0){V=Y[0].grouped.phenotype_value_type_s.groups[0];ac=e/2;X=[];W=4*(r-o)/e;V.doclist.docs.forEach(function(af,ae){X.push({x:undefined,y:af.phenotype_value_f,species:af.species_category[0],insecticide:af.insecticide_s})});ab=new Beeswarm(X,0,W);R=[(e-8*ab.maxPoints)/2,(e-8*ab.maxPoints)/2+8*ab.maxPoints];if(8*ab.maxPoints>e){R=[0,e]}addBeeswarm(U,ab,[j-h.bottom,h.top],R,L,ab.domain,false)}if(S[0].facets.count>0){aa=S[0].facets.denplot.buckets;T=S[0].facets.pmean;ad=S[0].facets.pperc;Z=S[0].facets.count;addBoxPlot(U,ad,T,[j-h.bottom,h.top],e,L,0.15,false)}}else{if(Y[0].grouped.phenotype_value_type_s.matches>0){V=Y[0].grouped.phenotype_value_type_s.groups[0];X=[];W=4*(r-o)/e;V.doclist.docs.forEach(function(af,ae){X.push({x:undefined,y:af.phenotype_value_f,species:af.species_category[0],insecticide:af.insecticide_s})});ab=new Beeswarm(X,0,W);R=[(e-8*ab.maxPoints)/2,(e-8*ab.maxPoints)/2+8*ab.maxPoints];if(8*ab.maxPoints>e){R=[0,e]}addBeeswarm(U,ab,[j-h.bottom,h.top],R,L,ab.domain,false)}}}});z.fail(function(){console.log("Failed while loading irBeeswarm")});M.fail(function(){console.log("Failed while loading irViolin")})});c.fail(function(){console.log("Failed while loading irViolin")});function a(x){var y=d3.scale.linear().range([j-h.bottom,h.top]).domain(x).nice();var w=d3.svg.axis().scale(y).orient("left");k.append("g").attr("class","axis").attr("transform","translate("+h.left+",0)").call(w);k.append("text").attr("x",h.left+e+q/2).attr("y",10).style("text-anchor","middle").text(g.capitalizeFirstLetter());k.append("text").attr("x",h.left+e/2).attr("y",j-h.bottom/2).style("text-anchor","middle").text("Background");k.append("text").attr("x",h.left+e+q+e/2).attr("y",j-h.bottom/2).style("text-anchor","middle").text("Selection")}};