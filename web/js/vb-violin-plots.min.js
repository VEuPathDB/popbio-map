function addViolin(h,g,i,b,e,c,d,f){var o=(e[1]/c)/2;var k=d3.scale.linear().range([b/2,0]).domain([0,Math.max(d3.max(g,function(p){return p.count*1.5}))]);if(f){var l=d3.scale.log().range(i).domain(e).nice();console.log("Printing log in violin")}else{var l=d3.scale.linear().range(i).domain(e).nice()}console.log("Now printing scaled violin area data");var a=d3.svg.area().interpolate(d).x(function(p){if(d=="step-before"){return l(p.val+o)}console.log("*"+p.val+":"+l(p.val));return l(p.val)}).y0(b/2).y1(function(p){return k(p.count)});var n=d3.svg.line().interpolate(d).x(function(p){if(d=="step-before"){return l(p.val+o)}return l(p.val)}).y(function(p){return k(p.count)});var m=h.append("g");var j=h.append("g");m.append("path").datum(g).attr("class","area").attr("d",a);m.append("path").datum(g).attr("class","violin").attr("d",n);j.append("path").datum(g).attr("class","area").attr("d",a);j.append("path").datum(g).attr("class","violin").attr("d",n);var l=b;m.attr("transform","rotate(90,0,0)  translate(0,-"+b+")");j.attr("transform","rotate(90,0,0) scale(1,-1)")}function addBoxPlot(g,c,p,h,a,d,q,e){if(e){var l=d3.scale.log().range(h).domain(d).nice();console.log("Printing log in boxplot")}else{var l=d3.scale.linear().range(h).domain(d).nice()}var m=d3.scale.linear().range([0,a]);var b=0.5-q/2;var o=0.5+q/2;var j=[0.05,0.25,0.5,0.75,0.95];for(var f=0;f<j.length;f++){j[f]=l(c[f])}var r=g.append("g");r.append("rect").attr("class","boxplot fill").attr("x",m(b)).attr("width",m(o)-m(b)).attr("y",j[3]).attr("height",-j[3]+j[1]);var n=[0,2,4];var k=["","median",""];for(var f=0;f<n.length;f++){r.append("line").attr("class","boxplot "+k[f]).attr("x1",m(b)).attr("x2",m(o)).attr("y1",j[n[f]]).attr("y2",j[n[f]])}n=[[0,1],[3,4]];for(f=0;f<n.length;f++){r.append("line").attr("class","boxplot").attr("x1",m(0.5)).attr("x2",m(0.5)).attr("y1",j[n[f][0]]).attr("y2",j[n[f][1]])}r.append("rect").attr("class","boxplot").attr("x",m(b)).attr("width",m(o)-m(b)).attr("y",j[3]).attr("height",-j[3]+j[1]);r.append("circle").attr("class","boxplot mean").attr("cx",m(0.5)).attr("cy",l(p)).attr("r",m(q/5))}function addBeeswarm(d,j,e,b,a,f,c){var k=d3.select("#beeSwarmTooltip");if(c){var g=d3.scale.log().range(e).domain(a).nice()}else{var g=d3.scale.linear().range(e).domain(a).nice()}var h=d3.scale.linear().range([0,b]).domain(f).nice();var i=d.append("g");j.swarm.forEach(function(o,n){var m=j.data[n].species,l=j.data[n].insecticide;i.append("circle").attr("cx",h(o.x)).attr("cy",g(o.y)).attr("r",4).style("fill",palette[m]).on("mouseover",function(p){k.transition().duration(200).style("opacity",1);k.html(m+"<br/> ("+l+": "+j.data[n].y+")").style("left",(d3.event.pageX+5)+"px").style("top",(d3.event.pageY-28)+"px")}).on("mouseout",function(p){k.transition().duration(500).style("opacity",0)})})}function createBeeViolinPlot(g,c,f){if($("#view-mode").val()==="smpl"){return}var b=this;var e=280;var a=300;var d="http://funcgen.vectorbase.org/popbio-map-preview/asolr/solr/vb_popbio/irViolinStats?&"+qryUrl+c+"&json.wrf=?&callback=?";$.getJSON(d).done(function(h){$(g).empty();if(h.facets.count&&h.facets.count>0){var i=$("<select />").attr("id","plotType");h.facets.vtypes.buckets.forEach(function(l){var k=0;l.vunits.buckets.forEach(function(m){var n=l.val+" ("+m.val+"): "+m.count+" phenotypes";$("<option/>",{text:n,value:m.val,data:{phenotype_value_type_s:l.val,phenotype_value_unit_s:m.val,count:m.count,min:m.pmin,max:m.pmax}}).appendTo(i)})});i.appendTo($(g));var j=i.find(":selected").data();buildPlot(g,c,j);i.change(function(){j=i.find(":selected").data();buildPlot(g,c,j)})}}).fail(function(){console.log("Failed while loading irViolinStats")})}function buildPlot(f,p,G){var j=G.count,v=G.min,z=G.max,n=G.phenotype_value_type_s,E=G.phenotype_value_unit_s;var t=250,q=300;var s=d3.select(f);if(E==="percent"){v=0;z=100}if(d3.select("#beeViolinPlot")){d3.select("#beeViolinPlot").remove()}var r=s.append("svg").attr("style","width: 400px; height: 500px; border: 0; padding-top:20px").attr("id","beeViolinPlot");var u,l=100,y=10;var o={top:30,bottom:30,left:30,right:20};var F={pmean:"avg(phenotype_value_f)",pperc:"percentile(phenotype_value_f,5,25,50,75,95)",denplot:{type:"range",field:"phenotype_value_f",gap:(z-v)/20,start:v,end:z}};var c="http://funcgen.vectorbase.org/popbio-map-preview/asolr/solr/vb_popbio/irBeeswarm?&"+qryUrl+'&fq=phenotype_value_type_s:"'+n+'"&fq=phenotype_value_unit_s:"'+E+'"'+p+"&json.wrf=?&callback=?";var k="http://funcgen.vectorbase.org/popbio-map-preview/asolr/solr/vb_popbio/irViolin?&"+qryUrl+'&fq=phenotype_value_type_s:"'+n+'"&fq=phenotype_value_unit_s:"'+E+'"&json.facet='+JSON.stringify(F)+p+"&json.wrf=?&callback=?";var C=r.append("g").attr("transform","translate("+(0*(l+y)+o.left)+",0)");function a(){var i=d3.scale.linear().range([q-o.bottom,o.top]).domain(u).nice();var g=d3.svg.axis().scale(i).orient("left");r.append("g").attr("class","axis").attr("transform","translate("+o.left+",0)").call(g);r.append("text").attr("x",o.left+l+y/2).attr("y",10).style("text-anchor","middle").text(n.capitalizeFirstLetter());r.append("text").attr("x",o.left+l/2).attr("y",290).style("text-anchor","middle").text("Background");r.append("text").attr("x",o.left+l+y+l/2).attr("y",290).style("text-anchor","middle").text("Selection")}if(j>1000){u=[v,z]}else{u=[v,z];var x=$.getJSON(c),D=$.getJSON(k);$.when(x,D).done(function(J,g){var P;if(J[0].grouped.phenotype_value_type_s.matches>0){var H=J[0].grouped.phenotype_value_type_s.groups[0];var M,N=l/2;m=[];var I=10*(z-v)/240;H.doclist.docs.forEach(function(R,Q){m.push({x:undefined,y:R.phenotype_value_f,species:R.species_category[0],insecticide:R.insecticide_s})});M=new Beeswarm(m,0,I);a();addBeeswarm(C,M,[270,30],l,u,M.domain,false)}if(g[0].facets.count>0){var L=g[0].facets.denplot.buckets,i=g[0].facets.pmean,O=g[0].facets.pperc,K=g[0].facets.count;addBoxPlot(C,O,i,[270,30],l,u,0.15,false)}});x.fail(function(){console.log("Failed while loading irBeeswarm")});D.fail(function(){console.log("Failed while loading irViolin")})}return;var b,h=100,w=10,B=300,d=l/2,e=4,m=[],A;for(A=0;A<h;++A){m.push({x:1,y:Math.floor(Math.random()*(B-w+1))+w})}b=new Beeswarm(m,d,e);addBeeswarm(C,b.swarm,[270,30],l,u,b.domain,false)}function Violin(b,o){var n=this;var d=250;var l=300;var c,f,e,h,m,j,g,k,i;this.divback=b.attr("class","popup-back").attr("id","violin-popup-back");this.div=this.divback.append("div").attr("id","violin-popup").attr("class","popup").append("div").attr("class","violin-div").attr("id","violin");var a='/solr/ninjadata/select?q={!join from=member_ids to=id}analysis_id:"AnOrthoMap-v1.01"&rows=0&wt=json&json.nl=map&json.facet={evorMean:"avg(evo_rate_f)",evoPerc:"percentile(evo_rate_f,5,25,50,75,95)",duplMean:"avg(avg_para_count_f)",duplPerc:"percentile(avg_para_count_f,5,25,50,75,95)",univMean:"avg(frac_species_f)",univPerc:"percentile(frac_species_f,5,25,50,75,95)",evor: {range : {field:evo_rate_f, start:0, end:4, gap:0.13}},dupl: {range : {field:avg_para_count_f, start:1, end:31, gap:1.03}},univ: {range : {field:frac_species_f, start:0, end:1, gap:0.033}}}';console.log(a);d3.json(a,function(p,q){if(p){return console.warn(p)}if(defined(q.facets.count)&&q.facets.count>0){c=q.facets.evor.buckets;f=q.facets.evorMean;e=q.facets.evoPerc;h=q.facets.dupl.buckets;m=q.facets.duplMean;j=q.facets.duplPerc;g=q.facets.univ.buckets;k=q.facets.univMean;i=q.facets.univPerc}});this.comm.ready(this);this.comm.on("violin.violin"+this.id,function(r){if(!r||!r.source||r.source==n||!r.object){return}if(!/^MZ.+/.test(r.object.branchset[0].name)){return}var s=r.object.branchset[0].x,q=r.object.branchset[0].y;console.log("lakis:"+r.object.branchset[0].x);var p='/solr/ninjadata/select?rows=0&wt=json&json.nl=map&q={!join from=member_ids to=id} analysis_id:"AnOrthoMap-v1.01" AND type:cluster AND x_coord_i:'+s+" AND y_coord_i:"+q+'&json.facet={evorMean:"avg(evo_rate_f)",evoPerc:"percentile(evo_rate_f,5,25,50,75,95)",duplMean:"avg(avg_para_count_f)",duplPerc:"percentile(avg_para_count_f,5,25,50,75,95)",univMean:"avg(frac_species_f)",univPerc:"percentile(frac_species_f,5,25,50,75,95)",evor: {range : {field:evo_rate_f, start:0, end:4, gap:0.13}},dupl: {range : {field:avg_para_count_f, start:1, end:31, gap:1.03}},univ: {range : {field:frac_species_f, start:0, end:1, gap:0.033}}}';console.log(p);d3.json(p,function(D,J){if(D){return console.warn(D)}if(defined(J.facets.count)&&J.facets.count>0){n.div.selectAll("*").remove();n.div.append("div").attr("class","cancel").on("click",function(){d3.select("#violin-popup-back").style("display","none")});var v={top:30,bottom:30,left:30,right:20};var y=100;var F=10;var w=[0,4];var t=20;var E="violin";var u="basis";var C=d3.scale.linear().range([l-v.bottom,v.top]).domain(w).nice();var I=d3.svg.axis().scale(C).orient("left");var x=n.div.append("svg").attr("style","width: 32%; height: 100%; border: 0");x.append("text").attr("x",v.left+y+F/2).attr("y",10).style("text-anchor","middle").text("Evolutionary Rate");x.append("text").attr("x",v.left+y/2).attr("y",290).style("text-anchor","middle").text("All");x.append("text").attr("x",v.left+y+F+y/2).attr("y",290).style("text-anchor","middle").text("Cluster");var A=x.append("g").attr("transform","translate("+(0*(y+F)+v.left)+",0)");addViolin(A,c,[l-v.bottom,v.top],y,w,t,u,0.25,false);addBoxPlot(A,e,f,[l-v.bottom,v.top],y,w,0.15,false);A=x.append("g").attr("transform","translate("+(1*(y+F)+v.left)+",0)");addViolin(A,J.facets.evor.buckets,[l-v.bottom,v.top],y,w,t,u,0.25,false);addBoxPlot(A,J.facets.evoPerc,J.facets.evorMean,[l-v.bottom,v.top],y,w,0.15,false);x.append("g").attr("class","axis").attr("transform","translate("+v.left+",0)").call(I);w=[1,31];var z=d3.scale.log().range([l-v.bottom,v.top]).domain(w).nice();var G=d3.svg.axis().scale(z).orient("left").ticks(3,",.1s").tickSize(6,0);x=n.div.append("svg").attr("style","width: 32%; height: 100%; border: 0");x.append("text").attr("x",v.left+y+F/2).attr("y",10).style("text-anchor","middle").text("Duplicability");x.append("text").attr("x",v.left+y/2).attr("y",290).style("text-anchor","middle").text("All");x.append("text").attr("x",v.left+y+F+y/2).attr("y",290).style("text-anchor","middle").text("Cluster");A=x.append("g").attr("transform","translate("+(0*(y+F)+v.left)+",0)");addViolin(A,h,[l-v.bottom,v.top],y,w,t,u,0.25,true);addBoxPlot(A,j,m,[l-v.bottom,v.top],y,w,0.15,true);A=x.append("g").attr("transform","translate("+(1*(y+F)+v.left)+",0)");addViolin(A,J.facets.dupl.buckets,[l-v.bottom,v.top],y,w,t,u,0.25,true);addBoxPlot(A,J.facets.duplPerc,J.facets.duplMean,[l-v.bottom,v.top],y,w,0.15,true);x.append("g").attr("class","axis").attr("transform","translate("+v.left+",0)").call(G);w=[0,1];var B=d3.scale.linear().range([l-v.bottom,v.top]).domain(w).nice();var H=d3.svg.axis().scale(B).orient("left");x=n.div.append("svg").attr("style","width: 32%; height: 100%; border: 0");x.append("text").attr("x",v.left+y+F/2).attr("y",10).style("text-anchor","middle").text("Universality");x.append("text").attr("x",v.left+y/2).attr("y",290).style("text-anchor","middle").text("All");x.append("text").attr("x",v.left+y+F+y/2).attr("y",290).style("text-anchor","middle").text("Cluster");A=x.append("g").attr("transform","translate("+(0*(y+F)+v.left)+",0)");addViolin(A,g,[l-v.bottom,v.top],y,w,t,u,0.25,false);addBoxPlot(A,i,k,[l-v.bottom,v.top],y,w,0.15,false);A=x.append("g").attr("transform","translate("+(1*(y+F)+v.left)+",0)");addViolin(A,J.facets.univ.buckets,[l-v.bottom,v.top],y,w,t,u,0.25,false);addBoxPlot(A,J.facets.univPerc,J.facets.univMean,[l-v.bottom,v.top],y,w,0.15,false);x.append("g").attr("class","axis").attr("transform","translate("+v.left+",0)").call(H);d3.select("#violin-popup-back").style("display","block")}})})};