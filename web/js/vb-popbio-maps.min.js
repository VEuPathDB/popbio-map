function loadSolr(e){var a=e.clear;var f=e.zoomLevel;var g=geohashLevel(f,"geohash");if(f>11){loadSmall(1,f);return}var d=[];var c=function(v){$("#markersCount").html(v.response.numFound+" samples in current view");if(v.response.numFound===0){if(a){assetLayerGroup.clearLayers()}map.spin(false);return}var r;var u;var t;var n=v.stats.stats_fields;var o=v.facet_counts;switch(f){case 1:case 2:r=n.geo_coords_ll_0___tdouble.facets.geohash_1;u=n.geo_coords_ll_1___tdouble.facets.geohash_1;t=o.facet_pivot["geohash_1,species_category"];break;case 3:case 4:case 5:r=n.geo_coords_ll_0___tdouble.facets.geohash_2;u=n.geo_coords_ll_1___tdouble.facets.geohash_2;t=o.facet_pivot["geohash_2,species_category"];break;case 6:case 7:r=n.geo_coords_ll_0___tdouble.facets.geohash_3;u=n.geo_coords_ll_1___tdouble.facets.geohash_3;t=o.facet_pivot["geohash_3,species_category"];break;case 8:case 9:r=n.geo_coords_ll_0___tdouble.facets.geohash_4;u=n.geo_coords_ll_1___tdouble.facets.geohash_4;t=o.facet_pivot["geohash_4,species_category"];break;case 10:case 11:r=n.geo_coords_ll_0___tdouble.facets.geohash_5;u=n.geo_coords_ll_1___tdouble.facets.geohash_5;t=o.facet_pivot["geohash_5,species_category"];break;default:r=n.geo_coords_ll_0___tdouble.facets.geohash_6;u=n.geo_coords_ll_1___tdouble.facets.geohash_6;t=o.facet_pivot["geohash_6,species_category"];break}smallClusters=[];var i=[];var h=[];var q=[];for(var p in r){if(r.hasOwnProperty(p)){var l=r[p].count;if(l<2){smallClusters.push(p);continue}t.forEach(function(y,z){i[y.value]=y.count;var x=[];var w=[];if(y.pivot){y.pivot.forEach(function(B){var A=B.value,C=B.count;x[A]=C;w.push({label:A.replace(/sensu lato/,"sl").replace(/chromosomal form/,"cf"),value:C,color:(palette[A]?palette[A]:"#000000")})})}else{console.log("ERROR: Pivot for element "+y.value+"appears to be empty")}h[y.value]=x;q[y.value]=w});var j={};j.term=p;j.count=r[p].count;j.latLng=[r[p].mean,u[p].mean];j.bounds=[[r[p].min,u[p].min],[r[p].max,u[p].max]];j.population=i[p];j.stats=h[p];j.fullstats=q[p];d.push(j)}}var m={};m.terms=d;var s={recordsField:"terms",latitudeField:"latLng.0",longitudeField:"latLng.1",displayOptions:{count:{title:function(w){return w}}},layerOptions:{fill:false,stroke:false,weight:0,color:"#80FF00",dropShadow:false},setIcon:function(w){var x=40;return new L.Icon.Canvas({iconSize:new L.Point(x,x),className:"marker-cluster",population:w.population,stats:w.stats})},onEachRecord:function(x,w){x.on("dblclick",function(){map.fitBounds(w.bounds)});x.on("click",function(){updatePieChart(w.population,w.fullstats)});x.on("mouseover",function(y){});x.on("mouseout",function(){})}};var k=new L.MarkerDataLayer(m,s);if(a){assetLayerGroup.clearLayers();assetLayerGroup.addLayer(k)}else{assetLayerGroup.addLayer(k)}if(smallClusters.length>0){loadSmall(0,f)}map.spin(false)};var b=solrPopbioUrl+$("#view-mode").val()+"Geoclust?"+qryUrl+buildBbox(map.getBounds())+"&stats.facet="+g+"&facet.pivot="+g+",species_category&json.wrf=?&callback=?";map.spin(true);$.getJSON(b,c).fail(function(){console.log("Ahhh")})}function loadSmall(g,f){var e=new PruneClusterForLeaflet(100);e.BuildLeafletClusterIcon=function(i){var j=new L.Icon.MarkerCluster();j.stats=i.stats;j.population=i.population;return j};L.Icon.MarkerCluster=L.Icon.extend({options:{iconSize:new L.Point(40,40),className:"prunecluster leaflet-markercluster-icon"},createIcon:function(){var j=document.createElement("canvas");this._setIconStyles(j,"icon");var i=this.options.iconSize;j.width=i.x;j.height=i.y;this.draw(j.getContext("2d"),i.x,i.y);return j},createShadow:function(){return null},draw:function(j){var m=Math.PI*2;var i=Math.PI*1.5;var n=this.options.iconSize.x,l=n/2,k=n/2.5;for(var q in this.stats){if(this.stats.hasOwnProperty(q)){var r=this.stats[q]/this.population;if(r>0){j.beginPath();j.moveTo(l,l);if(palette.hasOwnProperty(q)){j.fillStyle=palette[q]}else{j.fillStyle=palette.others}var p=i,o=i+r*m;if(o<p){p=i}j.arc(l,l,l,p,o);i=i+r*m;j.lineTo(l,l);j.fill();j.closePath()}}}j.beginPath();j.fillStyle="white";j.arc(l,l,k,0,Math.PI*2);j.fill();j.closePath();j.fillStyle="#555";j.textAlign="center";j.textBaseline="middle";j.font="bold 12px sans-serif";j.fillText(this.population,l,l,n)}});e.BuildLeafletCluster=function(k,j){var i=new L.Marker(j,{icon:e.BuildLeafletClusterIcon(k)});i.on("dblclick",function(){var o=e.Cluster.FindMarkersInArea(k.bounds);var m=e.Cluster.ComputeBounds(o);if(m){var p=new L.LatLngBounds(new L.LatLng(m.minLat,m.maxLng),new L.LatLng(m.maxLat,m.minLng));var l=e._map.getZoom();var n=e._map.getBoundsZoom(p,false,new L.Point(20,20,null));if(n===l){e._map.fire("overlappingmarkers",{cluster:e,markers:o,center:i.getLatLng(),marker:i})}else{e._map.fitBounds(p)}}});i.on("click",function(){var l=[];var n=k.stats;for(var m in n){l.push({label:m.replace(/sensu lato/,"sl").replace(/chromosomal form/,"cf"),value:n[m],color:(palette[m]?palette[m]:"#000000")})}updatePieChart(k.population,l)});i.on("mouseover",function(l){});return i};var h=geohashLevel(f,"geohash");var d;if(g===0){d="(";for(var c=0;c<smallClusters.length;c++){if(c===smallClusters.length-1){d+=smallClusters[c];break}d+=smallClusters[c]+" "}d+=")"}else{d="*"}var b=function(i){var n=i.response.docs;for(var l in n){if(n.hasOwnProperty(l)){var m=n[l].geo_coords.split(",");var j=new PruneCluster.Marker(m[0],m[1]);if(n[l].hasOwnProperty("species_category")){var k=n[l].species_category[0];j.category=n[l].species_category[0]}else{console.log(l+": no species defined")}j.data.icon=L.VectorMarkers.icon({prefix:"fa",icon:"circle",markerColor:palette[k]?palette[k]:"red"});e.RegisterMarker(j)}}if(g){assetLayerGroup.clearLayers();$("#markersCount").html(i.response.numFound+" samples in current view")}assetLayerGroup.addLayer(e);map.spin(false)};var a=solrPopbioUrl+$("#view-mode").val()+"Markers?"+qryUrl+"&fq="+h+":"+d+buildBbox(map.getBounds())+"&json.wrf=?&callback=?";map.spin(true);$.getJSON(a,b)}function buildBbox(d){var e;if(d.getEast()){var c=d.getSouth();if(c<-90){c=-90}var f=d.getNorth();if(f>90){f=90}var a=d.getWest();if(a<-180){a=-180}if(a>180){a=180}var b=d.getEast();if(b>180){b=180}if(b<-180){b=-180}e="&fq=geo_coords:["+c+","+a+" TO "+f+","+b+"]"}else{e="&fq=geo_coords:[-90,-180 TO 90, 180]"}return(e)}function geohashLevel(b,a){var c;if(a==="geohash"){switch(b){case 1:case 2:c="geohash_1";break;case 3:case 4:case 5:c="geohash_2";break;case 6:case 7:c="geohash_3";break;case 8:case 9:c="geohash_4";break;case 10:case 11:c="geohash_5";break;default:c="geohash_6";break}}else{}return(c)}function buildPalette(k,j,b){var f=[];var e=["#FFB300","#803E75","#FF6800","#A6BDD7","#C10020","#CEA262","#817066","#007D34","#F6768E","#00538A","#FF7A5C","#53377A","#FF8E00","#B32851","#F4C800","#7F180D","#93AA00","#593315","#F13A13","#232C16"];var p=["#575757","#A0A0A0","#FFFFFF","#2A4BD7","#1D6914","#814A19","#8126C0","#9DAFFF","#81C57A","#E9DEBB","#AD2323","#29D0D0","#FFEE33","#FF9233","#FFCDF3"];var d=k.length,n=d;for(var h=0;h<j;h++){var o=k[h][0];f[o]=e[h];d--}var m=0.5/d,a=0.7;for(var l=0;l<d;l++){var g=n-d+l;var o=k[g][0];f[o]=colorLuminance("#FFFFFF",-a);a-=m}f.others="radial-gradient("+colorLuminance("#FFFFFF",-0.7)+", "+colorLuminance("#FFFFFF",-a)+")";return f}function sortHashByValue(c){var b=[];for(var a in c){b.push([a,c[a]])}b.sort(function(e,d){return d[1]-e[1]});return b}function updatePieChart(b,c){if(c){var a=500;var d=$("#graphs").width();nv.addGraph(function(){var e=nv.models.pieChart().x(function(f){return f.label}).y(function(f){return f.value}).color(function(f){return f.data.color}).showLabels(true).labelThreshold(0.05).labelType("percent").donut(true).donutRatio(0.5).growOnHover(false);d3.select("#piechart").datum(c).transition().duration(800).attr("width",d).attr("height",a).call(e);nv.utils.windowResize(function(){e.update()});return e})}else{}}$.fn.redraw=function(){$(this).each(function(){var a=this.offsetHeight})};function colorLuminance(e,a){e=String(e).replace(/[^0-9a-f]/gi,"");if(e.length<6){e=e[0]+e[0]+e[1]+e[1]+e[2]+e[2]}a=a||0;var b="#",f,d;for(d=0;d<3;d++){f=parseInt(e.substr(d*2,2),16);f=Math.round(Math.min(Math.max(0,f+(f*a)),255)).toString(16);b+=("00"+f).substr(f.length)}return b}function filterMarkers(j){if(j.length===0){qryUrl="q=*";loadSolr({clear:1,zoomLevel:map.getZoom()});return}var f={};j.forEach(function(i){if(!f.hasOwnProperty(i.type)){f[i.type]=[]}if(i.qtype=="exact"){f[i.type].push({field:i.field,value:'"'+i.value+'"'})}else{f[i.type].push({field:i.field,value:"*"+i.value+"*"})}});var g=0;qryUrl="q=(";var c=Object.keys(f).length;for(var e in f){var a={};var d=0;var h=f[e];h.sort(function(k,i){if(k.field<i.field){return -1}if(k.field>i.field){return 1}return 0}).forEach(function(k,i){a[k.field]?a[k.field]+=" OR "+k.value:a[k.field]=k.value});var b=Object.keys(a).length;if(g<c-1){if(d<b-1){if(e==="Anywhere"){qryUrl+="("+a.anywhere+") AND "}else{qryUrl+="(";for(var l in a){qryUrl+=l+":("+a[l]+")";if(d===b-1){qryUrl+=") AND ";continue}qryUrl+=" OR ";d++}}}else{if(e==="Anywhere"){qryUrl+="("+a.anywhere+") AND "}else{for(var l in a){qryUrl+=l+":("+a[l]+")";if(d===b-1){qryUrl+=" AND ";continue}qryUrl+=" OR ";d++}}}}else{if(d<b-1){if(e==="Anywhere"){}else{qryUrl+="(";for(var l in a){qryUrl+=l+":("+a[l]+")";if(d===b-1){qryUrl+="))";continue}qryUrl+=" OR ";d++}}}else{if(e==="Anywhere"){qryUrl+="("+a.anywhere+"))"}else{for(var l in a){qryUrl+=l+":("+a[l]+"))"}}}d++}g++}loadSolr({clear:1,zoomLevel:map.getZoom()})}function mapTypeToField(a){switch(a){case"Taxonomy":return"species_cvterms";case"Title":return"label";case"Sample type":return"sample_type";case"Geography":return"geolocations_cvterms";case"Collection protocols":return"collection_protocols_cvterms";case"Protocols":return"protocols_cvterms";case"Stable ID":return"id";case"Insecticides":return"insecticide_cvterms";default:return a.toLowerCase()}}function mapTypeToIcon(a){switch(a){case"Taxonomy":return'<i class="fa fa-sitemap"></i>';case"Title":return'<i class="fa fa-info-circle"></i>';default:return'<i class="fa fa-camera-retro"></i>'}}function generatePalette(p){var k=p.facet_counts.facet_pivot["geohash_2,species_category"];var h=[];for(var c in k){if(k.hasOwnProperty(c)){var f=k[c].count;var n=k[c].pivot;for(var i in n){if(n.hasOwnProperty(i)){var g=n[i].count/f;var o=n[i].value;var e=parseInt(i);var m;switch(e){case 1:m=7*g;break;case 2:m=3*g;break;case 3:m=1*g;break;default:m=0;break}if(h.hasOwnProperty(o)){h[o]+=m}else{h[o]=m}}}}}var j=sortHashByValue(h);palette=buildPalette(j,legendSpecies,1);var d="";var l=1;for(var b in palette){if(l>legendSpecies-1){d+='<i style="background:'+palette.others+'"></i> Others<br />';$("#legend").html(d);break}var a=b.replace(/^(\w{2})\S+\s(\w+)/,"$1. $2");d+='<i style="background:'+palette[b]+'" title="'+b+'"></i> '+(b?"<em>"+a+"</em><br>":"+");l++}legend.onAdd=function(q){legendDiv.innerHTML=d;return legendDiv};if(L.DomUtil.hasClass(legendDiv,"active")){legend.removeFrom(map);legend.addTo(map)}loadSolr({clear:1,zoomLevel:map.getZoom()})};