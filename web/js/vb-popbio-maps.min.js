function bindEvents(){if(urlParams.view==="ir"){$("#SelectViewDropdown").find(".dropdown-menu li a").parents(".dropdown").find(".btn").html("<i class='fa fa-eye' id='view-icon'></i> Insecticide Resistance <span class=\"caret\"></span>");$("#view-mode").val("ir")}else{$("#SelectViewDropdown").find(".dropdown-menu li a").parents(".dropdown").find(".btn").html("<i class='fa fa-eye' id='view-icon'></i> Samples <span class=\"caret\"></span>");$("#view-mode").val("smpl")}$("#grid-toggle").change(function(){if(!$(this).prop("checked")){map.removeLayer(geohashesGrid)}else{var a=geohashLevel(map.getZoom(),"geohash");addGeohashes(map,a.slice(-1))}});$("#daterange").on("hidden.bs.collapse",function(){$("#date-start").datepicker("clearDates");$("#date-end").datepicker("clearDates");$("#add-dates").prop("disabled",true);$("#add-season").prop("disabled",true)});$("#seasonal").on("hidden.bs.collapse",function(){if(checkSeasonal()){return}$(".season-toggle").each(function(){if($(this).prop("checked")){$(this).bootstrapToggle("off")}})});$("#date-select, #SelectViewDropdown").click(function(){if($("#seasonal").attr("aria-expanded")=="true"){$("#seasonal").collapse("hide")}});$("#season-select, #SelectViewDropdown").click(function(){if($("#daterange").attr("aria-expanded")=="true"){$("#daterange").collapse("hide")}});$("#daterange").find(".input-daterange").datepicker({format:"dd/mm/yyyy",startView:2,todayBtn:"linked",autoclose:true,todayHighlight:true,endDate:"Date.now()"});$(".season-toggle").change(function(){var a=false;$(".season-toggle").each(function(){var c=$(this).val(),b=$(this).prop("checked");months[c]=b;if(b){a=true}});if(a){$("#add-season").prop("disabled",false)}else{$("#add-season").prop("disabled",true)}});$("#add-season").click(function(){var a=constructSeasonal(months);if(checkSeasonal()){$("#search_ac").tagsinput("add",{value:a.rangesText.toString(),ranges:a.ranges,replace:true,type:"Seasonal",field:"collection_season"});$("#search_ac").tagsinput("remove",checkSeasonal())}else{$("#search_ac").tagsinput("add",{value:a.rangesText.toString(),ranges:a.ranges,replace:false,type:"Seasonal",field:"collection_season"})}});$("#date-start").datepicker().on("changeDate",function(a){$("#add-dates").prop("disabled",false)});$("#add-dates").click(function(){var c=new Date($("#date-start").datepicker("getUTCDate"));var a=new Date($("#date-end").datepicker("getUTCDate"));var b;if(c.getTime()===a.getTime()){b=c.toLocaleDateString("en-GB")}else{b=c.toLocaleDateString("en-GB")+"-"+a.toLocaleDateString("en-GB")}$("#search_ac").tagsinput("add",{value:b,dateStart:c,dateEnd:a,type:"Date",field:"collection_date_range"})});$(".date-shortcut").click(function(){console.log(this.value);setDateRange("#date-start","#date-end",this.value)});$("#search_ac").on("itemAdded",function(a){if(a.item.replace){return}removeHighlight();sidebar.close();setTimeout(function(){resetPlots()},delay);filterMarkers($("#search_ac").tagsinput("items"))});$("#search_ac").on("itemRemoved",function(){if(!checkSeasonal()){$(".season-toggle").each(function(){if($(this).prop("checked")){$(this).bootstrapToggle("off")}})}removeHighlight();sidebar.close();setTimeout(function(){resetPlots()},delay);filterMarkers($("#search_ac").tagsinput("items"))})}function initializeMap(){map=L.map("map",{center:[23.079,3.515],zoom:3,zoomControl:false,worldCopyJump:true});map.spin(true);map.addControl(new L.Control.FullScreen({position:"topright",forcePseudoFullscreen:true}));map.addControl(new L.Control.ZoomMin({position:"topright"}));sidebar=L.control.sidebar("sidebar").addTo(map);var c=new L.tileLayer("http://{s}.mqcdn.com/tiles/1.0.0/map/{z}/{x}/{y}.png",{minZoom:2,maxZoom:15,subdomains:["otile1","otile2","otile3","otile4"],noWrap:0,attribution:'&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery © <a href="http://mapbox.com">Mapbox</a>'});var b=new L.tileLayer("http://{s}.mqcdn.com/tiles/1.0.0/sat/{z}/{x}/{y}.png",{minZoom:2,maxZoom:15,maxNativeZoom:11,subdomains:["otile1","otile2","otile3","otile4"],noWrap:0,attribution:"Portions Courtesy NASA/JPL-Caltech and U.S. Depart. of Agriculture, Farm Service Agency"});var a=new L.tileLayer("http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{minZoom:2,maxZoom:15,noWrap:0,attribution:'&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery © <a href="http://mapbox.com">Mapbox</a>'});map.addLayer(c);assetLayerGroup=new L.LayerGroup();assetLayerGroup.addTo(map);var e=new L.Control.Layers({"MapQuest-OSM":c,OpenStreetMap:a,"MapQuest Open Aerial":b});e.setPosition("topright");e.addTo(map);var d=solrPopbioUrl+$("#view-mode").val()+"Palette?q=*&facet.pivot=geohash_2,species_category&json.wrf=?&callback=?";legend=new L.control.legend(d);if(rectHighlight!==null){map.removeLayer(rectHighlight)}rectHighlight=null;map.spin(false)}function initializeSearch(){$("#reset-search").click(function(){$("#search_ac").tagsinput("removeAll");$(".season-toggle").each(function(){if($(this).prop("checked")){$(this).bootstrapToggle("off")}});removeHighlight();sidebar.close();setTimeout(function(){resetPlots()},delay);filterMarkers("")});var a=new Bloodhound({datumTokenizer:Bloodhound.tokenizers.whitespace,queryTokenizer:Bloodhound.tokenizers.whitespace,limit:7,minLength:2,hint:false,remote:{url:solrTaUrl+$("#view-mode").val()+"Ac?q=",ajax:{dataType:"jsonp",data:{wt:"json",rows:7},jsonp:"json.wrf"},replace:function(d,e){d=solrTaUrl+$("#view-mode").val()+"Ac?q=";var c=e.match(/([^@]+)@([^@]*)/);if(c!=null){partSearch=c[1];if($("#world-toggle").prop("checked")){return solrTaUrl+$("#view-mode").val()+"Acat?q="+encodeURI(c[1])+buildBbox(map.getBounds())}else{return solrTaUrl+$("#view-mode").val()+"Acat?q="+encodeURI(c[1])}}else{partSearch=false;if($("#world-toggle").prop("checked")){return d+encodeURI(e)+buildBbox(map.getBounds())}else{return d+encodeURI(e)}}},filter:function(c){if(partSearch){return $.map(c.grouped.type.doclist.docs,function(d){return{value:partSearch,id:d.id,type:d.type,field:d.field,is_synonym:d.is_synonym,qtype:"partial"}})}else{return $.map(c.grouped.textsuggest_category.doclist.docs,function(d){return{value:d.textsuggest_category,type:d.type,id:d.id,field:d.field,is_synonym:d.is_synonym,qtype:"exact"}})}}}});a.initialize();var b=new Bloodhound({datumTokenizer:Bloodhound.tokenizers.whitespace,queryTokenizer:Bloodhound.tokenizers.whitespace,limit:10,minLength:3,remote:{url:solrTaUrl+$("#view-mode").val()+"Acgrouped?q=",ajax:{dataType:"jsonp",data:{wt:"json",rows:10},jsonp:"json.wrf"},replace:function(c,d){c=solrTaUrl+$("#view-mode").val()+"Acgrouped?q=";if($("#world-toggle").prop("checked")){return c+encodeURI(d)+"*"}else{return c+encodeURI(d)+"*"+buildBbox(map.getBounds())}},filter:function(d){var c=d.grouped.stable_id.ngroups;return $.map(d.facet_counts.facet_fields.type,function(e){if(e[1]>0){return{count:e[1],type:e[0],field:mapTypeToField(e[0]),value:$("#search_ac").tagsinput("input")[0].value,qtype:"summary"}}})}}});b.initialize();$("#search_ac").tagsinput({tagClass:function(c){switch(c.type){case"Taxonomy":return"label label-primary fa fa-sitemap";case"Geography":return"label label-primary fa fa-map-marker";case"Title":return"label label-success fa fa-tag";case"Description":return"label label-success fa fa-info-circle";case"Projects":return"label label-success fa fa-database";case"Anywhere":return"label label-default fa fa-search";case"Pubmed references":return"label label-success fa fa-book";case"Insecticides":return"label label-success fa fa-eyedropper";case"Collection protocols":return"label label-success fa fa-shopping-cart";case"Date":return"label label-info fa fa-calendar";case"Seasonal":return"label label-info fa fa-calendar-check-o";default:return"label label-warning fa fa-search"}},itemValue:"value",itemText:function(c){return" "+c.value},typeaheadjs:({options:{minLength:3,hint:false,highlight:false},datasets:[{name:"acSuggestions",displayKey:"value",source:a.ttAdapter(),templates:{empty:function(){var c;if($("#world-toggle").prop("checked")){c="No suggestions found. Try enabling world search or hit enter to perform a free text search instead."}else{c="No suggestions found. Hit Enter to perform a free text search instead."}return['<span class="tt-suggestions" style="display: block;">','<div class="tt-suggestion">','<p style="white-space: normal;">',c,"</p>","</div>","</span>"].join("\n")},suggestion:function(c){return"<p>"+c.value+(c.is_synonym?' (<i class="fa fa-list-ul" title="Duplicate term / Synonym" style="cursor: pointer"></i>)':"")+" <em> in "+c.type+"</em></p>"}}},{name:"acOtherResults",displayKey:"value",source:b.ttAdapter(),templates:{header:'<h4 class="more-results">More suggestions</h4>',suggestion:function(c){return"<p>~"+c.count+" <em>in "+c.type+"</em></p>"}}}]})});$(".dropdown-menu li a").click(function(){$(this).parents(".dropdown").find(".btn").html($(this).data("value")+' <span class="caret"></span>');$(this).parents(".dropdown").find(".btn").val($(this).data("value"));var d=$(this).text();if(d==="Samples"){$("#view-mode").val("smpl")}else{$("#view-mode").val("ir")}var c=solrPopbioUrl+$("#view-mode").val()+"Palette?q=*&facet.pivot=geohash_2,species_category&json.wrf=?&callback=?";removeHighlight();sidebar.close();setTimeout(function(){resetPlots()},delay);$.getJSON(c,function(e){legend.populateLegend(e,"species_category")});a.initialize(true);b.initialize(true)});$("#SelectViewDropdown").find(".dropdown-menu li a").click(function(){var d=$(this).text();if(d==="Samples"){$("#view-mode").val("smpl")}else{$("#view-mode").val("ir")}var c=solrPopbioUrl+$("#view-mode").val()+"Palette?q=*&facet.pivot=geohash_2,species_category&json.wrf=?&callback=?";removeHighlight();sidebar.close();setTimeout(function(){resetPlots()},delay);$.getJSON(c,function(e){legend.populateLegend(e,"species_category")});a.initialize(true);b.initialize(true)})}function loadSolr(e){var a=e.clear;var f=e.zoomLevel;var g=geohashLevel(f,"geohash");if(urlParams.grid==="true"||$("#grid-toggle").prop("checked")){addGeohashes(map,g.slice(-1))}if(f>11){loadSmall(1,f);return}var d=[];var c=function(x){$("#markersCount").html(x.response.numFound+" samples in current view");if(x.response.numFound===0){if(a){assetLayerGroup.clearLayers()}if(rectHighlight!==null){map.removeLayer(rectHighlight)}rectHighlight=null;map.spin(false);return}var t,w,v,h;var p=x.stats.stats_fields;var q=x.facet_counts;var j=$("#view-mode").val();switch(f){case 1:case 2:t=p.geo_coords_ll_0_coordinate.facets.geohash_1;w=p.geo_coords_ll_1_coordinate.facets.geohash_1;h=(j==="ir")?p.phenotype_rescaled_value_f.facets.geohash_1:null;v=q.facet_pivot["geohash_1,species_category"];break;case 3:case 4:case 5:t=p.geo_coords_ll_0_coordinate.facets.geohash_2;w=p.geo_coords_ll_1_coordinate.facets.geohash_2;h=((j==="ir")?p.phenotype_rescaled_value_f.facets.geohash_2:null);v=q.facet_pivot["geohash_2,species_category"];break;case 6:case 7:t=p.geo_coords_ll_0_coordinate.facets.geohash_3;w=p.geo_coords_ll_1_coordinate.facets.geohash_3;h=((j==="ir")?p.phenotype_rescaled_value_f.facets.geohash_3:null);v=q.facet_pivot["geohash_3,species_category"];break;case 8:case 9:t=p.geo_coords_ll_0_coordinate.facets.geohash_4;w=p.geo_coords_ll_1_coordinate.facets.geohash_4;h=(j==="ir")?p.phenotype_rescaled_value_f.facets.geohash_4:null;v=q.facet_pivot["geohash_4,species_category"];break;case 10:case 11:t=p.geo_coords_ll_0_coordinate.facets.geohash_5;w=p.geo_coords_ll_1_coordinate.facets.geohash_5;h=(j==="ir")?p.phenotype_rescaled_value_f.facets.geohash_5:null;v=q.facet_pivot["geohash_5,species_category"];break;default:t=p.geo_coords_ll_0_coordinate.facets.geohash_6;w=p.geo_coords_ll_1_coordinate.facets.geohash_6;h=(j==="ir")?p.phenotype_rescaled_value_f.facets.geohash_6:null;v=q.facet_pivot["geohash_6,species_category"];break}smallClusters=[];var k=[];var i=[];var s=[];for(var r in t){if(t.hasOwnProperty(r)){var n=t[r].count;if(n<2){smallClusters.push(r);continue}v.forEach(function(A,B){k[A.value]=A.count;var z=[];var y=[];if(A.pivot){A.pivot.forEach(function(D){var C=D.value,E=D.count;z[C]=E;y.push({label:C.replace(/sensu lato/,"sl").replace(/chromosomal form/,"cf"),value:E,color:(palette[C]?palette[C]:"#000000")})})}else{console.log("ERROR: Pivot for element "+A.value+"appears to be empty")}i[A.value]=z;s[A.value]=y});var l={};l.term=r;l.count=t[r].count;l.latLng=[t[r].mean,w[r].mean];l.bounds=[[t[r].min,w[r].min],[t[r].max,w[r].max]];l.population=k[r];l.trafficlight=(j==="ir")?h[r].mean:-1;l.stats=i[r];l.fullstats=s[r];d.push(l)}}var o={};o.terms=d;var u={recordsField:"terms",latitudeField:"latLng.0",longitudeField:"latLng.1",displayOptions:{count:{title:function(y){return y}}},layerOptions:{fill:false,stroke:false,weight:0,color:"#80FF00",dropShadow:false},setIcon:function(y){var z=40;return new L.Icon.Canvas({iconSize:new L.Point(z,z),className:"marker-cluster",population:y.population,trafficlight:y.trafficlight,stats:y.stats})},onEachRecord:function(z,y){z.on("dblclick",function(){clearTimeout(timer);prevent=true;map.fitBounds(y.bounds)});z.on("click",function(){var A=false;if(z===highlight){A=true}removeHighlight(z);highlightMarker(z);timer=setTimeout(function(){if(!prevent){if(A){removeHighlight();sidebar.close();setTimeout(function(){resetPlots()},delay);return}if($("#sidebar").hasClass("collapsed")){if($(".sidebar-pane.active").attr("id")==="help"){sidebar.open("graphs")}else{sidebar.open($(".sidebar-pane.active").attr("id"))}}updatePieChart(y.population,y.fullstats);var B=L.latLngBounds(y.bounds);createBeeViolinPlot("#swarm-chart-area",buildBbox(B));updateTable("#table-contents",buildBbox(B))}},delay);prevent=false});z.on("mouseover",function(){moveTopMarker(z);var A=L.latLngBounds(y.bounds);if(rectHighlight!==null){map.removeLayer(rectHighlight)}rectHighlight=L.rectangle(A,{color:"grey",weight:1,fill:true,clickable:false}).addTo(map)});z.on("mouseout",function(){removeTopMarker(z);if(rectHighlight!==null){map.removeLayer(rectHighlight)}rectHighlight=null})}};var m=new L.MarkerDataLayer(o,u);if(a){assetLayerGroup.clearLayers();assetLayerGroup.addLayer(m)}else{assetLayerGroup.addLayer(m)}if(smallClusters.length>0){loadSmall(0,f)}if(rectHighlight!==null){map.removeLayer(rectHighlight)}rectHighlight=null;map.spin(false)};var b=solrPopbioUrl+$("#view-mode").val()+"Geoclust?"+qryUrl+buildBbox(map.getBounds())+"&stats.facet="+g+"&facet.pivot="+g+",species_category&json.wrf=?&callback=?";map.spin(true);$.getJSON(b,c).fail(function(){console.log("Ahhh");map.spin(false)})}function checkSeasonal(){var a=$("#search_ac").tagsinput("items");for(var b=0;b<a.length;b++){var c=a[b];if(c.type==="Seasonal"){return c.value}}return false}function loadSmall(g,f){var e=new PruneClusterForLeaflet(120);e.BuildLeafletClusterIcon=function(i){var j=new L.Icon.MarkerCluster();j.stats=i.stats;j.population=i.population;j.trafficlight=i.totalWeight/i.population;return j};e.PrepareLeafletMarker=function(i,l,k){i.on("dblclick",function(){clearTimeout(timer);prevent=true;if(map.getZoom()<11){map.setView(i._latlng,11,{animate:true})}else{removeHighlight();sidebar.close();setTimeout(function(){resetPlots()},delay)}});i.on("click",function(){var m=false;if(i===highlight){m=true}removeHighlight(i);highlightMarker(i);timer=setTimeout(function(){if(m){removeHighlight();sidebar.close();setTimeout(function(){resetPlots()},delay);return}if(!prevent){var n=[];n.push({label:k.replace(/sensu lato/,"sl").replace(/chromosomal form/,"cf"),value:1,color:(palette[k]?palette[k]:"#000000")});if($("#sidebar").hasClass("collapsed")){if($(".sidebar-pane.active").attr("id")==="help"){sidebar.open("graphs")}else{sidebar.open($(".sidebar-pane.active").attr("id"))}}updatePieChart(1,n);var o="&fq=id:"+l.id;createBeeViolinPlot("#swarm-chart-area",o);updateTable("#table-contents",o)}prevent=false},delay)});if(l.icon){if(typeof l.icon==="function"){i.setIcon(l.icon(l,k))}else{i.setIcon(l.icon)}}if(l.popup){var j=typeof l.popup==="function"?l.popup(l,k):l.popup;if(i.getPopup()){i.setPopupContent(j,l.popupOptions)}else{i.bindPopup(j,l.popupOptions)}}};L.Icon.MarkerCluster=L.Icon.extend({options:{iconSize:new L.Point(40,40),className:"prunecluster leaflet-markercluster-icon"},createIcon:function(){var j=document.createElement("canvas");this._setIconStyles(j,"icon");var i=this.options.iconSize;j.width=i.x;j.height=i.y;this.draw(j.getContext("2d"),i.x,i.y);return j},createShadow:function(){return null},draw:function(k){var n=Math.PI*2;var j=Math.PI*1.5;var o=this.options.iconSize.x,m=o/2,l=o/2.5;for(var r in this.stats){if(this.stats.hasOwnProperty(r)){var s=this.stats[r]/this.population;if(s>0){k.beginPath();k.moveTo(m,m);if(palette.hasOwnProperty(r)){k.fillStyle=palette[r]}else{k.fillStyle=palette.others}var q=j,p=j+s*n;if(p<q){q=j}k.arc(m,m,m,q,p);j=j+s*n;k.lineTo(m,m);k.fill();k.closePath()}}}k.beginPath();k.fillStyle="white";k.arc(m,m,l,0,Math.PI*2);k.fill();k.closePath();var i=markerColor(this.trafficlight);if($("#view-mode").val()==="ir"){k.beginPath();k.fillStyle=i[0];k.arc(m,m,m-7,0,Math.PI*2);k.fill();k.closePath()}k.fillStyle=($("#view-mode").val()==="ir")?i[1]:"#555";k.textAlign="center";k.textBaseline="middle";k.font="bold 12px sans-serif";k.fillText(this.population,m,m,o)}});e.BuildLeafletCluster=function(k,j){var i=new L.Marker(j,{icon:e.BuildLeafletClusterIcon(k)});i.on("dblclick",function(){clearTimeout(timer);prevent=true;var o=e.Cluster.FindMarkersInArea(k.bounds);var m=e.Cluster.ComputeBounds(o);if(m){var p=new L.LatLngBounds(new L.LatLng(m.minLat,m.maxLng),new L.LatLng(m.maxLat,m.minLng));var l=e._map.getZoom();var n=e._map.getBoundsZoom(p,false,new L.Point(20,20,null));if(n===l){removeHighlight();sidebar.close();setTimeout(function(){resetPlots()},delay);e._map.fire("overlappingmarkers",{cluster:e,markers:o,center:i.getLatLng(),marker:i})}else{e._map.fitBounds(p)}}});i.on("click",function(){var l=false;if(i===highlight){l=true}removeHighlight(i);highlightMarker(i);timer=setTimeout(function(){if(!prevent){if(l){removeHighlight();sidebar.close();setTimeout(function(){resetPlots()},delay);return}var n=[];var q=k.stats;for(var p in q){n.push({label:p.replace(/sensu lato/,"sl").replace(/chromosomal form/,"cf"),value:q[p],color:(palette[p]?palette[p]:"#000000")})}if($("#sidebar").hasClass("collapsed")){if($(".sidebar-pane.active").attr("id")==="help"){sidebar.open("graphs")}else{sidebar.open($(".sidebar-pane.active").attr("id"))}}updatePieChart(k.population,n);var o=e.Cluster.FindMarkersInArea(k.bounds);var m=e.Cluster.ComputeBounds(o);if(m){var r=new L.LatLngBounds(new L.LatLng(m.minLat,m.maxLng),new L.LatLng(m.maxLat,m.minLng))}createBeeViolinPlot("#swarm-chart-area",buildBbox(r));updateTable("#table-contents",buildBbox(r))}},delay);prevent=false});i.on("mouseover",function(){moveTopMarker(i);var n=e.Cluster.FindMarkersInArea(k.bounds);var l=e.Cluster.ComputeBounds(n);if(l){var m=new L.LatLngBounds(new L.LatLng(l.minLat,l.maxLng),new L.LatLng(l.maxLat,l.minLng))}if(rectHighlight!==null){map.removeLayer(rectHighlight)}rectHighlight=L.rectangle(m,{color:"grey",weight:1,fill:true,clickable:false}).addTo(map)});i.on("mouseout",function(){removeTopMarker(i);if(rectHighlight!==null){map.removeLayer(rectHighlight)}rectHighlight=null});return i};var h=geohashLevel(f,"geohash");var d;if(g===0){d="(";for(var c=0;c<smallClusters.length;c++){if(c===smallClusters.length-1){d+=smallClusters[c];break}d+=smallClusters[c]+" "}d+=")"}else{d="*"}var b=function(i){var o=i.response.docs;for(var l in o){if(o.hasOwnProperty(l)){var n=o[l].geo_coords.split(",");var m=($("#view-mode").val()==="ir")?o[l].phenotype_rescaled_value_f:-1;var j=new PruneCluster.Marker(n[0],n[1]);j.data.id=o[l].id;if(o[l].hasOwnProperty("species_category")){var k=o[l].species_category[0];j.category=o[l].species_category[0];j.weight=m;j.data.trafficlight=m}else{console.log(l+": no species defined")}j.data.icon=L.VectorMarkers.icon({prefix:"fa",icon:"circle",markerColor:palette[k]?palette[k]:"red",iconColor:markerColor(m)[0],extraClasses:"single-marker-icon"});e.RegisterMarker(j)}}if(g){assetLayerGroup.clearLayers();$("#markersCount").html(i.response.numFound+" samples in current view")}assetLayerGroup.addLayer(e);if(rectHighlight!==null){map.removeLayer(rectHighlight)}rectHighlight=null;map.spin(false)};var a=solrPopbioUrl+$("#view-mode").val()+"Markers?"+qryUrl+"&fq="+h+":"+d+buildBbox(map.getBounds())+"&json.wrf=?&callback=?";map.spin(true);$.getJSON(a,b)}function buildBbox(d){var e;if(d.getEast()){var c=d.getSouth();if(c<-90){c=-90}var f=d.getNorth();if(f>90){f=90}var a=d.getWest();if(a<-180){a=-180}if(a>180){a=180}var b=d.getEast();if(b>180){b=180}if(b<-180){b=-180}e="&fq=geo_coords:["+c+","+a+" TO "+f+","+b+"]"}else{e="&fq=geo_coords:[-90,-180 TO 90, 180]"}return(e)}function geohashLevel(b,a){var c;if(a==="geohash"){switch(b){case 1:case 2:c="geohash_1";break;case 3:case 4:case 5:c="geohash_2";break;case 6:case 7:c="geohash_3";break;case 8:case 9:c="geohash_4";break;case 10:case 11:c="geohash_5";break;default:c="geohash_6";break}}else{}return(c)}function updatePieChart(a,b){if(b){$("#pie-chart-header").empty();d3.select("#pie-chart-area svg").attr("width","380px").attr("height","500px").style({width:"380px",height:"500px"});nv.addGraph(function(){var c=nv.models.pieChart().x(function(e){return e.label}).y(function(e){return e.value}).color(function(e){return e.data.color}).showLabels(true).labelThreshold(0.05).labelType("percent").donut(true).donutRatio(0.5).growOnHover(false);d3.select("#pie-chart-area svg").datum(b).transition().duration(800).call(c);nv.utils.windowResize(c.update);return c})}else{}}$.fn.redraw=function(){$(this).each(function(){var a=this.offsetHeight})};function updateTable(e,b,i){var d=e+"-header";$(d).empty();if($("#view-mode").val()==="smpl"){var a=solrPopbioUrl+"smplTable?&"+qryUrl+b+"&sort=id asc&json.wrf=?&callback=?"}else{var a=solrPopbioUrl+"irTable?&"+qryUrl+b+"&sort=id asc&json.wrf=?&callback=?"}var f=a+"&cursorMark=*",c="*",g;PaneSpin("marker-table","start");var h=this;$(e).empty();$("#marker-table").infiniteScrollHelper("destroy");$.getJSON(f).done(function(k){if(k.response.numFound&&k.response.numFound>0){var l=k.response.docs;g=k.nextCursorMark;f=a+"&cursorMark="+g;tableHtml(e,l)}PaneSpin("marker-table","stop");var j;$("#marker-table").infiniteScrollHelper({bottomBuffer:80,loadMore:function(n,m){PaneSpin("marker-table","start");$.getJSON(f).done(function(o){if(o.response.numFound&&o.response.numFound>0){var p=o.response.docs;c=g;g=o.nextCursorMark;f=a+"&cursorMark="+g;tableHtml(e,p)}PaneSpin("marker-table","stop");m()}).fail(function(){PaneSpin("marker-table","stop");console.log("Failed while loading smplTable");m()})}})}).fail(function(){PaneSpin("marker-table","stop");console.log("Failed while loading smplTable")})}function tableHtml(b,a){a.forEach(function(g){var c=g.collection_date_range;var e;if(c&&c.length>0){var j=c[0];if(/TO/.test(j)){var m=/\[(\S+)\sTO\s(\S+)\]/;var h=m.exec(j);var l=h[1],i=h[2];e=dateResolution(l)+" to "+dateResolution(i)}else{var d=new Date(j);e=d.toDateString()}}var n=g.species_category?g.species_category[0]:"Unknown";if($("#view-mode").val()==="smpl"){var o={accession:g.accession,bundleName:g.bundle_name,url:g.url,sampleType:g.sample_type,geoCoords:g.geo_coords,geolocation:g.geolocations[0],species:n,bgColor:palette[n],textColor:getContrastYIQ(palette[n]),collectionDate:e,projects:g.projects,collectionProtocols:g.collection_protocols};var k=$.templates("#smplRowTemplate")}else{var o={accession:g.accession,bundleName:g.bundle_name,url:g.url,sampleType:g.sample_type,geoCoords:g.geo_coords,geolocation:g.geolocations[0],species:n,bgColor:palette[n],textColor:getContrastYIQ(palette[n]),collectionDate:e,projects:g.projects,collectionProtocols:g.collection_protocols,protocols:g.protocols,phenotypeValue:g.phenotype_value_f,phenotypeValueType:g.phenotype_value_type_s,phenotypeValueUnit:g.phenotype_value_unit_s,insecticide:g.insecticide_s,sampleSize:g.sample_size_i,concentration:g.concentration_f,concentrationUnit:g.concentration_unit_s,duration:g.duration_f,durationUnit:g.duration_unit_s};var k=$.templates("#irRowTemplate")}var f=k.render(o);$(b).append(f)})}function colorLuminance(e,a){e=String(e).replace(/[^0-9a-f]/gi,"");if(e.length<6){e=e[0]+e[0]+e[1]+e[1]+e[2]+e[2]}a=a||0;var b="#",f,d;for(d=0;d<3;d++){f=parseInt(e.substr(d*2,2),16);f=Math.round(Math.min(Math.max(0,f+(f*a)),255)).toString(16);b+=("00"+f).substr(f.length)}return b}function filterMarkers(j){if(j.length===0){qryUrl="q=*";loadSolr({clear:1,zoomLevel:map.getZoom()});return}var f={};j.forEach(function(m){if(!f.hasOwnProperty(m.type)){f[m.type]=[]}if(m.type==="Date"){var p="YYYY-MM-DD";var n=dateConvert(m.dateEnd,p);var o=dateConvert(m.dateStart,p);f[m.type].push({field:m.field,value:"["+o+" TO "+n+"]"});return}if(m.type==="Seasonal"){for(var k=0;k<m.ranges.length;k++){var i=m.ranges[k];f[m.type].push({field:m.field,value:"["+i+"]"})}return}if(m.qtype=="exact"){f[m.type].push({field:m.field,value:'"'+m.value+'"'})}else{f[m.type].push({field:m.field,value:"*"+m.value+"*"})}});var g=0;qryUrl="q=(";var c=Object.keys(f).length;for(var e in f){var a={};var d=0;var h=f[e];h.sort(function(k,i){if(k.field<i.field){return -1}if(k.field>i.field){return 1}return 0}).forEach(function(k,i){a[k.field]?a[k.field]+=" OR "+k.value:a[k.field]=k.value});var b=Object.keys(a).length;if(g<c-1){if(d<b-1){if(e==="Anywhere"){qryUrl+="("+a.anywhere+") AND "}else{qryUrl+="(";for(var l in a){qryUrl+=l+":("+a[l]+")";if(d===b-1){qryUrl+=") AND ";continue}qryUrl+=" OR ";d++}}}else{if(e==="Anywhere"){qryUrl+="("+a.anywhere+") AND "}else{for(var l in a){qryUrl+=l+":("+a[l]+")";if(d===b-1){qryUrl+=" AND ";continue}qryUrl+=" OR ";d++}}}}else{if(d<b-1){if(e==="Anywhere"){}else{qryUrl+="(";for(var l in a){qryUrl+=l+":("+a[l]+")";if(d===b-1){qryUrl+="))";continue}qryUrl+=" OR ";d++}}}else{if(e==="Anywhere"){qryUrl+="("+a.anywhere+"))"}else{for(var l in a){qryUrl+=l+":("+a[l]+"))"}}}d++}g++}qryUrl=encodeURI(qryUrl);loadSolr({clear:1,zoomLevel:map.getZoom()})}function mapTypeToField(a){switch(a){case"Taxonomy":return"species_cvterms";case"Title":return"label";case"Sample type":return"sample_type";case"Geography":return"geolocations_cvterms";case"Collection protocols":return"collection_protocols_cvterms";case"Protocols":return"protocols_cvterms";case"Stable ID":return"id";case"Insecticides":return"insecticide_cvterms";case"Collection date":return"collection_date_range";default:return a.toLowerCase()}}function mapTypeToIcon(a){switch(a){case"Taxonomy":return'<i class="fa fa-sitemap"></i>';case"Title":return'<i class="fa fa-info-circle"></i>';default:return'<i class="fa fa-camera-retro"></i>'}}function PaneSpin(c,b){var a=document.getElementById(c);if(b==="start"){if(PaneSpinner==null){PaneSpinner=new Spinner().spin(a)}else{PaneSpinner.spin(a)}}else{PaneSpinner.stop(a)}}function highlightMarker(a){$(a._icon).addClass("highlight-marker");highlight=a;if(firstClick){firstClick=false}}function moveTopMarker(a){$(a._icon).addClass("top-marker")}function removeTopMarker(a){$(a._icon).removeClass("top-marker")}function removeHighlight(a){if(highlight!==null){$(highlight._icon).removeClass("highlight-marker");a?highlight=a:highlight=null}}function resetPlots(){var b,c,a;if(firstClick){b='<h3>Summary view for selected samples</h3><div id="pie-chart-header" style="text-align: center; margin-top: 30px"><i class="fa fa-pie-chart" style="color: #2c699e; font-size: 12em"></i><h1>Go on!</h1><h4>click a marker on the map</h4><h4>to plot some real data</h4> </div><div id="pie-chart-area"><svg></svg></div>';c='<div style="text-align: center; margin-top: 30px"><i class="fa fa-area-chart" style="color: #2c699e; font-size: 12em"></i><h1>Go on!</h1><h4>click a marker on the map</h4><h4>to plot some real data</h4> </div>';a='<div style="text-align: center; margin-top: 30px"><i class="fa fa-table" style="color: #2c699e; font-size: 12em"></i><h1>Go on!</h1><h4>click a marker on the map</h4><h4>to see some real data</h4> </div>'}else{b='<h3>Summary view for selected samples</h3><div id="pie-chart-header" style="text-align: center; margin-top: 30px"><i class="fa fa-pie-chart" style="color: #2c699e; font-size: 12em"></i><h4>click a marker on the map</h4></div><div id="pie-chart-area"><svg></svg></div>';c='<div style="text-align: center; margin-top: 30px"><i class="fa fa-area-chart" style="color: #2c699e; font-size: 12em"></i><h4>click a marker on the map</h4></div>';a='<div style="text-align: center; margin-top: 30px"><i class="fa fa-table" style="color: #2c699e; font-size: 12em"></i><h4>click a marker on the map</h4></div>'}$("#graphs").html(b);$("#swarm-chart-area").html(c);$("#marker-table").off("scroll");$("#table-contents-header").html(a);$("#table-contents").empty()}function markerColor(b){var c,a;if(b<0){return["white","#555"]}else{c=trafficLight.evaluate(b);if(b<0.3){a="#fff"}else{if(b>0.7){a="#fff"}else{a="#555"}}return[c,a]}}function getContrastYIQ(f){var d=parseInt(f.substr(0,2),16);var c=parseInt(f.substr(2,2),16);var a=parseInt(f.substr(4,2),16);var e=((d*299)+(c*587)+(a*114))/1000;return(e>=128)?"black":"white"}String.prototype.capitalizeFirstLetter=function(){return this.charAt(0).toUpperCase()+this.slice(1)};Number.prototype.roundDecimals=function(a){if(Math.floor(this.valueOf())===this.valueOf()){return this.valueOf()}var b=this.toString().split(".")[1].length;if(b<a){return this.valueOf()}else{return this.valueOf().toFixed(a)}};function constructSeasonal(m){var k="YYYY-MM",j="MMM";var a=[],c=[];var e,h,l=false;var b=new Date(1600,0,1),f=new Date(1600,0,1);for(var d=1;d<13;d++){var g=m[d];if(g){if(!l){b.setMonth(d-1);f.setMonth(d-1);l=true}else{f.setMonth(d-1)}if(d===12){e=dateConvert(b,k)+" TO "+dateConvert(f,k);a.push(e);if(b.getTime()===f.getTime()){h=dateConvert(b,j)}else{h=dateConvert(b,j)+"-"+dateConvert(f,j)}c.push(h);l=false}}else{if(l){e=dateConvert(b,k)+" TO "+dateConvert(f,k);a.push(e);if(b.getTime()===f.getTime()){h=dateConvert(b,j)}else{h=dateConvert(b,j)+"-"+dateConvert(f,j)}c.push(h);l=false}}}return{ranges:a,rangesText:c}}function dateResolution(f){var a=/^([\+-]?\d{4}(?!\d{2}\b))((-?)((0[1-9]|1[0-2])(\3([12]\d|0[1-9]|3[01]))?|W([0-4]\d|5[0-2])(-?[1-7])?|(00[1-9]|0[1-9]\d|[12]\d{2}|3([0-5]\d|6[1-6])))([T\s]((([01]\d|2[0-3])((:?)[0-5]\d)?|24\:?00)([\.,]\d+(?!:))?)?(\17[0-5]\d([\.,]\d+)?)?([zZ]|([\+-])([01]\d|2[0-3]):?([0-5]\d)?)?)?)?$/g;var d=a.exec(f);var e=d[1],h=d[5],b=d[7];if(typeof b!=="undefined"){var c=new Date(f);return c.toDateString()}if(typeof h!=="undefined"){var g="MMM YYYY",c=new Date(f);return dateConvert(c,g)}if(typeof e!=="undefined"){return f}return false;console.log(d[1]+"-"+d[5]+"-"+d[7])}function setDateRange(b,c,f){var e=new Date();var d=new Date(Date.UTC(e.getUTCFullYear(),e.getUTCMonth(),e.getUTCDate()));e.setUTCFullYear(e.getUTCFullYear()-f);var a=new Date(Date.UTC(e.getUTCFullYear(),0,1));$(b).datepicker("setUTCDate",a);$(c).datepicker("setUTCDate",d)}function dateConvert(l,k){var g=l.getFullYear();var f=("0"+(l.getMonth()+1)).slice(-2);var c=("0"+l.getDate()).slice(-2);var i=("0"+l.getHours()).slice(-2);var d=("0"+l.getMinutes()).slice(-2);var j=("0"+l.getSeconds()).slice(-2);var h=l.getDay();var b=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];var a=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];var e="";switch(k){case"YYYY-MM-DD":e=g+"-"+f+"-"+c;break;case"YYYY-MM":e=g+"-"+f;break;case"MMM YYYY":e=b[parseInt(f)-1]+" "+g;break;case"YYYY-MMM-DD DDD":e=g+"-"+b[parseInt(f)-1]+"-"+c+" "+a[parseInt(h)];break;case"MMM":e=b[parseInt(f)-1];break}return e}(function(b){var a=/([^&=]+)=?([^&]*)/g;var c=function(d){return decodeURIComponent(d.replace(/\+/g," "))};b.parseParams=function(h){function f(o,k,n){k=k+"";if(k.indexOf(".")!==-1){var m=k.split(".");var l=k.split(/\.(.+)?/)[1];if(!o[m[0]]){o[m[0]]={}}if(l!==""){f(o[m[0]],l,n)}else{console.warn('parseParams :: empty property in key "'+k+'"')}}else{if(k.indexOf("[")!==-1){var m=k.split("[");k=m[0];var m=m[1].split("]");var e=m[0];if(e==""){if(!o){o={}}if(!o[k]||!b.isArray(o[k])){o[k]=[]}o[k].push(n)}else{if(!o){o={}}if(!o[k]||!b.isArray(o[k])){o[k]=[]}o[k][parseInt(e)]=n}}else{if(!o){o={}}o[k]=n}}}if(!h){h=window.location+""}else{h=h+""}var j={},i;if(h){if(h.indexOf("#")!==-1){h=h.substr(0,h.indexOf("#"))}if(h.indexOf("?")!==-1){h=h.substr(h.indexOf("?")+1,h.length)}else{return{}}if(h==""){return{}}while(i=a.exec(h)){var d=c(i[1]);var g=c(i[2]);f(j,d,g)}}return j}})(jQuery);(function(a){a.encodeURL=function(e){function b(j,l){if(j===null){return""}if(a.isArray(j)){var k=0,h="";for(var i=0;i<j.length;i++){if(k>0){h+="&"}h+=l+"[]="+j[i];k++}return h}else{if(typeof j==="object"){var k=0,h="";for(var g in j){if(j.hasOwnProperty(g)){if(k>0){h+="&"}h+=b(j[g],l+"."+g);k++}}return h}else{return l+"="+j}}}var d="?",f=0;for(var c in e){if(e.hasOwnProperty(c)){if(f>0){d+="&"}d+=b(e[c],c);f++}}return d}})(jQuery);